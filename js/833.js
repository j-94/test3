(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[833],{1089:(e,t,i)=>{"use strict";e.exports=i.p+"images/scope.svg"},3220:(e,t,i)=>{"use strict";e.exports=i.p+"images/surface_grid_planar_256.png"},57721:(e,t,i)=>{"use strict";e.exports=i.p+"images/vert_arrows.png"},27273:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic1024.png"},15278:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic2048.png"},92787:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic4096.png"},67929:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineBasic512.png"},53896:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced1024.png"},38343:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced2048.png"},73965:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced4096.png"},33967:(e,t,i)=>{"use strict";e.exports=i.p+"images/outlineEnhanced512.png"},33757:(e,t,i)=>{"use strict";e.exports=i.p+"images/selected_sweep_glow.png"},74054:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetHighlightReel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"activeHighlightReel"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"HighlightReelDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PutActiveReel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"elements"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ReelElementInput"}}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"putActiveReel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"elements"},value:{kind:"Variable",name:{kind:"Name",value:"elements"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"HighlightReelDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"HighlightReel"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"reel"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"overrides"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"transitionType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"panDirection"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"panAngle"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"asset"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Photo"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}}]}}]}}],loc:{start:0,end:496}};t.loc.source={body:"query GetHighlightReel($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    activeHighlightReel {\n      ...HighlightReelDetails\n    }\n  }\n}\n\nmutation PutActiveReel($modelId: ID!, $elements: [ReelElementInput!]) {\n  putActiveReel(modelId: $modelId, elements: $elements) {\n    id\n  }\n}\n\nfragment HighlightReelDetails on HighlightReel {\n  id\n  label\n  reel {\n    overrides {\n      transitionType\n      panDirection\n      panAngle\n    }\n    asset {\n      ... on Photo {\n        id\n      }\n    }\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var s=e.type;"NamedType"===s.kind&&t.add(s.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var s={};function n(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function a(e,t){var i={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=s[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var d=o;o=new Set,d.forEach((function(e){r.has(e)||(r.add(e),(s[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var s=n(e,t);s&&i.definitions.push(s)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),s[e.name.value]=t}})),e.exports=t,e.exports.GetHighlightReel=a(t,"GetHighlightReel"),e.exports.PutActiveReel=a(t,"PutActiveReel"),e.exports.HighlightReelDetails=a(t,"HighlightReelDetails")},64341:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetMeasurements"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"measurementPaths"},arguments:[{kind:"Argument",name:{kind:"Name",value:"includeDisabled"},value:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"MeasurementDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddMeasurement"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"MeasurementPathDetails"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addMeasurementPath"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"path"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchMeasurement"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"pathId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"MeasurementPathPatch"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchMeasurementPath"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"pathId"},value:{kind:"Variable",name:{kind:"Name",value:"pathId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteMeasurement"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"pathId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteMeasurementPath"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"pathId"},value:{kind:"Variable",name:{kind:"Name",value:"pathId"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"MeasurementDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"MeasurementPath"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"lineType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"points"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"position"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"meshId"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"meshId"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]}]}}],loc:{start:0,end:835}};t.loc.source={body:"\nquery GetMeasurements($modelId: ID!, $includeDisabled: Boolean!) {\n  model(id: $modelId) {\n    id,\n    measurementPaths(includeDisabled: $includeDisabled) {\n      ...MeasurementDetails\n    }\n  }\n}\n\nmutation AddMeasurement($modelId: ID!, $data: MeasurementPathDetails!) {\n  addMeasurementPath(modelId: $modelId, , path: $data) {\n    id\n  }\n}\n\nmutation PatchMeasurement($modelId: ID!, $pathId: ID!, $data: MeasurementPathPatch!) {\n  patchMeasurementPath(modelId: $modelId, , pathId: $pathId, patch: $data) {\n    id\n  }\n}\n\nmutation DeleteMeasurement($modelId: ID!, $pathId: ID!) {\n  deleteMeasurementPath(modelId: $modelId, , pathId: $pathId)\n}\n\nfragment MeasurementDetails on MeasurementPath {\n  id\n  lineType\n  label\n  enabled\n  points {\n    position { x y z }\n    floor { id meshId }\n    room { id meshId }\n  }\n  created\n  modified\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var s=e.type;"NamedType"===s.kind&&t.add(s.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var s={};function n(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function a(e,t){var i={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=s[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var d=o;o=new Set,d.forEach((function(e){r.has(e)||(r.add(e),(s[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var s=n(e,t);s&&i.definitions.push(s)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),s[e.name.value]=t}})),e.exports=t,e.exports.GetMeasurements=a(t,"GetMeasurements"),e.exports.AddMeasurement=a(t,"AddMeasurement"),e.exports.PatchMeasurement=a(t,"PatchMeasurement"),e.exports.DeleteMeasurement=a(t,"DeleteMeasurement"),e.exports.MeasurementDetails=a(t,"MeasurementDetails")},12757:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetScans"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"assets"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"scans"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ScanDetails"},directives:[]}]}}]}}]}}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ScanDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"Scan"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"index"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"alignment"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"options"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"timeOfDay"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"anchor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"camera"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"name"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"vendor"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"captureMode"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"depthCameraType"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"cameraTypes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"sensorSerialNumbers"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"serialNumber"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mountCalibrationVersion"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"softwareVersion"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:452}};t.loc.source={body:"query GetScans($modelId: ID!) {\n  model(id: $modelId) {\n    id\n    assets {\n      scans {\n        ...ScanDetails\n      }\n    }\n  }\n}\n\nfragment ScanDetails on Scan {\n  id\n  index\n  name\n  created\n  alignment\n  options\n  url\n  timeOfDay\n  anchor {\n    id\n  }\n  camera {\n    id\n    name\n    vendor\n    model\n    captureMode\n    depthCameraType\n    cameraTypes\n    sensorSerialNumbers\n    serialNumber\n    mountCalibrationVersion\n    softwareVersion\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var s=e.type;"NamedType"===s.kind&&t.add(s.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var s={};function n(e,t){for(var i=0;i<e.definitions.length;i++){var s=e.definitions[i];if(s.name&&s.name.value==t)return s}}function a(e,t){var i={kind:e.kind,definitions:[n(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=s[t]||new Set,r=new Set,o=new Set;for(a.forEach((function(e){o.add(e)}));o.size>0;){var d=o;o=new Set,d.forEach((function(e){r.has(e)||(r.add(e),(s[e]||new Set).forEach((function(e){o.add(e)})))}))}return r.forEach((function(t){var s=n(e,t);s&&i.definitions.push(s)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),s[e.name.value]=t}})),e.exports=t,e.exports.GetScans=a(t,"GetScans"),e.exports.ScanDetails=a(t,"ScanDetails")},23444:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>WebVRLoader});var s=i(54122),n=i(25903),a=i(21265),r=i(25290),o=i(30853),d=i(25799),l=i(29675),h=i(61103),c=i(16925);const u=new d.Z("webvr-loader");class WebVRLoader extends s.Y{constructor(){super(...arguments),this.name="webvr-loader"}async init(e,t){this.engine=t,this.onExitVr=this.onExitVr.bind(this);const i=await t.getModule(r.default);this.appPhaseModule=await t.getModule(c.default),this.hackWebVRVersion=await i.getApi().getAppKey("SHOWCASE","webvr_version"),t.commandBinder.addBinding(h.s,(async()=>this.hackLoadVrScript())),t.commandBinder.addBinding(h.w,(async()=>this.hackEnterVrMode()))}async maybeCacheVrDisplay(){const e=await n.H();e&&(this.vrDisplay=e)}async hackEnterVrMode(){if(await this.maybeCacheVrDisplay(),u.debug(`Presenting legacy webvr app to ${this.vrDisplay}`),this.vrDisplay){u.info("Headset mounted"),this.engine.getModuleSync(o.default).disposeGui(),this.engine.deactivate(),this.explosivelyDisableGui();try{this.appPhaseModule.updateActiveApp(l.Mx.WEBVR)}catch(e){throw Error("Error: Can't switch application mode at this time")}}else u.error("vrDisplay not found")}hackLoadVrScript(){const e=a.hu("webvr")||this.hackWebVRVersion;u.debug(`Loading legacy webvr app version ${e}`);const t="https://static.matterport.com/webvr/"+e+"/js/main.js";return new Promise((function(e,i){const s=document.createElement("script");s.type="text/javascript",s.src=t,s.onload=e,document.head.appendChild(s)}))}onExitVr(){this.vrDisplay.isPresenting||(window.removeEventListener("vrdisplaypresentchange",this.onExitVr),u.info("Exiting VR"),this.hackUnload())}hackUnload(){let e=window.location.href;-1===window.location.search.indexOf("&qs=1")&&(e+="&qs=1"),window.location.replace(e)}explosivelyDisableGui(){const e=document.getElementById("gui");e&&e.remove()}}},21362:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>DwellAnalytics});var s=i(54122),n=i(13931),a=i(89155),r=i(29675),o=i(12775),d=i(71208),l=i(5368),h=i(39990),c=i(32020),u=i(97620),p=i(40032);function m(e){const t=(0,p.J5)(u.ep.toVisionQuaternion(e.rotation));return{position:(0,p.m)(u.ep.toVisionVector(e.position)),rotation:t,aspect:e.aspect(),isOrtho:e.isOrtho(),fovX:e.fovX(),fovY:e.fovY()}}function g(e){return(0,c.U)(new Date(e))}class DwellAnalytics extends s.Y{constructor(){super(...arguments),this.name="dwell-analytics",this.pendingDwellEvents=[],this.onCameraChange=(0,l.P)((e=>{this.checkForDwellEvent(),e.clone(this.currentEvent.pose),this.currentEvent.startTimeMs=Date.now(),this.scheduleDwellTimeOutEvent()}),1e3),this.checkForDwellEvent=(e=!1)=>{const{startTimeMs:t,viewmode:i}=this.currentEvent;if(!t||this.appData.phase!==r.nh.PLAYING)return;const s=Date.now(),n=s-t,a={pose:m(this.currentEvent.pose),durationMs:n,startTime:g(t),endTime:g(s),timedOut:e,viewmode:i};this.trackDwellEvent(a)},this.onViewmodeUpdate=e=>{e.value!==d.Ey.Transition&&(this.currentEvent.viewmode=(0,d.Ae)(e.value))},this.trackDwellEvent=e=>{this.pendingDwellEvents.push(e),this.trackPendingDwellEvents()},this.trackPendingDwellEvents=(0,l.P)((()=>{const e={events:JSON.stringify(this.pendingDwellEvents)};this.pendingDwellEvents=[],this.analytics.track("dwell_events",e)}),5e3),this.onBlur=()=>this.stopTrackingDwellTime(!1),this.stopTrackingDwellTime=(e=!1)=>{this.checkForDwellEvent(e),delete this.currentEvent.startTimeMs},this.resumeTrackingDwellTime=()=>{this.currentEvent.startTimeMs||(this.currentEvent.startTimeMs=Date.now()),this.scheduleDwellTimeOutEvent()},this.throttledResumeTrackingDwellTime=(0,l.P)(this.resumeTrackingDwellTime,100),this.scheduleDwellTimeOutEvent=(0,h.D)((()=>this.stopTrackingDwellTime(!0)),15e3)}async init(e,t){[this.analytics,this.cameraData,this.appData,this.viewmodeData]=await Promise.all([t.getModule(n.default),t.market.waitForData(a.M_),t.market.waitForData(r.pu),t.market.waitForData(o.O)]),this.currentEvent={pose:this.cameraData.pose.clone(),viewmode:(0,d.Ae)(null)},this.bindings.push(this.cameraData.pose.onChanged(this.onCameraChange)),this.bindings.push(this.viewmodeData.onPropertyChanged("currentModeObservable",this.onViewmodeUpdate)),window.addEventListener("blur",this.onBlur),window.addEventListener("focus",this.resumeTrackingDwellTime),window.addEventListener("keydown",this.resumeTrackingDwellTime),window.addEventListener("touchcancel",this.resumeTrackingDwellTime),window.addEventListener("touchstart",this.resumeTrackingDwellTime),window.addEventListener("touchend",this.resumeTrackingDwellTime),window.addEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.addEventListener("mousemove",this.throttledResumeTrackingDwellTime)}dispose(e){super.dispose(e),window.removeEventListener("blur",this.onBlur),window.removeEventListener("focus",this.resumeTrackingDwellTime),window.removeEventListener("keydown",this.resumeTrackingDwellTime),window.removeEventListener("touchcancel",this.resumeTrackingDwellTime),window.removeEventListener("touchstart",this.resumeTrackingDwellTime),window.removeEventListener("touchend",this.resumeTrackingDwellTime),window.removeEventListener("touchmove",this.throttledResumeTrackingDwellTime),window.removeEventListener("mousemove",this.throttledResumeTrackingDwellTime)}}},14647:(e,t,i)=>{"use strict";i.d(t,{Ko:()=>u,up:()=>m,hJ:()=>g});var s=i(2212),n=i(97620),a=i(62431),r=i(75195),o=i(90709);const d=new s.Vector2,l=new s.Vector3,h=new s.Vector2,c=new s.Vector2,u=(e,t,i)=>{const s=((e,t,i)=>((0,r.q9)(i,e,h),(0,r.q9)(i,t,c),{pixelDistance:h.distanceTo(c),startScreenPosition:h,endScreenPosition:c}))(e,t,i);return{screenPosition:((e,t,i)=>(l.copy(e).add(t).multiplyScalar(.5),(0,r.q9)(i,l,d),d))(e,t,i),rotation:p(h,c),pixelDistance:s.pixelDistance,startScreenPosition:s.startScreenPosition,endScreenPosition:s.endScreenPosition}},p=(e,t)=>{const i=e.y-t.y,s=e.x-t.x;let a=Math.atan2(i,s)*n.MN;return a=a>=90||a<=-90?a+180:a,a},m=(e,t=a.Mc.USFractional)=>{let i='0"';switch(t){case a.Mc.USFractional:const{feet:t,inches:s}=(0,o.XJ)(e);i=t>0?`${t}' ${s}"`:`${s}"`;break;case a.Mc.Metric:i=`${e.toFixed(2)}m`}return i},g=(e,t=10,i=40)=>({width:Math.max(9*Math.max(e,2)+t,i),height:18+t})},59886:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Group:()=>B.Z,Grouper:()=>B.h,MeasurementLabelRenderer:()=>MeasurementLabelRenderer,MeasurementLineRenderer:()=>MeasurementLineRenderer,MeasurementModeData:()=>_.X,MeasuringPhase:()=>Q.au,default:()=>dt,labelVisible:()=>Q.Ph});var s=i(54122),n=i(50101),a=i(73354),r=i(30963),o=i(62513),d=i(60303),l=i(59120),h=i(7065),c=i(76258),u=i(5002),p=i(85197),m=i(30853),g=i(89155),f=i(22729),v=i(12775),w=i(25799),y=i(2212),S=i(290),T=i(70781),D=i(14647),P=i(53628);const b=new w.Z("line-data");class LineDerivedDataFactory{constructor(e,t,i,s,n,a,r=(()=>({lineVisibleByFeatureType:!0,labelVisibleByFeatureType:!0}))){this.cameraData=e,this.viewmodeData=t,this.floorsViewData=i,this.isCurrentSweepAligned=s,this.getUnits=n,this.isFeatureEnabled=a,this.visibleFilter=r,this.derivedDataCache={},this.dollhouseLineStyle=T.T.ThreeD,this.setVisibilityFilter=e=>{this.visibleFilter=e},this.defaultVisibilityFilter=()=>{this.visibleFilter=()=>({lineVisibleByFeatureType:!0,labelVisibleByFeatureType:!0})},this.make=(e,t,i)=>{const s=t(),{start_position:n,end_position:a,visible:r,floorId:o,type:d,text:l}=s,h=void 0!==i?i.opacity.value:0,c=r&&this.isFeatureEnabled(),u=c&&this.visibleByFloorAndModes(o,d),p=0===h||h===P.iV.LABEL_HIDDEN_OPACITY&&u;if(i&&p&&(!c||!u))return i;let m=u,g=u;if(u){const t=this.visibleFilter(e);m=m&&t.lineVisibleByFeatureType,g=g&&t.labelVisibleByFeatureType}let f=0;const v=n.distanceTo(a),w=(0,D.up)(v,this.getUnits());if(g||!p){const{width:e,height:t}=(0,D.hJ)(l.length+w.length),i=(0,D.Ko)(n,a,this.cameraData);this.tmpVec.copy(i.startScreenPosition).sub(i.endScreenPosition);let s=Math.abs(this.tmpVec.y)<Math.abs(this.tmpVec.x)?t:e;P.iV.ALIGN_LABELS&&(s=e,f=i.rotation),g=g&&i.pixelDistance>s}let y;const T=m&&g?1:m&&!g?P.iV.LABEL_HIDDEN_OPACITY:0;i?(y=i.opacity,y.endValue===T&&m===i.visible&&g===i.labelVisible||y.modifyAnimation(y.value,T,P.iV.FADE_DURATION)):y=new S.z(0,T,P.iV.FADE_DURATION);const b={sid:e,rotation:f,labelVisible:g,visible:m,length:v,displayLength:w,labelContents:l.length>0?`${w} ${l}`:w,opacity:y};return this.derivedDataCache[e]={getLineData:t,previousDerivedData:b},b},this.update=e=>{if(this.derivedDataCache[e]){const{getLineData:t,previousDerivedData:i}=this.derivedDataCache[e];return this.make(e,t,i)}b.warn(`data not found for ${e}`)},this.get=e=>{if(this.derivedDataCache[e])return this.derivedDataCache[e].previousDerivedData},this.remove=e=>{this.derivedDataCache[e]&&delete this.derivedDataCache[e]},this.clear=()=>{this.derivedDataCache={}},this.visibleByFloorAndModes=(e,t)=>{if(this.floorsViewData.transition.progress.active)return!1;const i=this.viewmodeData.isPano(),s=this.viewmodeData.isFloorplan(),n=this.viewmodeData.isDollhouse(),a=this.floorsViewData.currentFloor,r=!a,o=!(!a||a.id!==e),d=e===this.floorsViewData.topFloorId,l=t===T.T.FloorplanOnly&&s&&(o||d&&r),h=t===this.dollhouseLineStyle&&n&&(o||r);return t===T.T.ThreeD&&i&&this.isCurrentSweepAligned()||h||l},this.tmpVec=new y.Vector2}setDollhouseLineStyle(e){this.dollhouseLineStyle=e}}var M,x,k=i(39936),I=i(62431),R=i(14600),E=i(77956),C=i(29675),N=i(54590),L=i(77399),F=i(35887),A=i(1437),O=i(60579),z=i(86034),G=i(42060),V=i(79758),U=i(44133),Q=i(45982),_=i(26983),B=i(11618),H=i(56040),j=i(88493),X=i(57501);!function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED",e[e.UPDATED=2]="UPDATED",e[e.COUNT=3]="COUNT"}(M||(M={})),function(e){e[e.ADDED=1]="ADDED",e[e.REMOVED=2]="REMOVED",e[e.UPDATED=4]="UPDATED",e[e.ALL=7]="ALL"}(x||(x={}));const q=(e,t)=>{const i=t&x.ADDED,s=t&x.REMOVED,n=t&x.UPDATED,a={};let r;return new X.gm((()=>e),(t=>r=e.onElementChanged((e=>(a.onAdded=i?e:void 0,a.onRemoved=s?e:void 0,a.onUpdated=n?e:void 0,a))(t))),(e=>{r&&r.cancel()}))};var Z;!function(e){e[e.x=16711680]="x",e[e.y=32768]="y",e[e.z=255]="z",e[e.free=16777215]="free",e[e.xz=16711935]="xz",e[e.laser=16724312]="laser",e[e.yellow=16776960]="yellow",e[e.white=16777215]="white"}(Z||(Z={}));var Y=i(91055);class MeasurementLineRenderer{constructor(e,t,i,s,n,a,r=(()=>-1),o,d=16777215){this.points=e,this.createPointSubscription=t,this.cameraData=i,this.lineModule=s,this.mainLayer=n,this.lineLayer=a,this.selectedGroup=r,this.getLineDetails=o,this.lineColor=d,this.endpointGeometry=new y.PlaneBufferGeometry(1,1),this.linePool=[],this.groupToLines={},this.pointToLines={},this.activeLines=[],this.cameraQuaternion=new y.Quaternion,this.cameraPosition=new y.Vector3,this.cameraProjection=new H.M,this.getLinesForPoint=e=>{const t=[];if(this.pointToLines[e])for(const i of this.pointToLines[e]){const e=i.getMesh(j.B.line),{startIndex:s,endIndex:n,group:a}=e.userData;t.push({endIndex:n,startIndex:s,line:i,group:a})}return t},this.updateMaterialColors(this.lineColor),this.dataSubs=[this.createPointSubscription(x.REMOVED,((e,t)=>{this.resetLines()}))]}updateMaterialColors(e){const t=P.V9.lineDefault;this.lineMaterial=this.lineModule.makeLineMaterial(e,!0,{linewidth:t}),this.lineMaterial.stencilRef=1,this.lineMaterial.stencilFail=y.KeepStencilOp,this.lineMaterial.stencilZFail=y.KeepStencilOp,this.lineMaterial.stencilZPass=y.KeepStencilOp,this.lineMaterial.stencilFunc=y.GreaterStencilFunc,this.lineMaterial.stencilWrite=!0,this.endpointMaterial=this.lineModule.makeEndpointMaterial(e);const i={dashed:!0,dashSize:.025,gapSize:.05,linewidth:P.V9.dottedLineDefault};this.dottedLineMaterial=this.lineModule.makeLineMaterial(e,!1,i),this.xLineMaterial=this.lineModule.makeLineMaterial(Z.x,!1,i),this.yLineMaterial=this.lineModule.makeLineMaterial(Z.y,!1,i),this.zLineMaterial=this.lineModule.makeLineMaterial(Z.z,!1,i),this.xzLineMaterial=this.lineModule.makeLineMaterial(Z.xz,!1,i)}setLineOpacityByGroup(e,t){const i=this.groupToLines[e];if(i)for(const e of i)e.opacity(t)}setLineOpacityByPoint(e,t){const i=this.getLinesForPoint(e);if(i)for(const e of i)e.line.opacity(t)}resetLines(){for(const e of this.lines)e.opacity(0),e.hide();this.groupToLines={},this.pointToLines={},this.lines.length=0}updateAllLines(){if(!(this.points.length<1)){for(let e=0;e<this.points.length;e++)this.updateLine(e);for(const e in this.groupToLines){const t=Number(e),i=this.groupToLines[t];for(const e of i)e.updateSelected(this.selectedGroup()===t)}}}init(){}dispose(){this.deactivate();for(const e of this.linePool)e.dispose();this.endpointGeometry.dispose(),this.dottedLineMaterial.dispose(),this.lineMaterial.dispose(),this.endpointMaterial.dispose(),this.xLineMaterial.dispose(),this.yLineMaterial.dispose(),this.zLineMaterial.dispose()}activate(){for(const e of this.dataSubs)e.renew()}deactivate(){for(const e of this.dataSubs)e.cancel();this.resetLines()}get lines(){return this.activeLines}get dottedMaterial(){return this.dottedLineMaterial}beforeRender(){this.cameraQuaternion.copy(this.cameraData.pose.rotation),this.cameraPosition.copy(this.cameraData.pose.position),this.cameraProjection.copy(this.cameraData.pose.projection)}get xMaterial(){return this.xLineMaterial}get yMaterial(){return this.yLineMaterial}get zMaterial(){return this.zLineMaterial}get xzMaterial(){return this.xzLineMaterial}render(){this.updateAllLines()}updateLine(e){const t=this.points.get(e),i=this.points.get(e+1),s=this.points.groupFromPointIndex(e)===this.points.groupFromPointIndex(e+1);t&&i&&s&&this.setLinePosition(e,t,i)}setLinePosition(e,t,i){let s=this.linePool[e];if(!s){const n=this.points.groupFromPointIndex(e);if(!this.getLineDetails(n,e,e+1).visible)return;const a=P.V9.endpointDefault>.01?this.endpointMaterial.clone():void 0;s=this.lineModule.makeLine(t,i,this.lineMaterial.clone(),a,(()=>!(0,Y.Pp)(this.cameraProjection))),this.setupLine(s,e),s.setRenderLayer(this.mainLayer)}s.visible||this.setupLine(s,e),this.linePool[e]=s,s.updateResolution(this.cameraData.width,this.cameraData.height),s.updatePositions(t,i),s.updateBillboard({rotation:this.cameraQuaternion,position:this.cameraPosition,projection:this.cameraProjection})}setupLine(e,t){const i=this.points.groupFromPointIndex(t);e.children.forEach((e=>{e.userData.startIndex=t,e.userData.endIndex=t+1,e.userData.group=i,e.layers.mask=this.mainLayer.mask})),e.getMesh(j.B.line).layers.mask=this.lineLayer.mask,this.activeLines.push(e),this.addLineToGroup(i,e),this.addLineToPoint(t,e),this.addLineToPoint(t+1,e),e.show(),e.opacity(0)}addLineToGroup(e,t){this.groupToLines[e]||(this.groupToLines[e]=[]),this.groupToLines[e].push(t)}addLineToPoint(e,t){this.pointToLines[e]||(this.pointToLines[e]=[]),this.pointToLines[e].push(t)}}var W=i(67126),$=i(75195),K=i(11203),J=i(27829);class MeasurementLabelRenderer{constructor(e,t,i,s,n,a,r){this.points=e,this.createPointSubscription=t,this.cameraData=i,this.renderLayer=s,this.renderOrder=n,this.textRenderer=a,this.getLineDetails=r,this.lengthCache=[],this.meshPool=[],this.textContainer=new y.Object3D,this.textGeometry=new y.PlaneBufferGeometry(1,1),this.tmpMidpoint=new y.Vector3,this.tmpCamPos=new y.Vector3,this.cameraRotation=new y.Quaternion,this.cameraProjection=new H.M,this.cameraPosition=new y.Vector3,this.dataSubs=[this.createPointSubscription(x.REMOVED,((e,t)=>{const i=this.meshPool[t];i&&(this.textContainer.remove(i),this.meshPool[t]=null);for(let e=this.points.length-1;e<this.lengthCache.length-1;++e)this.lengthCache[e]=-1}))]}reset(){for(const e of this.meshPool)e&&this.textContainer.remove(e);this.meshPool=[],this.lengthCache=[]}init(){}dispose(){this.textGeometry.dispose()}activate(){for(const e of this.dataSubs)e.renew()}deactivate(){for(const e of this.dataSubs)e.cancel();this.reset()}get container(){return this.textContainer}beforeRender(){const e=this.cameraData.pose;this.cameraRotation.copy(e.rotation),this.cameraPosition.copy(e.position),this.cameraProjection.copy(e.projection);const t=(0,Y.s1)(this.cameraProjection),i=(0,Y.Pp)(this.cameraProjection),s=this.cameraData.height,n=this.cameraData.zoom(),a=this.cameraData.aspect();for(let e=1;e<this.points.length;++e){const r=e-1,o=this.points.groupFromPointIndex(e),d=this.getLineDetails(o,r,e);if(!d||o!==this.points.groupFromPointIndex(r)){this.setMeshVisible(e,!1);continue}const l=this.points.get(r),h=this.points.get(e),c=this.setMeshVisible(e,d.labelVisible);if(!c)continue;c.text!==d.labelContents&&(c.text=d.labelContents);const u=this.cameraPosition.distanceTo(c.position);if(this.updateMeshPose(c,l,h,this.cameraRotation,this.cameraPosition,u,d.rotation,i),i||t)c.scaleFactor=K.Hn.SCALE_DISTANCE*n;else{const e=(0,$.D_)(c.position,this.cameraPosition,this.cameraRotation,this.cameraProjection.asThreeMatrix4()),t=Math.abs(e.x);if(t<1){const e=(0,Y.mY)(this.cameraProjection,this.cameraPosition,c.position,s,K.Hn.SCALE),i=((0,W.uZ)(a,1,2.5)+n)*K.Hn.SCALE_ASPECT,r=1+K.Hn.SCALE_NDC-t*K.Hn.SCALE_NDC-i;c.scaleFactor=Math.max(Math.min(1/e*r,3),.001)}else c.scaleFactor=.001}}}setTextOpacityByPoint(e,t){const i=this.meshPool[e];i&&(i.opacity=t)}updateMeshPose(e,t,i,s,n,a,r,o){this.tmpMidpoint.copy(t).add(i).multiplyScalar(.5);const d=o?e=>this.tmpCamPos.copy(e).addScaledVector(J.f.UP,.15):e=>this.tmpCamPos.copy(n).sub(e).setLength(.15*a).add(e);e.setPosition(this.tmpMidpoint,d),e.setOrientation(s,r)}render(){}setMeshVisible(e,t){let i=this.meshPool[e];if(!i&&t){i=this.textRenderer.createLabel(),i.setRenderLayer(this.renderLayer),i.renderOrder=this.renderOrder,i.opacity=1,i.visible=!1;const t=this.points.groupFromPointIndex(e);i.userData.groupIndex=t,this.textContainer.add(i)}if(i){const e=t?.001:P.iV.LABEL_HIDDEN_OPACITY;if(i.visible=i.opacity>e,!i.visible)return null}return this.meshPool[e]=i,i}}var ee=i(2779),te=i(1089),ie=i(60778),se=i(15782),ne=i(3834),ae=i(24135),re=i(16002),oe=i(57721),de=i(3220);class GridPlaneCursor{constructor(e,t=ee.o.ALL){this.scene=e,this.layer=t,this.supportsMobile=!0,this.style=re.L.GridPlane,this.alignToNormal=!0,this.xzTex=(0,ie.p)(oe),this.zyTex=(0,ie.p)(de),this.bindings=[],this.onOpacityUpdate=e=>{this.container.children.forEach((t=>{t.isMesh&&(t.material.opacity=Math.max(0,e.opacity.value))}))},this.onPositionUpdate=(e,t)=>{this.container.position.copy(e).addScaledVector(t,.005),this.alignToNormal&&(0,Y.J2)(this.container,e,t)},this.scale=e=>{this.container.scale.set(e,e,e)},this.onRaycasterUpdate=e=>{e.hit&&e.hit.face&&this.onPositionUpdate(e.hit.point.clone(),e.hit.face.normal)},this.container=new y.Group;const i=new y.PlaneGeometry(.4,.4),s={color:16777215,side:y.DoubleSide,transparent:!0,depthTest:!0,depthWrite:!1};this.xzTex.generateMipmaps=!1,this.xzTex.minFilter=y.LinearFilter,this.xzMaterial=new y.MeshBasicMaterial(Object.assign(Object.assign({},s),{color:65280,map:this.xzTex})),this.xzMaterial.premultipliedAlpha=!1;const n=new y.Mesh(i,this.xzMaterial);n.rotateOnAxis(J.f.LEFT,Math.PI/2),this.zyTex.generateMipmaps=!1,this.zyTex.minFilter=y.NearestFilter,this.zyMaterial=new y.MeshBasicMaterial(Object.assign(Object.assign({},s),{map:this.zyTex})),this.zyMaterial.premultipliedAlpha=!1;const a=new y.Mesh(i,this.zyMaterial);this.container.add(n,a),this.container.children.forEach((e=>e.layers.mask=this.layer.mask))}init(){}render(){}dispose(){this.container.children.forEach((e=>{if(e.isMesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(ne.Y),i=await e.market.waitForData(ae.P);this.bindings.push(t.onChanged(this.onOpacityUpdate),i.onChanged(this.onRaycasterUpdate)),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}var le=i(97620);class IntersectionVisualizer{constructor(e,t,i,s,n,a,r,o){this.mobile=e,this.getPhase=t,this.pointer=i,this.sceneInfo=s,this.renderToTexture=n,this.getLayer=a,this.getChunks=r,this.editing=!1,this.editingStateChange=!1,this.setOverlay=e=>{for(const t of this.getChunks())t.setColorOverlay(e?se.Y7:null)},this.setupCursorRenderCamera=()=>{const e=new y.PerspectiveCamera(K.X7.perspective.fov,1,.1,100);e.name="Cursor Peek Camera";const t=ee.o.ALL,i=["measurement-mode","measurement3d"];for(const e of i)t.removeLayers(this.getLayer(e));e.layers.mask=t.mask,e.updateProjectionMatrix();return{camera:e,update:(t,i,s)=>{e.fov=t,e.near=i,e.far=s,e.updateProjectionMatrix()}}};const d=(0,ie.p)(te),l=new y.Vector2,h=e=>{const t=this.rttView.height,i=this.rttView.width,s=this.sceneInfo.cameraData;let n=t/2;const a=-i/2;n=e.y<t/2+n?t+n:-n;const r=e.x+a,o=s.height-e.y-n;return l.set(r,o)};this.cursorMesh=new GridPlaneCursor(this.sceneInfo.scene,this.getLayer("cursor-mesh")),this.cursorMesh.setVisible(!1);const c=new y.Vector3,u=new y.Quaternion,p=new y.Vector2;let m,g,f=o(),v=K.X7.perspective;this.renderIntersection=(e,t,i)=>{m||(g=this.setupCursorRenderCamera(),m=g.camera,g.update(K.X7.perspective.fov,.1,100)),f!==o()&&(v=o()?K.X7.ortho:K.X7.perspective,this.cursorMesh.scale(v.scale),g.update(v.fov,.1,100),f=o());const a=this.editingStateChange?1:K.X7.smoothness;if(t){if(s.playerCamera.getWorldPosition(c),s.playerCamera.getWorldQuaternion(u),o()){const e=s.cameraData.zoom(),i=(0,le.dS)(e,v.thresholdClose,v.thresholdFar,v.offsetClose,v.offsetFar);m.position.copy(t.point).addScaledVector(J.f.UP,i),m.quaternion.copy(u)}else{const e=(0,le.dS)(t.distance,v.thresholdClose,v.thresholdFar,v.offsetClose,v.offsetFar),i=c.sub(t.point).setLength(e).add(t.point);m.position.lerp(i,a),m.lookAt(t.point)}m.updateMatrixWorld(),K.E0&&this.setOverlay(!1),n.render(e,s.scene.scene,m),K.E0&&this.setOverlay(!0),p.lerp(h(i),a),n.renderToScreen(e,p,d)}this.editingStateChange=!1}}init(){}dispose(){}activate(){this.sceneInfo.scene.addChild(d.a.Root,this.cursorMesh.container);const e=this.mobile?K.ox.mobileSize:this.sceneInfo.cameraData.height>K.ox.highResThreshold?K.ox.desktopSizeHighRes:K.ox.desktopSize;this.rttView=this.renderToTexture.createRenderTarget2D(e,e,{format:y.RGBFormat},!1)}deactivate(){this.sceneInfo.scene.removeChild(d.a.Root,this.cursorMesh.container),this.renderToTexture.disposeRenderTarget2D(this.rttView),this.editing=!1}beforeRender(){const e=this.getPhase(),t=this.mobile?!!Q.Pj.mobile[e]:!!Q.Pj.desktop[e];t!==this.editing&&(this.editingStateChange=!0,this.editing=t,this.cursorMesh.setVisible(this.editing)),this.editing&&(this.hit=this.mobile?this.pointer.lastIntersection:this.pointer.getIntersection(),this.hit&&this.cursorMesh.onPositionUpdate(this.hit.point,this.hit.normal))}render(){if(this.editing&&this.hit){const{screenPosition:e}=(0,$.q9)(this.sceneInfo.cameraData,this.hit.point);this.renderIntersection(this.rttView,this.hit,e)}}}var he,ce=i(93781),ue=i(61718),pe=i(70691);!function(e){e[e.SnapPoint=1]="SnapPoint",e[e.SnapLine=2]="SnapLine",e[e.AxisAny=3]="AxisAny",e[e.AxisX=4]="AxisX",e[e.AxisY=5]="AxisY",e[e.AxisZ=6]="AxisZ",e[e.Mesh=7]="Mesh",e[e.RoomMesh=8]="RoomMesh",e[e.LinePoint=9]="LinePoint",e[e.LineSegment=10]="LineSegment"}(he||(he={}));class SnapAxisLine3 extends pe.FM{constructor(e,t,i,s,n){super(e,t,i,s),this.floorId=i,this.roomId=s,this.featureType=n}}class SnapUserLine3 extends pe.FM{constructor(e,t,i,s,n){super(e,t,i,s),this.floorId=i,this.roomId=s,this.featureType=n}}const me={[J.e.UP]:he.AxisY,[J.e.DOWN]:he.AxisY,[J.e.FORWARD]:he.AxisZ,[J.e.BACK]:he.AxisZ,[J.e.LEFT]:he.AxisX,[J.e.RIGHT]:he.AxisX,[J.e.HORIZONTAL_PLANE]:he.AxisY,NONE:void 0};var ge;!function(e){e[e.UserAxis=1]="UserAxis",e[e.UserPoint=2]="UserPoint",e[e.UserLine=3]="UserLine",e[e.ModelFeature=4]="ModelFeature"}(ge||(ge={}));const fe={[he.LinePoint]:ge.UserPoint,[he.LineSegment]:ge.UserLine,[he.AxisAny]:ge.UserAxis,[he.AxisX]:ge.UserAxis,[he.AxisY]:ge.UserAxis,[he.AxisZ]:ge.UserAxis,[he.Mesh]:ge.ModelFeature,[he.RoomMesh]:ge.ModelFeature,[he.SnapLine]:ge.ModelFeature,[he.SnapPoint]:ge.ModelFeature};var ve=i(67399);class ConstrainedHit{constructor(e,t,i){this.constraint=t,this.point=new y.Vector3,this.normal=new y.Vector3,we(e)?this.updateFromIntersection(e,t):ye(e)&&i&&this.updateFromSnapIntersection(e,t,i),this.source=e}updatePoint(e){return this.point.copy(e),this.source.point.copy(e),this}updateFromIntersection(e,t){return this.source=e,this.updateContents(t,e.point,e.face.normal,e.distance,e.object),this}updateFromSnapIntersection(e,t,i){return this.source=e,this.updateContents(t,e.point,i,e.distance,e.object),this}copy({constraint:e,point:t,normal:i,distance:s,object:n}){this.updateContents(e,t,i,s,n)}clone(){return new ConstrainedHit(this.source,this.constraint)}updateContents(e,t,i,s,n){this.constraint=e,this.point.copy(t),this.normal.copy(i),this.distance=s,this.object=n,ve.$4.hasRoomId(n)?(this.roomId=n.roomId,this.floorId=n.floorId):ve.$4.hasFloorId(n)&&(this.floorId=n.floorId,this.roomId=null),this.featureType=(e=>{if(e)return"featureType"in e&&void 0!==e.featureType?e.featureType:e instanceof y.Vector3||e instanceof pe.UQ?he.SnapPoint:e instanceof ce.g?he.RoomMesh:e instanceof ue.S?he.Mesh:e instanceof y.Line3||e instanceof pe.FM?he.SnapLine:void 0})(n)}}const we=e=>e&&"face"in e&&void 0!==e.face&&ve.$4.hasFloorId(e.object),ye=e=>e&&"isLineOctreeIntersection"in e&&ve.$4.hasFloorId(e.object),Se=(()=>{class MockedRoom extends y.Object3D{constructor(e,t){super(),this.floorId=e,this.roomId=t}}return(e,t,i,s,n)=>({point:e,floorId:s,roomId:n,object:new MockedRoom(s,n),face:new y.Face3(0,1,2,t),distance:i})})();var Te=i(90384),De=i(21307),Pe=i(24975),be=i(73706),Me=i(75158),xe=i(21588),ke=i(40582);const Ie=e=>e instanceof Me.R?e.button===ke.MP.PRIMARY:e.buttons===ke.r3.PRIMARY;var Re=i(75712);class MeasurementInput extends y.Mesh{constructor(e,t,i,s,n,a,r,o,d,l,h,c){super(),this.pointGroups=e,this.input=t,this.cameraData=i,this.mobile=s,this.changeCursor=n,this.getPhase=a,this.changePhase=r,this.restorePreviousPhase=o,this.setSelectedLine=d,this.getSelected=l,this.onDragStart=h,this.onDragEnd=c,this.inputSubscriptions=[],this.groupVisible=[],this.raycast=(()=>{const e=new y.Vector3;return(t,i)=>{const{pose:s,width:n}=this.cameraData,a=.005*n,r=s.projection.asThreeMatrix4(),o=s.position;let d,l=0,h=0;for(let i=0;i<this.pointGroups.groupCount;++i){const s=this.pointGroups.getGroup(i);if(!(void 0!==this.editingGroup&&this.editingGroup!==i)&&this.groupVisible[i]){for(let c=0;c<s.count-1;++c){const u=s.get(c),p=s.get(c+1);if(u&&p){const s=t.ray.distanceSqToSegment(u,p,void 0,e),c=o.distanceTo(e);let m=(0,Y._U)(c,r,n)*a;if(m*=m,s<m){let n,a=e;u.distanceToSquared(e)<2*m?(n=h,a=u):p.distanceToSquared(e)<2*m&&(n=h+1,a=p),(!d||s<l)&&(d={distance:t.ray.origin.distanceTo(a),point:a,object:this,instanceId:i,index:n},l=s)}}h++}h++}else h+=s.count}d&&i.push(d)}})(),this.inputSubscriptions.push(...this.registerCommonInput()),s||this.inputSubscriptions.push(...this.registerHoverInput()),this.deactivate()}activate(){this.input.registerMesh(this,!1),this.inputSubscriptions.forEach((e=>e.renew()))}deactivate(){this.input.unregisterMesh(this),this.inputSubscriptions.forEach((e=>e.cancel()))}dispose(){this.deactivate()}setEditingGroup(e){this.editingGroup=e}setGroupVisible(e,t){this.groupVisible[e]=t}validJoint(e){return!!e&&void 0!==e.index}registerHoverInput(){return[this.input.registerMeshHandler(be.z,Re.s.isType(MeasurementInput),((e,t,i)=>{this.getPhase()===Q.au.IDLE&&this.changeCursor(i&&void 0!==i.index?h.C.GRAB:h.C.FINGER)})),this.input.registerMeshHandler(be.A,Re.s.isType(MeasurementInput),((e,t,i)=>{this.getPhase()===Q.au.IDLE&&this.changeCursor(h.C.DEFAULT)}))]}registerCommonInput(){return[this.input.registerMeshHandler(Me.R,Re.s.isType(MeasurementInput),((e,t,i)=>{if(!Ie(e))return!1;if(this.getPhase()!==Q.au.IDLE)return!1;const s=i&&void 0!==i.instanceId?i.instanceId:-1,n=this.getSelected()===s?-1:s;return this.setSelectedLine(n),!0})),this.input.registerMeshHandler(xe._t,Re.s.isType(MeasurementInput),((e,t,i)=>!!Ie(e)&&(!!Q.WN[this.getPhase()]&&(!this.validJoint(i)||(!i||void 0===i.instanceId||(this.onDragStart(i.instanceId),this.setSelectedLine(i.instanceId),this.changePhase(Q.au.EDITING),this.mobile||this.changeCursor(h.C.GRABBING),!0)))))),this.input.registerMeshHandler(xe._R,Re.s.isType(MeasurementInput),((e,t,i)=>this.getPhase()===Q.au.EDITING&&(this.restorePreviousPhase(),this.onDragEnd(),this.mobile||this.changeCursor(h.C.DEFAULT),!0)))]}}const Ee=new w.Z("snapping");class SnappablePointer{constructor(e,t,i,s,n){this.raycaster=e,this.getConstraintStyle=t,this.floorsViewData=s,this.viewmodeData=n,this.origin=null,this.planeNormal=new y.Vector3,this.plane=new y.Plane,this.ray=new y.Ray,this.originChangedListeners=[],this.registeredSnapFeatures={[ge.UserAxis]:[],[ge.UserLine]:[],[ge.UserPoint]:[],[ge.ModelFeature]:[]},this.clearOrigin=()=>{this.origin=null,this.originChangedListeners.forEach((e=>e(null)))},this.setOrigin=(e,t=!1)=>{this.origin&&!t||(this.origin=e,this.plane.setFromNormalAndCoplanarPoint(this.origin.normal,this.origin.point),this.originChangedListeners.forEach((e=>e(this.origin))),Ee.debug("Updating origin",this.origin,{forceUpdate:t}))},this.setOriginFromPointer=e=>{if(this.origin)return;const t=this.getMeshIntersection();if(!t)return;const i=new ConstrainedHit(t,this.getConstraintStyle());e&&i.updatePoint(e),this.setOrigin(i,!0)},this.snapFeatures=e=>this.registeredSnapFeatures[e].reduce(((e,t)=>e.concat(t.features)),[]),this.addSnapFeatures=(e,t,i)=>{const s=fe[t];this.registeredSnapFeatures[s].push({owner:e,features:i}),Ee.debug(`Adding ${i.length} snap feature groups`,he[t],t)},this.removeSnapFeatures=(e,t)=>{const i=fe[t],s=this.registeredSnapFeatures[i].findIndex((t=>t.owner===e));if(-1!==s){const e=this.registeredSnapFeatures[i].splice(s,1);Ee.debug(`Removing ${e.length} snap feature groups`,he[t],t)}else Ee.debug(`removeTemporarySnapFeature: ${t} ${he[t]} not found from`,e,this.registeredSnapFeatures)},this.filters={nop:e=>!0,userPoints:e=>{if(void 0===e.object)return!1;if((t=e.object)&&t instanceof y.Vector3)for(const t of this.snapFeatures(ge.UserPoint))if(t.equals(e.object))return!0;var t;return!1},userLines:e=>{if(void 0===e.object)return!1;if((t=e.object)&&"isSnapAxisLine3"in t||"isSnapUserLine3"in t||"isSnapLine3"in t||"start"in t&&"end"in t&&"closestPointToPoint"in t){for(const t of this.snapFeatures(ge.UserLine))if(t.equals(e.object))return!0;for(const t of this.snapFeatures(ge.UserAxis))if(t.equals(e.object))return!0}var t;return!1},userFeatures:e=>this.filters.userPoints(e)||this.filters.userLines(e)},this.meshSnapRadius=i?K.Oq.mobile:K.Oq.desktop}preload(){this.raycaster.snapping.preloadMeshSnapping()}getMeshIntersection(e){let t,i=null,s=!1;if(e&&e.origin&&e.normal?(s=!0,t=this.raycaster.picking.cast(e.origin,e.normal)):t=this.raycaster.pointer.cast(),i=t[0],this.viewmodeData.isFloorplan()&&i&&!s){i=t.filter((e=>!(e.object instanceof MeasurementInput)))[0];const e=this.floorsViewData.getHighestVisibleFloor(),s=ve.$4.matchesFloorId(e.id);!(!i||we(i)&&s(i.object))&&(i=Se(i.point,new y.Vector3(0,1,0),i.distance,e.id,null)),i.point.y=e.boundingBox.max.y,i.face&&i.face.normal.set(0,1,0)}else i=t.filter((e=>(0,Pe.Pv)(e.object)))[0];return we(i)?i:null}getIntersection(e){const t=this.getMeshIntersection(e);if(!t)return null;this.cachedHit||(this.cachedHit=new ConstrainedHit(t,this.getConstraintStyle()));const i=this.cachedHit.updateFromIntersection(t,this.getConstraintStyle()),s=this.raycaster.pointer.pointerRay;this.ray.set(s.origin,s.direction),this.planeNormal.copy(i.normal);switch(this.getConstraintStyle()){case Te.l1.Free:return i;case Te.l1.Axes:return this.lockToWorldAxes(i);case Te.l1.PlanarAxes:const e=[...this.snapFeatures(ge.UserAxis),...this.snapFeatures(ge.UserLine),...this.snapFeatures(ge.UserPoint)];return this.softSnapToEdges(i,e,this.filters.userFeatures);case Te.l1.Edges:const t=[...this.snapFeatures(ge.UserLine),...this.snapFeatures(ge.UserPoint)];return this.softSnapToEdges(i,t,this.filters.nop);case Te.l1.EdgesAndPlanarAxes:const s=[...this.snapFeatures(ge.UserAxis),...this.snapFeatures(ge.UserLine),...this.snapFeatures(ge.UserPoint)];return this.softSnapToEdges(i,s,this.filters.nop)}return i}get lastIntersection(){return this.cachedHit}onOriginChanged(e,t=!1){const i={renew:()=>{this.originChangedListeners.push(e)},cancel:()=>{(0,De.b)(this.originChangedListeners,e)}};return t&&i.renew(),i}lockToWorldAxes(e){if(this.origin){const t=(0,Te.r2)(this.origin.point,e.point,Te.l1.Axes);return this.cachedHit.copy(e),this.cachedHit.point.copy(t.position),this.cachedHit.constraint="NONE"!==t.axisName?Te.l1.Axes:Te.l1.Free,this.cachedHit.featureType=me[t.axisName],this.cachedHit}return e}softSnapToEdges(e,t,i){const s=this.origin?this.origin.point:e.point,n=this.origin?this.origin.normal:e.normal;this.raycaster.snapping.add(...t);const a=this.raycaster.snapping.cast(this.ray,this.meshSnapRadius,s,n).filter(i),r=this.raycaster.snapping.pick(this.ray,this.meshSnapRadius,a);return this.raycaster.snapping.remove(...t),r?(this.cachedHit.updateFromSnapIntersection(r,this.getConstraintStyle(),n),this.cachedHit):e}}var Ce=i(39990);class SnappablePointUpdater{constructor(e,t,i,s){this.points=e,this.createPointSubscription=t,this.pointer=i,this.mobileCreateHackJob=s,this.subscriptions=[],this.lineSegments=[],this.updateSnapping=e=>{this.lineSegments.length>0&&(this.pointer.removeSnapFeatures(this,he.LineSegment),this.lineSegments.length=0);for(let t=0;t<this.points.length;t++)if(t!==e&&t!==e-1&&t!==e+1&&!this.points.isStartIndex(t)){const e=this.points.get(t),i=this.points.get(t-1),s=this.points.getGroup(this.points.groupFromPointIndex(t));this.lineSegments.push(new SnapUserLine3(i,e,s.info.floorId,s.info.roomId,he.LineSegment))}this.lineSegments.length>0&&this.pointer.addSnapFeatures(this,he.LineSegment,this.lineSegments)}}init(){}dispose(){}activate(e){let t=-1,i=-1;const s=(0,Ce.D)((()=>this.updateSnapping(this.points.length)),16);this.subscriptions.push(this.createPointSubscription(x.ADDED,s,!0),this.createPointSubscription(x.REMOVED,s,!0),this.createPointSubscription(x.UPDATED,((e,s)=>{s===t||this.mobileCreateHackJob()&&s===i||(this.updateSnapping(s),i=t,t=s)}),!0))}deactivate(){this.subscriptions.forEach((e=>e.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,he.LinePoint),this.pointer.removeSnapFeatures(this,he.LineSegment)}beforeRender(){}render(){}}class MeasurementJointEditor{constructor(e,t,i,s,n,a){this.points=e,this.pointer=i,this.getPhase=s,this.onDrag=n,this.onDragEnd=a,this.inputSubscriptions=[],this.onDragBegin=(e,t,i)=>{if(!Q.q8[this.getPhase()])return!1;if(!i||void 0===i.index)return!1;const s=this.points.isStartIndex(i.index)?i.index+1:i.index-1,n=this.points.get(s);return this.pointer.clearOrigin(),this.pointer.setOriginFromPointer(n),!0},this.onDragEndEvent=()=>!!Q.q8[this.getPhase()]&&(this.onDragEnd(),this.pointer.clearOrigin(),!0),this.onDragEvent=(e,t,i)=>{if(e.buttons!==ke.r3.PRIMARY)return!1;if(!Q.q8[this.getPhase()])return!1;if(!i||void 0===i.index||void 0===i.instanceId)return!1;const s=this.pointer.getIntersection();return s&&this.points.update(i.index,s.point),this.onDrag(i.instanceId),!0},this.inputSubscriptions.push(t.registerMeshHandler(xe.E0,Re.s.isType(MeasurementInput),this.onDragBegin),t.registerMeshHandler(xe._t,Re.s.isType(MeasurementInput),this.onDragEvent),t.registerMeshHandler(xe._R,Re.s.isType(MeasurementInput),this.onDragEndEvent)),this.deactivate()}activate(){for(const e of this.inputSubscriptions)e.renew()}deactivate(){for(const e of this.inputSubscriptions)e.cancel()}}var Ne=i(36073);class MeasurementLineStyler{constructor(e,t,i,s,n,a,r){this.lines=e,this.getLinesForPoint=t,this.editingMaterial=i,this.createPointSubscription=s,this.getPhase=a,this.getSelected=r,this.bindings=[],this.onDragEnd=e=>{for(const e of this.lines)e.restoreLineMaterial()},this.onClick=(e,t,i)=>{if(this.getPhase()!==Q.au.IDLE)return!1;for(const e of this.lines)e.restoreLineMaterial();if(!i||void 0===i.index)return!1;if(e.down){const e=i.index;void 0!==e&&this.styleLines(e)}return!1},this.styleLines=e=>{const t=this.getLinesForPoint(e);for(const e of t)e.group===this.getSelected()&&e.line.overrideLineMaterial(this.editingMaterial)},this.bindings.push(n.registerMeshHandler(Ne.er,Re.s.isType(MeasurementInput),this.onClick),n.registerUnfilteredHandler(xe._R,this.onDragEnd),...this.setupLineStyler(this.createPointSubscription)),this.deactivate()}activate(){for(const e of this.bindings)e.renew()}deactivate(){for(const e of this.bindings)e.cancel()}setupLineStyler(e){return[e(x.ADDED,(()=>{const e=this.lines[this.lines.length-1];e&&e.restoreLineMaterial()}),!0),e(x.UPDATED,((e,t)=>{this.styleLines(t)}),!0)]}}var Le=i(35056),Fe=i(63986);class MeasurementCreator{constructor(e,t,i,s,n,a,r,o){this.points=e,this.setSelected=t,this.pointer=i,this.changePhase=s,this.getPhase=n,this.isFloorplan=a,this.currentFloorId=r,this.currentRoomId=o,this.id=MeasurementCreator,this.onGroupCreated=e=>null,this.onGroupAddPoint=()=>null,this.onDone=()=>null,this.onEdit=e=>null,this.previousPhase=Q.au.IDLE,this.currentLinePoints=0,this.previousPoint=new y.Vector3,this.inputSubscriptions=[],this.log=new w.Z("measurement-creator"),this.createNewLine=e=>{const t=e.roomId||this.currentRoomId()||null,i=e.floorId||this.currentFloorId();if(!i)throw new Fe.H(`Cannot create new line on invalid floor '${i}'`);const s={visible:!0,roomId:t,floorId:i,type:this.isFloorplan()?T.T.FloorplanOnly:T.T.ThreeD,text:"",created:new Date,modified:new Date},n=this.points.startGroup(s);this.currentGroup=n,this.points.push(e.point),this.currentLinePoints=1,this.setSelected(n);const a=this.points.getGroup(n);this.onGroupCreated(a.info.sid),this.pointer.setOrigin(e,!0)},this.addPointToLine=e=>{this.previousPoint.copy(e.point),this.points.push(e.point),++this.currentLinePoints,this.onGroupAddPoint(),this.pointer.setOrigin(e,!0)},this.updateLastPoint=e=>{this.points.update(this.points.length-1,e.point)},this.getIntersection=e=>this.pointer.getIntersection(e),this.setPhase=e=>{const t=this.getPhase();e!==t&&(this.previousPhase=t,this.changePhase(e))},this.restorePreviousPhase=()=>{this.setPhase(this.previousPhase)}}start(){if(this.getPhase()===Q.au.IDLE){this.previousPoint.set(1e3,1e3,1e3),this.setPhase(Q.au.CREATING),this.setSelected(-1);for(const e of this.inputSubscriptions)e.renew()}}cancelSubs(){for(const e of this.inputSubscriptions)e.cancel()}stop(){this.cancelSubs(),this.currentLinePoints=0,this.setSelected(-1),this.setPhase(Q.au.IDLE),this.pointer.clearOrigin(),this.onDone()}}class MeasurementCreatorMobile extends MeasurementCreator{constructor(e,t,i,s,n,a,r,o,d,l,h,c,u){super(e,t,s,n,d,h,c,u),this.setCreatePointProgress=a,this.updateCreatePointHit=r,this.toggleCameraMovement=o,this.continuous=l,this.onLongPressSuccess=e=>{this.log.debug("onLongPressSuccess while in phase:",Q.au[this.getPhase()]),this.getPhase()===Q.au.CREATING?(this.createNewLine(e),this.addPointToLine(e)):this.getPhase()===Q.au.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(e),this.addPointToLine(e)):this.updateLastPoint(e)),this.setPhase(Q.au.POINT_PLACED)},this.onLongPressStart=e=>{if(e.buttons===ke.r3.PRIMARY&&(this.getPhase()===Q.au.CREATING||this.getPhase()===Q.au.CREATING_NEXT_POINT)){const e=this.getIntersection();e&&(this.previousPoint.equals(e.point)||(this.setPhase(Q.au.CONFIRMING_POINT),this.toggleCameraMovement(!1),this.setCreatePointProgress(Date.now(),MeasurementCreatorMobile.longPressCreateThreshold),this.updateCreatePointHit(e),this.previousPhase===Q.au.CREATING_NEXT_POINT&&(this.updateLastPoint(e),this.toggleLastPointDraggable(!1)),this.creatingPointTimeout=window.setTimeout((()=>{this.restorePreviousPhase(),this.onLongPressSuccess(e),this.toggleLastPointDraggable(!0)}),MeasurementCreatorMobile.longPressCreateThreshold)))}},this.onLongPressEnd=()=>{this.getPhase()===Q.au.CONFIRMING_POINT&&(this.log.debug("onLongPressEnd, cancelling confirmation"),this.setCreatePointProgress(0,MeasurementCreatorMobile.longPressCreateThreshold),window.clearTimeout(this.creatingPointTimeout),this.toggleCameraMovement(!0),this.restorePreviousPhase()),this.getPhase()===Q.au.CREATING_NEXT_POINT&&this.points.update(this.points.length-1,this.points.get(this.points.length-2)),this.setPlacedtoCreatePhase()},this.onDrag=()=>{const e=this.getIntersection();e&&(this.setPlacedtoCreatePhase(),this.setPhase(Q.au.EDITING),this.previousPhase===Q.au.CREATING_NEXT_POINT?this.updateLastTwoPoints(e):this.previousPhase===Q.au.CREATING&&this.updateLastPoint(e))},this.onDragEnd=()=>{this.getPhase()===Q.au.EDITING&&this.restorePreviousPhase(),this.getPhase()!==Q.au.CREATING&&this.getPhase()!==Q.au.CREATING_NEXT_POINT||(this.toggleLastPointDraggable(!1),this.toggleCameraMovement(!0))},this.toggleLastPointDraggable=e=>{e?(this.dragSub.renew(),this.dragEndSub.renew()):(this.dragSub.cancel(),this.dragEndSub.cancel())},this.updateLastTwoPoints=e=>{this.points.update(this.points.length-1,e.point),this.points.update(this.points.length-2,e.point)},this.dragSub=i(xe._t,this.onDrag),this.dragEndSub=i(xe._R,this.onDragEnd),this.inputSubscriptions.push(i(Le.Vh,this.onLongPressStart),i(Le.pt,this.onLongPressEnd)),this.dragSub.cancel(),this.dragEndSub.cancel(),this.cancelSubs()}start(){super.start()}stop(){if(this.getPhase()===Q.au.CREATING_NEXT_POINT)if(this.continuous())this.points.pop();else{const e=this.points.getGroup(this.currentGroup);this.points.removeFromIdx(e.startIndex)}super.stop()}setPlacedtoCreatePhase(){this.getPhase()===Q.au.POINT_PLACED&&(this.continuous()?(this.previousPhase===Q.au.CREATING||this.previousPhase===Q.au.CREATING_NEXT_POINT)&&this.setPhase(Q.au.CREATING_NEXT_POINT):this.previousPhase===Q.au.CREATING?this.setPhase(Q.au.CREATING_NEXT_POINT):this.previousPhase===Q.au.CREATING_NEXT_POINT&&this.setPhase(Q.au.CREATING))}}MeasurementCreatorMobile.longPressCreateThreshold=500;class MeasurementCreatorDesktop extends MeasurementCreator{constructor(e,t,i,s,n,a,r,o,d,l){super(e,t,s,n,a,r,o,d),this.continuous=l,this.onCreate=e=>{const t=this.previousPoint.distanceTo(e.point)>K.yV;if(t||2!==this.currentLinePoints){if(this.getPhase()===Q.au.CREATING)return this.createNewLine(e),this.addPointToLine(e),void this.setPhase(Q.au.CREATING_NEXT_POINT);t&&this.getPhase()===Q.au.CREATING_NEXT_POINT&&(this.continuous()?(this.updateLastPoint(e),this.addPointToLine(e)):this.finishLine(e))}else{const t={origin:e.point.addScaledVector(e.normal,.05),normal:e.normal},i=this.pointer.getMeshIntersection(t);if(i)if(this.continuous()){this.points.pop();const e=new ConstrainedHit(i,Te.l1.Free);this.addPointToLine(e),this.addPointToLine(e),this.setPhase(Q.au.CREATING_NEXT_POINT)}else this.finishLine(new ConstrainedHit(i,Te.l1.Free))}},this.onMouseMove=()=>{if(this.getPhase()===Q.au.CREATING_NEXT_POINT){const e=this.getIntersection();e&&this.updateLastPoint(e)}},this.onMouseClick=e=>{if(e.button!==ke.MP.PRIMARY||this.getPhase()===Q.au.IDLE)return;const t=this.getIntersection();t&&this.onCreate(t)},this.inputSubscriptions.push(i(Ne.mE,this.onMouseMove),i(Me.R,this.onMouseClick)),this.cancelSubs()}start(){super.start()}stop(){this.getPhase()===Q.au.CREATING_NEXT_POINT&&(this.points.pop(),this.currentLinePoints<3&&this.points.pop()),super.stop()}finishLine(e){this.points.pop(),this.addPointToLine(e),this.setPhase(Q.au.CREATING),this.onDone()}}var Ae=i(30041),Oe=i(90134),ze=i(78626),Ge=i(22767),Ve=i(35825),Ue=i(21265),Qe=i(20599),_e=i(62194);class SnappableAxisUpdater{constructor(e,t,i,s,n){this.pointer=e,this.mobile=t,this.getPhase=i,this.scene=s,this.getLayer=n,this.subscriptions=[],this.editing=!1,this.axisLines=[],this.axisAlignmentHelper=new y.Object3D,this.updateSnapping=e=>{if(this.axisLines.length>0&&(this.pointer.removeSnapFeatures(this,he.AxisAny),this.axisLines.length=0),e){this.axisAlignmentHelper.position.copy(e.point);const t=(0,Y.J2)(this.axisAlignmentHelper,e.point,e.normal);this.axisAlignmentHelper.updateMatrixWorld(!0);const i=this.axisAlignmentHelper.matrixWorld,s=100,n=(e,t,i,n,a,r)=>{const o=new SnapAxisLine3(e.clone().multiplyScalar(s),t.clone().multiplyScalar(s),n,a,r);return o.applyMatrix4(i),o},a=(new y.Matrix4).copyPosition(i);this.axisLines.push(n(J.f.UP,J.f.DOWN,a,e.floorId,e.roomId,he.AxisY)),t||this.axisLines.push(n(J.f.FORWARD,J.f.BACK,i,e.floorId,e.roomId,he.AxisY),n(J.f.UP,J.f.DOWN,i,e.floorId,e.roomId,he.AxisX),n(J.f.LEFT,J.f.RIGHT,i,e.floorId,e.roomId,he.AxisZ)),this.axisLines.length>0&&this.pointer.addSnapFeatures(this,he.AxisAny,this.axisLines)}}}init(){}dispose(){}activate(){this.subscriptions.push(this.pointer.onOriginChanged(this.updateSnapping,!0)),this.axisLineRenderer=new AxisLineRenderer(this.scene,this.getLayer("cursor-mesh"))}deactivate(){this.subscriptions.forEach((e=>e.cancel())),this.subscriptions.length=0,this.pointer.removeSnapFeatures(this,he.AxisAny),this.axisLineRenderer.dispose(),this.axisLineRenderer=null}beforeRender(){const e=this.getPhase(),t=this.mobile?!!Q.Pj.mobile[e]:!!Q.Pj.desktop[e];t!==this.editing&&(this.editing=t,this.axisLineRenderer.clearLines())}render(){this.editing&&this.axisLineRenderer.render(this.pointer.lastIntersection,this.axisLines)}}class AxisLineRenderer{constructor(e,t){this.scene=e,this.layer=t,this.offsetFromMesh=.0075,this.featureColors={[he.AxisX]:Z.x,[he.AxisZ]:Z.z,[he.AxisY]:Z.y},this.axesVisibleInConstraints={[Te.l1.EdgesAndPlanarAxes]:!0,[Te.l1.Axes]:!0,[Te.l1.PlanarAxes]:!0},this.linesActive=[],this.linesFree=[],this.axesVisible=[],this.axisMat=new y.LineBasicMaterial({color:4095,linewidth:1,opacity:.75,transparent:!0,depthWrite:!1,depthTest:!0}),this.render=(e,t)=>{if(e&&this.axesVisibleInConstraints[e.constraint]&&t.length>0){if(t.length!==this.axesVisible.length)this.clearLines();else{this.axesVisible.every(((e,i)=>e.equals(t[i])))||this.clearLines()}if(this.container.parent!==this.scene.scene){for(const e of t){const t=this.getMesh(e);t.material.color.setHex(this.featureColors[e.featureType]),this.container.add(t),this.linesActive.push(t)}this.axesVisible=t.map((e=>e)),this.scene.addChild(d.a.Root,this.container),this.container.position.copy(e.normal).multiplyScalar(this.offsetFromMesh),this.container.updateMatrixWorld(!0)}}else this.clearLines()},this.clearLines=()=>{if(0!==this.linesActive.length){for(;this.linesActive.length>0;){const e=this.linesActive.pop();e&&(this.container.remove(e),this.linesFree.push(e))}this.scene.removeChild(d.a.Root,this.container)}},this.container=new y.Object3D}getMesh(e){let t=this.linesFree.pop();return t?(t.geometry.setFromPoints([e.start,e.end]),t.geometry.verticesNeedUpdate=!0):(t=new LineMesh(e,this.axisMat.clone()),t.layers.mask=this.layer.mask),t}dispose(){for(this.clearLines();this.linesFree.length>0;){const e=this.linesFree.pop();e&&(this.container.remove(e),e.geometry.dispose(),e.material.dispose())}this.linesActive=[],this.linesFree=[],this.container=null}}class LineMesh extends y.Line{constructor(e,t){super(void 0,t),this.material=t,this.geometry=(new y.Geometry).setFromPoints([e.start,e.end])}}var Be,He=i(84496),je=i(43894),Xe=i(17256),qe=i(44333),Ze=i(14567),Ye=i(32400),We=i(51770),$e=i(64341);!function(e){e.LINETYPE_2D="linetype_2D",e.LINETYPE_3D="linetype_3D"}(Be||(Be={}));const Ke={[T.T.FloorplanOnly]:Be.LINETYPE_2D,[T.T.ThreeD]:Be.LINETYPE_3D},Je={[Be.LINETYPE_2D]:T.T.FloorplanOnly,[Be.LINETYPE_3D]:T.T.ThreeD};class MdsMeasurementPointGroupSerializer{serialize(e){if(!e)return null;const t=[],{text:i,visible:s,type:n,floorId:a,roomId:r}=e.info;for(const i of e){const e={position:le.ep.toVisionVector(i)};a&&(e.floorId=a),r&&(e.roomId=r),t.push(e)}const o={enabled:s,label:i,version:"3.2",lineType:Ke[n]||Be.LINETYPE_3D,points:t};return this.validate(o)?o:null}validate(e){return!!e&&!(e.points.length<2)}}var et=i(32020);const tt=new w.Z("mds-measurement-serializer");class MdsMeasurementPointGroupDeserializer{constructor(){this.points=(0,Oe.C)([]),this.grouper=new B.h(this.points)}deserialize(e){if(!e||!Array.isArray(e))return tt.debug("No contents",e),null;this.grouper.reset();for(const t of e)if(this.validate(t)){const e=t.lineType||Be.LINETYPE_3D,i=Je[e],s=this.getModelContextFromPoint(t.points[0]),n=Object.assign(Object.assign({sid:t.id,text:t.label||"",visible:t.enabled,type:i},s),{created:(0,et.p)(t.created),modified:(0,et.p)(t.modified)});this.grouper.startGroup(n),t.points.forEach((e=>this.grouper.push(le.ep.fromVisionVector(e.position))))}else tt.debug("Deserialized invalid Measurement data from MDS",t);return 0===this.grouper.length?null:this.grouper}validate(e){if(!e||"object"!=typeof e)return!1;const t=["id","points"].every((t=>t in e)),i=e.points&&Array.isArray(e.points)&&e.points.length>0,s=t&&i;return s||tt.debug("Invalid MDS.MeasurementPath:",{hasRequiredFields:t,hasPoints:i,data:e}),s}getModelContextFromPoint(e){return{floorId:e.floor&&e.floor.id?e.floor.id:"",roomId:e.room&&e.room.id?e.room.id:""}}}const it=new w.Z("MdsMeasurementModeStore");class MdsMeasurementModeStore extends Ye.u{constructor(){super(...arguments),this.serializer=new MdsMeasurementPointGroupSerializer,this.deserializer=new MdsMeasurementPointGroupDeserializer,this.prefetchKey="data.model.measurementPaths"}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t};return this.query($e.GetMeasurements,i,e).then((e=>{var t,i;if(e.errors&&e.errors.length>0)throw it.error(Object.assign({},e)),new Error("MdsMeasurementModeStore.read failed");return this.deserializer.deserialize(null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.measurementPaths)}))}async create(e){const t=this.getViewId(),i=this.serializer.serialize(e);if(!i)throw new Error("Could not create Measurement");return this.mutate($e.AddMeasurement,{modelId:t,data:i}).then((e=>{if(it.debug(Object.assign({},e)),e.errors&&e.errors.length>0)throw it.error(Object.assign({},e)),new Error("MdsMeasurementModeStore.create failed");return(0,We.qw)(e,"data.addMeasurementPath.id")}))}async update(e){const t=this.getViewId(),i=e.info.sid,s=this.serializer.serialize(e);if(!s)throw new Error("Could not update Measurement");return this.mutate($e.PatchMeasurement,{modelId:t,pathId:i,data:s}).then((e=>{if(it.debug(Object.assign({},e)),e.errors&&e.errors.length>0)throw it.error(Object.assign({},e)),new Error("MdsMeasurementModeStore.update failed")}))}async delete(e){const t=this.getViewId();return this.mutate($e.DeleteMeasurement,{modelId:t,pathId:e}).then((e=>{if(it.debug(Object.assign({},e)),e.errors&&e.errors.length>0)throw it.error(Object.assign({},e)),new Error("MdsMeasurementModeStore.delete failed")}))}}var st=i(18687),nt=i(64614),at=i(43711),rt=i(90601);const ot=new w.Z("measurement-mode");class MeasurementModeModule extends s.Y{constructor(){super(...arguments),this.name="measurement-mode",this.longPressStart=Date.now(),this.threshold=800,this.lineSidToPointMap={},this.mobile=!1,this.cameraAndDragBlocked=!1,this.blockNavigation=()=>!1,this.store=null,this.replaceContents=e=>{this.lineDerivedDataFactory.clear(),this.pointGroups.copy(e)},this.onEdit=e=>{const t=this.data.getGroupInfo(e),i=t&&t.info.sid||null;this.data.editingGroupId!==i&&(this.data.editingGroupId=i,this.colliders.setEditingGroup(e))},this.onEditEnd=()=>{if(this.data.editingGroupId){const e=this.pointGroups.getGroupById(this.data.editingGroupId);e&&(this.mutationRecord.updated.add(e.info.sid),this.save(),this.engine.broadcast(new _e.av(this.buildAnalyticsMessageFromGroup(e))))}this.data.editingGroupId=null,this.colliders.setEditingGroup(void 0)},this.onCreatorAddNewLine=e=>{ot.debug("onCreatorAddNewLine",e),this.data.creatingGroupId=e},this.onCreatorAddPoint=()=>{if(this.data.creatingGroupId){ot.debug("onCreatorAddNewSegment",this.data.creatingGroupId);const e=this.pointGroups.getGroupById(this.data.creatingGroupId);if(e&&e.count>1&&e.length>0){const t=this.buildAnalyticsMessageFromGroup(e);this.engine.broadcast(new _e.rf(Object.assign(Object.assign({},t),{startPosition:this.pointGroups.get(e.startIndex),endPosition:this.pointGroups.get(e.endIndex)})))}}},this.onCreatorStop=()=>{if(this.data.creatingGroupId){const e=this.pointGroups.getGroupById(this.data.creatingGroupId);e&&(e.count>1&&e.hasLength()?(this.engine.broadcast(new _e.u6(Object.assign({},this.buildAnalyticsMessageFromGroup(e)))),this.mutationRecord.added.add(e.info.sid),this.save()):this.engine.broadcast(new _e.ff))}this.data.creatingGroupId=null},this.onToggleMeasurementMode=async(e,t)=>{this.toggleMeasuringMode(e),await this.engine.commandBinder.issueCommand(new U.I(e&&t))},this.onViewmodeChange=()=>{this.getPhase()!==Q.au.CLOSED&&this.stopMeasuring()},this.onSweepChange=()=>{const e=this.getPhase();e!==Q.au.CREATING&&e!==Q.au.CREATING_NEXT_POINT&&this.setSelected(-1)},this.initStorageOnApplicationChange=()=>{this.config.readonly=this.applicationData.application!==C.Mx.WORKSHOP;const e=!this.config.readonly||this.playerOptions.options.measurements_saved;if(this.data.modeActive()&&this.engine.commandBinder.issueCommand(new N.O(!1)),e&&this.store){const e=this.store;this.store=null,e.read().then((t=>{t&&this.replaceContents(t.groups()),this.store=e}))}},this.getPhase=()=>this.data.phase,this.toggleCameraMovement=e=>{e||this.cameraAndDragBlocked?e&&this.cameraAndDragBlocked&&(this.dragInterceptor.cancel(),this.navigation.removeNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!1):(this.dragInterceptor.renew(),this.navigation.addNavigationRule(this.blockNavigation),this.cameraAndDragBlocked=!0)},this.getConstraint=()=>this.settings.tryGetProperty(R.F.MeasurementSnapping,!1)?this.viewmodeData.isFloorplan()?K.xh.floorplan:this.constraint:K.xh.disabled,this.getSelected=()=>this.data.selectedGroupIndex,this.setSelected=e=>{this.data.selectedGroupIndex!==e&&this.data.setSelectedGroupIndex(e)},this.setSelectedById=async e=>{if(null===e)this.setSelected(-1);else{const t=this.pointGroups.getGroupById(e);t&&this.setSelected(t.index)}},this.deleteSelectedMeasurement=()=>{-1!==this.data.selectedGroupIndex&&(this.deleteMeasurement(this.data.selectedGroupIndex),this.setSelected(-1),this.changePhase(Q.au.IDLE),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new c.u(h.C.DEFAULT))))},this.deleteMeasurement=(e,t=!1)=>{const i=this.buildAnalyticsMessage(e);i&&this.engine.broadcast(new _e.$Z(Object.assign(Object.assign({},i),{count:this.pointGroups.groupCount-1})));const s=this.pointGroups.getGroup(e);s&&(this.pointGroups.removeGroup(e),s.info.sid!==this.data.creatingGroupId&&(this.mutationRecord.removed.add(s.info.sid),t||this.save()))},this.deleteMeasurementBySids=async e=>{const t=e.sids;for(const i of t){const t=this.pointGroups.getGroupById(i);if(!t)throw ot.error("Measurement delete failed",Object.assign({},e)),Error("Measurement delete failed, not found");this.deleteMeasurement(t.index,!0)}this.save()},this.onToggleContinuous=()=>{this.stopMeasuring()},this.changePhase=e=>{this.getPhase()!==e&&(ot.debug(`Phase Change: ${Q.au[this.getPhase()]} -> ${Q.au[e]}`),this.previousPhase=this.getPhase(),this.data.setPhase(e))},this.restorePreviousPhase=()=>{this.changePhase(this.previousPhase)},this.buildAnalyticsMessage=e=>{const t=this.pointGroups.getGroup(e);return t&&t.hasLength()?this.buildAnalyticsMessageFromGroup(t):null},this.buildAnalyticsMessageFromGroup=e=>{const t=this.viewmodeData.isFloorplan()?T.T[T.T.FloorplanOnly]:T.T[T.T.ThreeD];return Object.assign(Object.assign({sid:e.info&&e.info.sid?e.info.sid:e.describe(),totalLength:e?e.length:0,segments:e?e.count:0,temporary:!e.info||e.info.sid===e.describe(),viewmode:this.viewmodeData.currentMode,floorId:e.info.floorId,continuous:this.settings.tryGetProperty(R.F.MeasurementContinuousLines,!1)},this.getAnalyticsForConstraints()),{type:t})},this.getAnalyticsForConstraints=()=>{const e=this.pointer.lastIntersection;if(e){const t=e.featureType,i=e.constraint;return{featureType:void 0!==t?he[t]:"None",constraint:Te.l1[i]}}return null},this.toggleMeasuringMode=e=>{ot.debug("toggleMeasuringMode",e);e!==(this.getPhase()!==Q.au.CLOSED)&&(e?(this.engine.toggleRendering(this,!0),this.changePhase(Q.au.IDLE),this.editor.activate(),this.lineStyler.activate(),this.colliders.activate(),this.renderer.activate(),this.textRenderer.activate(),this.scene.addChild(d.a.Root,this.textRenderer.container),this.engine.broadcast(new _e.$n(!0,this.viewmodeData.currentMode,this.pointGroups.groupCount)),this.pointer.preload()):(this.engine.toggleRendering(this,!1),this.stopMeasuring(),this.changePhase(Q.au.CLOSED),this.toggleCameraMovement(!0),this.editor.deactivate(),this.lineStyler.deactivate(),this.colliders.deactivate(),this.renderer.deactivate(),this.textRenderer.deactivate(),this.scene.removeChild(d.a.Root,this.textRenderer.container),this.engine.broadcast(new _e.$n(!1,this.viewmodeData.currentMode,this.pointGroups.groupCount))))},this.startMeasuring=()=>{this.mobile||(this.navigation.addNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new c.u(h.C.XHAIR))),this.creator.start()},this.stopMeasuring=()=>{const e=this.isMeasurementComplete(this.data.selectedGroupIndex);this.isCreating()&&!e&&this.deleteSelectedMeasurement(),this.creator.stop(),this.mobile||(this.navigation.removeNavigationRule(this.blockNavigation),this.engine.commandBinder.issueCommand(new c.u(h.C.DEFAULT)))},this.setupIntersectionVisuals=(e,t,i,s,n,a,r,o,d)=>{t.addVisibilityRule((()=>{const e=this.getPhase();return!(!r&&e===Q.au.CREATING||e===Q.au.CONFIRMING_POINT||e===Q.au.CREATING_NEXT_POINT||e===Q.au.EDITING)}));const l={cameraData:n,playerCamera:s.camera,scene:s};return new IntersectionVisualizer(r,this.getPhase,a,l,e,o,(()=>i.chunks),d.isFloorplan)},this.mutationRecord={[nt.KI.added]:new Set,[nt.KI.updated]:new Set,[nt.KI.removed]:new Set},this.clearMutationRecord=()=>{for(const e of Object.values(this.mutationRecord))e.clear()},this.renameMeasurement=async e=>{const t=this.pointGroups.getGroupById(e.sid);if(!t)throw ot.error("Measurement rename failed",Object.assign({},e)),Error("Measurement rename failed, not found");const i=void 0!==e.text&&e.text.length<=24;if(!t||!i)throw ot.error("Measurement text invalid, text must be between 0 and 24 charachters in length.",Object.assign({},e)),new Error("Measurement text invalid");{const i=""===t.info.text&&e.text.length>0,s=!i&&t.info.text!==e.text;this.pointGroups.updateGroupInfo(t.index,Object.assign(Object.assign({},t.info),{text:e.text})),this.mutationRecord.updated.add(t.info.sid),this.save(),i&&this.engine.broadcast(new _e.ty(e.sid,e.text)),s&&this.engine.broadcast(new _e.mM(e.sid,t.info.text,e.text))}},this.onChangeVisibility=async e=>{for(const t of e.sids){const i=this.pointGroups.getGroupById(t);if(!i)throw ot.error("Measurement visibility toggle failed",Object.assign(Object.assign({},e),{group:i})),new Error("Measurement visibility toggle failed, not found");{this.pointGroups.updateGroupInfo(i.index,Object.assign(Object.assign({},i.info),{visible:e.visible})),this.mutationRecord.updated.add(i.info.sid);const t=this.buildAnalyticsMessage(i.index);t&&this.engine.broadcast(new _e.av(t))}}this.save()}}async init(e,t){this.config=e,this.mobile=(0,Ue.tq)(),this.engine=t;const[i,s,d,h,m,w,y,S,T,D]=await Promise.all([t.getModule(n.default),t.getModule(a.default),t.getModule(r.default),t.getModule(l.default),t.getModule(o.default),t.market.waitForData(f.c),t.market.waitForData(g.M_),t.market.waitForData(v.O),t.market.waitForData(E.Z),t.market.waitForData(st.Z)]);this.settings=await t.market.waitForData(k.e),this.playerOptions=await t.market.waitForData(I.af),this.scene=i.getScene(),this.viewmodeData=S,this.floorsViewData=w,this.roomData=D,this.input=d,this.navigation=await t.getModule(He.default);const P=await t.getModule(je.F);this.lineDerivedDataFactory=new LineDerivedDataFactory(y,S,w,(()=>!!T.currentSweep&&T.isSweepAligned(T.currentSweep)),(()=>this.settings.tryGetProperty(R.F.UnitType,I.Mc.USFractional)),(()=>!0));const b=t.claimRenderLayer(this.name);this.data=new _.X,t.market.register(this,_.X,this.data);const M=(0,Oe.C)([]);this.pointGroups=new B.h(M);const U=(e,t,i=!1)=>q(M,e).createSubscription(t,i);this.dataSubscription=U(x.ALL,(()=>{this.data.repopulate(this.pointGroups.groups()),this.data.commit()}),!0),this.applicationData=await t.market.waitForData(C.pu),this.config.storageProvider===Xe.Xq.MDS&&(this.store=this.configureStorage(),this.initStorageOnApplicationChange()),this.constraint=this.mobile?K.xh.mobile:K.xh.desktop,this.pointer=new SnappablePointer(m,this.getConstraint,this.mobile,this.floorsViewData,this.viewmodeData);const H=new SnappablePointUpdater(this.pointGroups,U,this.pointer,(()=>{const e=this.settings.tryGetProperty(R.F.MeasurementContinuousLines,!1),t=this.getPhase()===Q.au.CREATING||this.getPhase()===Q.au.CREATING_NEXT_POINT||this.previousPhase===Q.au.CREATING_NEXT_POINT&&this.getPhase()===Q.au.EDITING;return e&&this.mobile&&t}));t.addComponent(this,H);const j=new SnappableAxisUpdater(this.pointer,this.mobile,this.getPhase,this.scene,t.getRenderLayer);t.addComponent(this,j),this.creator=this.instantiateCreator(y);const X=(e,t,i)=>{const s=this.pointGroups.getGroup(e),n=s.describe(i);this.lineSidToPointMap[n]=i;const a=this.lineDerivedDataFactory.get(n);return this.lineDerivedDataFactory.make(n,(()=>({start_position:this.pointGroups.get(t),end_position:this.pointGroups.get(i),visible:s.info.visible,floorId:s.info.floorId,roomId:s.info.roomId,type:s.info.type,text:this.pointGroups.isStartIndex(t)?s.info.text:""})),a)};this.renderer=new MeasurementLineRenderer(this.pointGroups,U,y,h,b,t.claimRenderLayer("measure-lines"),this.getSelected,X),await t.addComponent(this,this.renderer);const Z=new Ae.u({color:"black",background:!0,backgroundColor:"#ffffff"});this.textRenderer=new MeasurementLabelRenderer(this.pointGroups,U,y,b,Qe.z.labels,Z,X),await t.addComponent(this,this.textRenderer),this.textRenderer.deactivate(),this.editor=new MeasurementJointEditor(this.pointGroups,d,this.pointer,this.getPhase,this.onEdit,this.onEditEnd);this.colliders=new MeasurementInput(this.pointGroups,this.input,y,this.mobile,(e=>{this.engine.commandBinder.issueCommand(new c.u(e))}),this.getPhase,this.changePhase,this.restorePreviousPhase,this.setSelected,this.getSelected,this.onEdit,this.onEditEnd),this.lineStyler=new MeasurementLineStyler(this.renderer.lines,this.renderer.getLinesForPoint,this.renderer.dottedMaterial,U,this.input,this.getPhase,this.getSelected);const[Y,W]=await Promise.all([t.getModule(u.default),t.getModule(p.default)]),$=this.setupIntersectionVisuals(s,Y,W.mesh,this.scene,y,this.pointer,this.mobile,t.getRenderLayer,this.viewmodeData);t.addComponent(this,$),this.dragInterceptor=this.input.registerPriorityHandler(xe._t,ue.S,(()=>!0)),this.dragInterceptor.cancel(),this.mobile||this.bindings.push(...this.hotkeys()),this.bindings.push(this.applicationData.onPropertyChanged("application",this.initStorageOnApplicationChange),S.makeModeChangeSubscription(this.onViewmodeChange),T.makeSweepChangeSubscription(this.onSweepChange),t.commandBinder.addBinding(N.O,(async e=>this.onToggleMeasurementMode(e.on,e.dimWhileActive))),t.commandBinder.addBinding(L.c,(async()=>this.startMeasuring())),t.commandBinder.addBinding(F.v,(async e=>this.setSelected(e.index))),t.commandBinder.addBinding(A.B,(async()=>this.stopMeasuring())),t.commandBinder.addBinding(O.Ev,(async()=>this.deleteSelectedMeasurement())),t.commandBinder.addBinding(O.Tn,(async e=>this.deleteMeasurement(e.index))),t.commandBinder.addBinding(F.t,(async e=>this.setSelectedById(e.sid))),t.commandBinder.addBinding(z.W,this.onChangeVisibility),t.commandBinder.addBinding(G.R,this.renameMeasurement),t.commandBinder.addBinding(O.JM,this.deleteMeasurementBySids),t.commandBinder.addBinding(V.d,(async e=>this.replaceContents(e.points.groups()))),this.dataSubscription,this.settings.onPropertyChanged(R.F.MeasurementContinuousLines,(()=>this.onToggleContinuous())),P.onSave((()=>this.saveDiff()),{dataType:Xe.g.MEASUREMENTS})),t.toggleRendering(this,!1),this.registerDebugSettings()}isCreating(){const e=this.getPhase();return e===Q.au.CREATING||e===Q.au.CREATING_NEXT_POINT}setConstraintStyle(e){ot.debug("setConstraintStyle:",Te.l1[e]),this.constraint=e}isMeasurementComplete(e){if(-1===e||!this.isCreating())return!0;const t=this.getPhase(),i=this.pointGroups.getGroup(e);return this.settings.tryGetProperty(R.F.MeasurementContinuousLines,!1)?i.count>2&&t===Q.au.CREATING_NEXT_POINT:i.count>=2&&t===Q.au.CREATING}hotkeys(){return[this.input.registerHandler(ze.e,(e=>{if(e.state===Ge.M.PRESSED)switch(e.key){case Ve.R.ESCAPE:this.getPhase()===Q.au.CONFIRMING_POINT?(this.creator.stop(),this.creator.start(),this.changePhase(Q.au.CREATING)):this.isCreating()?this.stopMeasuring():this.applicationData.application!==C.Mx.WORKSHOP&&this.getPhase()!==Q.au.CLOSED&&this.engine.commandBinder.issueCommand(new at.tT(rt.w1.MEASUREMENTS,!1));break;case Ve.R.BACKSPACE:case Ve.R.DELETE:this.getPhase()!==Q.au.CLOSED&&this.getPhase()!==Q.au.EDITING&&this.deleteSelectedMeasurement();break;case Ve.R.RETURN:const e=this.pointGroups.groupCount-1;this.isMeasurementComplete(e)&&this.stopMeasuring()}})),this.input.registerHandler(ze.e,(e=>{if(e.key===Ve.R.SHIFT||e.key===Ve.R.ALT){const{altKey:t,shiftKey:i}=e.modifiers,s=i&&t?K.xh.shiftAlt:t?K.xh.alt:i?K.xh.shift:K.xh.desktop;this.setConstraintStyle(s)}}))]}onUpdate(e){if(this.getPhase()===Q.au.CLOSED)return;const t=this.data.selectedGroupIndex,i=this.mobile?Q.Ph.mobile[this.getPhase()]:Q.Ph.desktop[this.getPhase()];for(const s in this.lineSidToPointMap){const n=this.lineDerivedDataFactory.get(s);if(n){n.opacity.tick(e);const a=this.lineSidToPointMap[s],r=this.pointGroups.groupFromPointIndex(a),o=r===t&&n.visible?1:n.opacity.value,d=i&&!n.labelVisible?0:o;this.textRenderer.setTextOpacityByPoint(a,d),this.renderer.setLineOpacityByPoint(a,o),-1!==r&&this.colliders.setGroupVisible(r,o>0)}}if(this.mobile)if(this.getPhase()===Q.au.CONFIRMING_POINT){const e=(Date.now()-this.longPressStart)/this.threshold;e<=1&&this.data.setPressProgress(e)}else if(this.getPhase()===Q.au.CREATING&&0!==this.data.pressProgress){const e=0;this.data.setPressProgress(e)}}dispose(e){this.stopMeasuring(),this.engine.commandBinder.issueCommand(new N.O(!1)),this.colliders.dispose(),this.textRenderer.dispose(),this.renderer.dispose(),e.disposeRenderLayer(this.name),super.dispose(e)}async save(){return this.engine.commandBinder.issueCommand(new qe.VQ({dataTypes:[Xe.g.MEASUREMENTS]}))}async saveDiff(){if(this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged(),this.config.readonly||!this.store)return void this.clearMutationRecord();const e=this.mutationRecord,t=[];ot.debug("MDS mutation ops:",`{\n      added: '${[...e.added.keys()]}',\n      updated: '${[...e.updated.keys()]}',\n      removed: '${[...e.removed.keys()]}',\n    }`);for(const i of e[nt.KI.removed]){if(e[nt.KI.added].has(i))e[nt.KI.added].delete(i);else{const e=this.store.delete(i);t.push(e)}e[nt.KI.updated].delete(i)}for(const i of e[nt.KI.added]){const s=this.pointGroups.getGroupById(i);if(s){const e=this.store.create(s).then((e=>{e&&(ot.debug(`Updating group id for new path: ${s.info.sid} -> ${e}`),this.pointGroups.updateGroupInfo(s.index,Object.assign(Object.assign({},s.info),{sid:e}))),this.data.repopulate(this.pointGroups.groups()),this.data.commit(),this.data.notifyDataChanged()}));t.push(e)}e[nt.KI.updated].delete(i)}for(const i of e[nt.KI.updated]){const e=this.pointGroups.getGroupById(i),s=this.store.update(e);t.push(s)}return this.clearMutationRecord(),Promise.all(t)}configureStorage(){const{readonly:e,storageProvider:t,baseUrl:i}=this.config;if(t===Xe.Xq.MDS){ot.info(`Loading Measurements from ${t}`);const s=new MdsMeasurementModeStore({readonly:e,includeDisabled:!e,baseUrl:i});return this.engine.market.waitForData(Ze.Q).then((e=>{e.setRevertable(Xe.g.MEASUREMENTS)})),s}return null}async registerDebugSettings(){const e=await this.engine.getModule(m.default);e.registerMenuEntry({header:"Measurement Debug",setting:"measure/fp_in_dh",initialValue:()=>!1,onChange:t=>(this.lineDerivedDataFactory.setDollhouseLineStyle(t?T.T.FloorplanOnly:T.T.ThreeD),e.updateSetting("measure/fp_in_dh",t))})}instantiateCreator(e){let t;if(this.mobile){const i=(e,t)=>{this.longPressStart=e,this.threshold=t},s=t=>{const i=(0,$.q9)(e,t.point);this.data.setPointPosition(i.screenPosition)};t=new MeasurementCreatorMobile(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,i,s,this.toggleCameraMovement,this.getPhase,(()=>this.settings.tryGetProperty(R.F.MeasurementContinuousLines,!1)),this.viewmodeData.isFloorplan,this.floorsViewData.getHighestVisibleFloorId,(()=>this.roomData.selected.value))}else t=new MeasurementCreatorDesktop(this.pointGroups,this.setSelected,this.input.registerUnfilteredHandler,this.pointer,this.changePhase,this.getPhase,this.viewmodeData.isFloorplan,this.floorsViewData.getHighestVisibleFloorId,(()=>this.roomData.selected.value),(()=>this.settings.tryGetProperty(R.F.MeasurementContinuousLines,!1)));return t.onGroupCreated=this.onCreatorAddNewLine,t.onGroupAddPoint=this.onCreatorAddPoint,t.onEdit=this.onEdit,t.onDone=this.onCreatorStop,t}}const dt=MeasurementModeModule},10594:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ScanInfoDataModule});var s=i(54122),n=i(25799),a=i(17256),r=i(51770);class ScanData{}var o=i(78909);class ScanCameraInfo extends o.T{equals(e){return this.id===e.id}copy(e){return this.id=e.id,this.name=e.name,this.vendor=e.vendor,this.model=e.model,this.captureMode=e.captureMode,this.depthCameraType=e.depthCameraType,this.cameraTypes=e.cameraTypes.slice(),this.sensorSerialNumbers=e.sensorSerialNumbers.slice(),this.serialNumber=e.serialNumber,this.mountCalibrationVersion=e.mountCalibrationVersion,this.softwareVersion=e.softwareVersion,this}}class ScanInfo extends o.T{constructor(e){super(),e&&(e.id&&(this.id=e.id),void 0!==e.index&&(this.index=e.index),this.name=e.name||"",this.created=e.created||"",this.alignment=e.alignment||"",this.options=e.options||[],this.camera=e.camera||new ScanCameraInfo)}equals(e){return this.id===e.id}copy(e){return this.id=e.id,this.index=e.index,this.name=e.name,this.created=e.created,this.alignment=e.alignment,this.options=e.options.slice(),this.camera=(new ScanCameraInfo).copy(e.camera),this}}const d=new n.Z("mds-scaninfo-serializer");class MdsScanInfoDeserializer{deserialize(e){if(!e||!this.validate(e))return d.debug("Deserialized invalid ScanInfo data from MDS",e),null;const t=e,i=new ScanInfo;i.id=t.id,i.anchorId=t.anchor&&t.anchor.id||"",i.index=t.index||-1,i.name=t.name||"",i.created=t.created||"",i.alignment=t.alignment||"",i.url=t.url||"",i.timeOfDay=t.timeOfDay||"",i.options=t.options||[];const s=t.camera;return i.camera=new ScanCameraInfo,i.camera.id=s&&s.id||"",i.camera.name=s&&s.name||"",i.camera.vendor=s&&s.vendor||"",i.camera.model=s&&s.model||"",i.camera.captureMode=s&&s.captureMode||"",i.camera.depthCameraType=s&&s.depthCameraType||"",i.camera.cameraTypes=s&&s.cameraTypes||[],i.camera.sensorSerialNumbers=s&&s.sensorSerialNumbers||[],i.camera.serialNumber=s&&s.serialNumber||"",i.camera.mountCalibrationVersion=s?s.mountCalibrationVersion:void 0,i.camera.softwareVersion=s&&s.softwareVersion||"",i}validate(e){if(!e)return!1;return["id"].every((t=>t in e))}}var l=i(32400),h=i(12757);class MdsScanInfoStore extends l.u{constructor(){super(...arguments),this.deserializer=new MdsScanInfoDeserializer}async fetch(){const e=this.getViewId();return this.query(h.GetScans,{modelId:e},{fetchPolicy:"no-cache"}).then((e=>{const t=(0,r.qw)(e,"data.model.assets.scans"),i={},s={};for(const e of t){const t=this.deserializer.deserialize(e);t&&(i[t.id]=t,t.anchorId&&(s[t.anchorId]=t))}const n=new ScanData;return n.scansById=i,n.scansByAnchor=s,n}))}async read(){return this.scans||(this.scans=this.fetch()),this.scans}async refresh(){return this.scans=this.fetch(),this.scans}}var c=i(83852);class EmptyScanInfoStore{async create(...e){throw new c.n}async update(...e){throw new c.n}async delete(...e){throw new c.n}async read(){const e=new ScanData;return e.scansById={},e.scansByAnchor={},Promise.resolve(e)}async refresh(){return this.read()}}const u=new n.Z("scaninfo-module");class ScanInfoDataModule extends s.Y{constructor(){super(...arguments),this.name="scaninfo-data",this.getScanInfo=e=>this.store.read().then((t=>t?t.scansByAnchor[e]:void 0)),this.getScanDownloadURL=e=>this.store.refresh().then((t=>{if(t){const i=t.scansByAnchor[e];return i?i.url:void 0}}))}async init(e){this.store=this.getStore(e)}getStore(e){const t=e.storageProvider||a.Xq.JSONSTORE;return u.info(`Loading Scan Info from ${t}`),t===a.Xq.MDS?new MdsScanInfoStore:new EmptyScanInfoStore}}},86450:(e,t,i)=>{"use strict";i.d(t,{D:()=>TilingOverrideWindowSizeCommand,F:()=>TilingSetNavPanoSizeCommand});var s=i(99681);class TilingOverrideWindowSizeCommand extends s.m{constructor(e){super(),this.id="ALLOW_HIGH_RES",this.payload={ignoreWindowSize:e}}}class TilingSetNavPanoSizeCommand extends s.m{constructor(e){super(),this.id="SET_NAV_PANO_SIZE",this.payload={navSize:e}}}},84564:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SweepPanoTiling});var s=i(28281),n=i(80384),a=i(17617);class TilingError extends a.y{constructor(e){super(e),this.name="PanoTilingError"}}var r=i(25799),o=i(2212),d=i(99774),l=i(27829);var h;!function(e){e[e.PreOrder=0]="PreOrder",e[e.PostOrder=1]="PostOrder"}(h||(h={}));class TreeNode{constructor(e,t){this.tree=e,this.parent=t,this.children=[],this.id=++TreeNode._id,this.extra={},this.level=-1}}TreeNode._id=0;class TileTree{constructor(e,t){this.levels=t,this.tileSize=e,this.root=null,this.allNodes=[],p(this)}getSizeForLevel(e,t){return Math.pow(2,t)*e}getSubNode(e,t,i){(!t||e<this.tileSize)&&(t=0),(!i||e<this.tileSize)&&(i=0),e<this.tileSize&&(e=this.tileSize);const s=c(this.tileSize,e);return g(this.root,0,s,t,i)}deleteAllNodes(){this.depthFirst(function(e,t,i,s,n){for(let t=0;t<e.children.length;t++){const i=e.children[t];i&&(i.parent=null,i.tree=null),e.children[t]=null}e.children.length=0}.bind(this),null,h.PostOrder);for(let e=0;e<this.allNodes.length;e++){const t=this.allNodes[e];t&&(t.parent=null,t.tree=null),this.allNodes[e]=null}this.allNodes.length=0,this.root=null}breadthFirst(e){const t=!!(e=e||{}).nullLevelEnd,i=e.maxLevel,s=e.minLevel,n=e.callback,a=e.saveVisited,r=[],o=new TreeNode(this,null);let d=0;if(this.root)for(r.push(this.root),r.push(o);r.length>0&&!(i&&d>i);){const e=r.shift();if(e)if(e===o)(!s||d>=s)&&(n&&t&&n(),a&&t&&a.push(null)),r.length>0&&r.push(o),d++;else{if(e.children)for(const t of e.children)t&&r.push(t);const t=this.getFaceIndexFromNode(e);(!s||d>=s)&&(n&&n(e,d,t),a&&a.push(e))}}}getFaceIndexFromNode(e){if(!e)return-1;let t=1,i=e,s=0,n=0;for(;;){const e=i.parent;if(!e)break;let a=-1;for(let t=0;t<e.children.length;t++)e.children[t]===i&&(a=t);s=a%2*t+s,n=Math.floor(a/2)*t+n,t*=2,i=e}return n*t+s}depthFirst(e,t,i){u(this.root,0,0,0,e,t,i,this.tileSize)}}const c=function(e,t){let i=0;for(t<e&&(t=e);!((t/=2)<e);)i++;return i},u=function(e,t,i,s,n,a,r,o){if(!e)return;const d=2*s+i;if((r=r||h.PreOrder)===h.PreOrder&&(n&&n(e,t,d,i,s),a&&a.push(e)),!e.children||0===e.children.length)return;const l=2*s,c=2*i;for(let i=0;i<2;i++)for(let s=0;s<2;s++)u(e.children[2*s+i],t+1,c+i,l+s,n,a,r,o);r===h.PostOrder&&(n&&n(e,t,d,i,s),a&&a.push(e))},p=e=>{e.root=m(e,null,0)},m=(e,t,i)=>{if(i>e.levels)return null;const s=new TreeNode(e,t);s.level=i,e.allNodes.push(s);for(let t=0;t<4;t++){const n=m(e,s,i+1);n&&(s.children[t]=n)}return s},g=(e,t,i,s,n)=>{if(!e)return null;if(0===i)return e;{if(!e.children||0===e.children.length)return null;const a=Math.pow(2,i)/2,r=s%a,o=n%a,d=2*Math.floor(n/a)+Math.floor(s/a),l=e.children[d];return g(l,t+1,i-1,r,o)}};var f,v=i(13338),w=i(73732),y=i(84559),S=i(41446),T=i(87131),D=i(67569),P=i(20134);!function(e){e[e.Base=0]="Base",e[e.Remaining=1]="Remaining"}(f||(f={}));class TileUploadQueue{constructor(){this.forceQueue=[],this.uploadQueues={},this.panoLODDescriptors={}}addToForceQueue(e){this.forceQueue.push(e)}addToPanoQueue(e,t){this.getUploadQueueForPano(e).push(t)}insertSortedIntoPanoQueue(e,t,i){const s=this.getUploadQueueForPano(t.id);P.at.insertSortedPanoTile(s,e,t,i)}sortQueue(e,t){const i=this.getUploadQueueForPano(e.id);P.at.sortTiles(i,e,t)}getUploadQueueForPano(e){let t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}hasQueuedTiles(){if(this.forceQueue.length>0)return!0;for(const e in this.uploadQueues){const t=this.getUploadQueueForSweep(e);if(t&&t.length>0)return!0}return!1}getUploadQueueForSweep(e){let t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}getTopUploadQueue(e){let t=null;for(let i=f.Base;i<=f.Remaining;i++)for(const s of e)if(t=this.getUploadQueueForSweep(s.id),t.length>0)switch(i){case f.Base:if(0===t[0].level)return t;break;case f.Remaining:return t}return null}processNextQueueItem(e){const t=e.shift();return t?(t.uploadQueued=!1,t):null}getNextFromUploadQueue(e){if(this.forceQueue.length>0)return this.processNextQueueItem(this.forceQueue);const t=this.getTopUploadQueue(e);return t&&t.length>0?this.processNextQueueItem(t):null}peekNextFromUploadQueue(e){if(this.forceQueue.length>0)return this.forceQueue[0];const t=this.getTopUploadQueue(e);return t&&t.length>0?t[0]:null}clearAllQueuedUploads(){this.clearAllUploadQueues(null,0)}clearAllUploadQueues(e,t=0){if(e)this.clearUploadQueue(this.getUploadQueueForSweep(e),t),this.clearUploadQueue(this.forceQueue,t,e);else{for(const e in this.uploadQueues)this.clearUploadQueue(this.getUploadQueueForSweep(e),t);this.clearUploadQueue(this.forceQueue,t)}}clearUploadQueue(e,t=0,i){let s=0;for(;s<e.length;){const n=e[s];(!i||i&&i===n.sweepId)&&n.level>=t?(n.uploadQueued=!1,e.splice(s,1)):s++}}resetPanoLODDescriptors(e){const t=this.getPanoLODDescriptors(e);for(const e in t)if(t.hasOwnProperty(e)){const i=t[e];i.uploadCount=0,i.uploadAttempts=0}}getPanoLODDescriptor(e,t){const i=this.getPanoLODDescriptors(e);let s=i[t];return s||(s={uploadCount:0,uploadAttempts:0},i[t]=s),s}getPanoLODDescriptors(e){let t=this.panoLODDescriptors[e];return t||(t={},this.panoLODDescriptors[e]=t),t}}var b=i(7922),M=i(62367),x=i(26199),k=i(82209);const I=new r.Z("tiles"),R=s.Xd.uploadIntervalDelay;class TiledPanoRenderer extends w.Z{constructor(e,t,i,s,n,a,r,l){super(e,n.getSweepList()),this.cwfRenderer=t,this.panoQualityManager=i,this.tileDownloader=s,this.sweepData=n,this.cameraData=a,this.tilingSettings=r,this.broadcast=l,this.persistentStorage=new D.a,this.activeSweeps=[],this.sweepLoadHistory=[],this.activeRenderTargetDescriptors={},this.panoLoadPromises={},this.panoLoadResolvers={},this.panoLoadTimers={},this.tileTrees={},this.tileDirectory={},this.zoomSweepRenderingDisabled=!1,this.zoomingActive=!1,this.zoomSweepId=null,this.usingTileOverlay=!1,this.overlayTilesLoaded=!1,this.overlayTileBase=null,this.overlayTilesBasic={},this.overlayTilesEnhanced={},this.tileUploadQueue=new TileUploadQueue,this.currentState={direction:new o.Vector3,position:new o.Vector3,rotation:new o.Quaternion},this.renderTargetPool=new d.L(this.rtCompare),this.tileDownloader.setModel(this.sweepListMap),this.tileDownloader.setLoadCallbacks(this.onTileDownLoaded.bind(this))}activate(e){this.engine=e}rtCompare(e,t){return e.object.height===t.size&&e.object.width===t.size}getActivePanos(){const e=[];for(const t of Object.keys(this.activeRenderTargetDescriptors)){this.activeRenderTargetDescriptors[t]&&e.push(t)}return e}init(){super.init(),this.loadOverlayTiles()}highResRenderTarget(e,t){if(e){if(!t)throw new TilingError("Cannot activate zooming without sweepId!");this.zoomingActive=!0,this.zoomSweepId=t,this.copyTargetToZoom(t)}else this.zoomingActive=!1,this.zoomSweepId=null;if(t){const e=this.getRenderTargetDescriptorForSweep(t);if(!e)throw new TilingError("Zooming at a null render target!");const i=this.zoomingActive?this.zoomRenderTarget:e.object,s=i.width;this.broadcast(new b.Z(s,t,i))}}getCurrentPanoResolution(){const e=this.zoomingActive?this.panoQualityManager.getZoomPanoSize():this.panoQualityManager.getNavPanoSize();return y.Z.getPanoSizeClass(e)}beforeRender(){const e=this.sweepData.currentSweep,t=this.sweepData.transition.to;this.updateState(this.cameraData.pose.position,this.cameraData.pose.rotation,e,t),this.updateUploadQueueProcessing()}activateSweep(e){const t=this.sweepListMap.get(e);if(!t)throw I.error(e,t),new TilingError("Invalid sweepId passed to TiledPanORenderer.activate()");let i=this.panoLoadPromises[e];return i||(this.panoLoadTimers[e]=window.setTimeout((()=>{this.engine.broadcast(new k.Z_(!0))}),s.Xd.loadIndicatorDelay),i=new Promise(((i,s)=>{this.panoLoadResolvers[e]=i,this.updateSweepState(e),this.activatePano(t),this.queueUploadForAllTiles(e,!0),this.tileDownloader.forceQueueTiles(t,y.Z.getPanoSize(T.SL.BASE),this.currentState.direction,!0)})),this.panoLoadPromises[e]=i),super.activateSweep(e),i}useTexture(e){const t=this.getRenderTargetDescriptorForSweep(e);if(!t)throw I.error(e),Error("Texture for sweep not activated before using");const i=t.object.texture;return super.useTexture(e),this.freeUnusedTextures(),this.zoomingActive?this.zoomRenderTarget.texture:i}freeTexture(e,t=!1){super.freeTexture(e,t),0===this.textureUsageCounter[e]&&(this.panoLoadPromises[e]=null,this.deactivatePano(e))}freeAllTextures(e=[]){const t=(0,M.ow)(e),i=this.getActivePanos();for(const e of i)t[e]||this.freeTexture(e,!0)}enableUltraHighQualityMode(e){this.setupZoomRenderTarget(),this.zoomSweepId&&this.broadcast(new b.Z(this.zoomRenderTarget.width,this.zoomSweepId,this.zoomRenderTarget))}resetRenderStatus(e,t,i,s){let n;s&&(n=c(v.I_,s)+1);const a=(e,s,n,a)=>{i&&(s.extra.tile.zoomUploaded=!1),t&&(s.extra.tile.uploaded=!1)};for(let t=0;t<v.Hq;t++){this.getTileTree(e,t).breadthFirst({callback:a.bind(this,t),minLevel:n})}}copyBaseRenderStatusToZoomed(e){const t=c(v.I_,this.panoQualityManager.getNavPanoSize()),i=(e,t,i,s)=>{t.extra.tile.zoomUploaded=t.extra.tile.uploaded,t.extra.zoomCovered=t.extra.covered};for(let s=0;s<v.Hq;s++){this.getTileTree(e,s).breadthFirst({callback:i.bind(this,s),maxLevel:t})}}renderPanoTiles(e,t,i,s){const n=[];this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize()||this.zoomSweepRenderingDisabled||this.setupZoomRenderTarget(),t=t||this.currentState.direction||l.f.FORWARD;const a=this.getRenderTargetDescriptorForSweep(e);if(!this.isRenderTargetDescriptorValid(a))throw new TilingError("PanoRenderer.renderPanoTiles() -> Cannot render to a pano that is not activated.");for(let t=0;t<v.Hq;t++){const a=this.getTileTree(e,t);n.length=0,a.breadthFirst({saveVisited:n});for(let e=0;e<n.length;e++){const t=n[e];this.queueUploadForTile(t.extra.tile,!1,s||0===e&&i)}}}clearAllQueuedUploads(){this.tileUploadQueue.clearAllUploadQueues(null,0)}clearAllQueuedUploadsForPano(e){this.tileUploadQueue.clearAllUploadQueues(e,0)}updateState(e,t,i,s){const n=s||i||this.currentState.sweepId,a=n?this.sweepListMap.get(n):null;this.updatePositionState(e),this.updateRotationState(t),n&&this.updateSweepState(n),a&&this.tileDownloader.tilePrioritizer&&this.tileDownloader.tilePrioritizer.updateCriteria(a,e,this.currentState.direction,this.currentState.rotation)}updatePositionState(e){this.currentState.position.copy(e)}updateRotationState(e){if(this.currentState.rotation.copy(e),this.currentState.direction.copy(l.f.FORWARD).applyQuaternion(e),this.tileUploadQueue.hasQueuedTiles())for(const e of this.activeSweeps)this.tileUploadQueue.sortQueue(e,this.currentState.direction)}updateSweepState(e){this.currentState.sweepId=e}activatePano(e){this.tileUploadQueue.clearAllQueuedUploads();const t=this.panoQualityManager.getMaxPossiblePanoSize();for(let i=0;i<v.Hq;i++)this.initTileTree(e.id,i,t);this.linkAllTilesAndNodes(e);let i=this.getRenderTargetDescriptorForSweep(e.id);if(!i){const t=this.panoQualityManager.getNavPanoSize();if(i=this.renderTargetPool.get({size:t}),!i){const e=this.cwfRenderer.initRenderTargetCube(t);i=this.renderTargetPool.add(e),i.extra={},i.extra.size=e.width}i.extra.sweep=e,i.extra.sweepindex=e.index,this.setRenderTargetDescriptorForSweep(e.id,i),this.tileUploadQueue.resetPanoLODDescriptors(e.id),this.resetUploadState(e.id,!0,!0)}return this.updateActiveSweeps(e),i.object}deactivatePano(e){const t=this.getRenderTargetDescriptorForSweep(e);t&&this.isRenderTargetDescriptorValid(t)&&(this.renderTargetPool.free(t.object),this.setRenderTargetDescriptorForSweep(e,null),this.updateActiveSweeps(),this.tileUploadQueue.clearAllUploadQueues(e),this.tileUploadQueue.resetPanoLODDescriptors(e),this.clearCachedTileData())}clearCachedTileData(){for(let e=this.sweepLoadHistory.length-1;e>=0;e--){let t=!1;const i=this.sweepLoadHistory[e];if(i){for(const e of this.activeSweeps)if(i===e.id){t=!0;break}!t&&this.checkTileTreeInitialized(i)&&(this.clearTileState(i,!0,!0),this.deleteTileTrees(i),this.deleteTileDirectoryEntries(i),this.tileDownloader.deleteAllTileDownloadDescriptors(i),this.sweepLoadHistory[e]=null)}}this.updateSweepLoadHistory()}updateActiveSweeps(e){const t=this.persistentStorage.getArray("updateActiveSweeps:tempSweeps");t.length=0;for(const i of this.activeSweeps){const s=this.getRenderTargetDescriptorForSweep(i.id);e&&i.id===e.id||!this.isRenderTargetDescriptorValid(s)||t.push(i)}e&&t.unshift(e),this.activeSweeps.length=0,this.activeSweeps.push(...t)}queueUploadForAllTiles(e,t=!0){this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize()||this.zoomSweepRenderingDisabled||this.setupZoomRenderTarget();const i=this.getRenderTargetDescriptorForSweep(e);if(!this.isRenderTargetDescriptorValid(i))throw new TilingError("queueUploadForAllTiles() -> Cannot render to a pano that is not activated.");const s=this.persistentStorage.getArray("queueUploadForAllTiles:nodeList");for(let i=0;i<v.Hq;i++){const n=this.getTileTree(e,i);s.length=0,n.breadthFirst({saveVisited:s});for(const e of s)this.queueUploadForTile(e.extra.tile,!1,0===e.level&&t)}}onTileDownLoaded(e){if(!e.sweep)return;const t=c(v.I_,e.panoSize),i=this.getTileDirectoryEntry(e.sweep.id,e.face,t,e.faceTileIndex);this.updateUploadDescriptorFromDownloadDescriptor(i,e),this.updateSweepLoadHistory(i.sweepId);const s=this.getRenderTargetDescriptorForSweep(i.sweepId);if(this.isRenderTargetDescriptorValid(s)){const e=this.getTileTree(i.sweepId,i.face).getSubNode(i.panoSize,i.tileX,i.tileY);e&&(this.linkTileAndNode(i,e),this.queueUploadForTile(i,!0))}}updateUploadDescriptorFromDownloadDescriptor(e,t){e.downloaded=!0,e.image=t.image,e.panoSize=t.panoSize,e.tileX=t.tileX,e.tileY=t.tileY,e.totalTiles=t.totalTiles,e.tileIndex=t.tileIndex,e.faceTileIndex=t.faceTileIndex,e.face=t.face,e.cubeFace=S.m(t.face),t.sweep&&(e.sweepId=t.sweep.id),e.tileSize=t.tileSize,e.direction.copy(t.direction),e.node=null,e.level=c(v.I_,e.panoSize)}updateSweepLoadHistory(e){const t=this.persistentStorage.getArray("updateSweepLoadHistory:tempHistory");t.length=0;for(const i of this.sweepLoadHistory)i&&(!e||e&&e!==i)&&t.push(i);this.sweepLoadHistory.length=0,e&&this.sweepLoadHistory.push(e),this.sweepLoadHistory.push(...t)}onPanoRendered(e,t,i,s){clearTimeout(this.panoLoadTimers[e]),this.engine.broadcast(new k.Z_(!1));const n=this.panoLoadResolvers[e],a=this.activeRenderTargetDescriptors[e];a&&a.object&&n(a.object.texture)}getRenderTargetDescriptorForSweep(e){return this.activeRenderTargetDescriptors[e]}setRenderTargetDescriptorForSweep(e,t){this.activeRenderTargetDescriptors[e]=t}isRenderTargetDescriptorValid(e){return!!e&&!!e.object}isSweepZoomed(e){return this.zoomingActive&&this.zoomSweepId===e}initTileTree(e,t,i){let s=this.tileTrees[e];s||(s=[],this.tileTrees[e]=s);let n=s[t];if(!n){const e=c(v.I_,i);n=new TileTree(v.I_,e),s[t]=n}}getTileTrees(e){const t=this.tileTrees[e];if(!t)throw new TilingError("TiledPanoRenderer.getTileTrees() -> Tree array not yet initialized!");return t}checkTileTreeInitialized(e){return!!this.tileTrees[e]}getTileTree(e,t){const i=this.getTileTrees(e)[t];if(!i)throw new TilingError("TiledPanoRenderer.getTileTree() -> Tree not yet initialized!");return i}deleteTileTrees(e){const t=this.getTileTrees(e);for(let e=0;e<v.Hq;e++){const i=t[e];i&&i.deleteAllNodes()}this.tileTrees[e]=null,delete this.tileTrees[e]}clearTileState(e,t=!1,i=!1){const s=(e,s,n,a)=>{i&&(s.extra.tile.image=null),t&&(s.extra.tile.uploaded=!1,s.extra.tile.downloaded=!1,s.extra.tile.zoomUploaded=!1,s.extra.tile.uploadAttempted=!1)};for(let t=0;t<v.Hq;t++){const i=this.getTileTree(e,t);i&&i.breadthFirst({callback:s.bind(this,t),maxLevel:c(v.I_,this.panoQualityManager.getZoomPanoSize())})}}resetUploadState(e,t,i){const s=(e,s,n,a)=>{s.extra.tile.zoomUploaded=!i&&s.extra.tile.zoomUploaded,s.extra.tile.uploaded=!t&&s.extra.tile.uploaded};for(let t=0;t<v.Hq;t++){this.getTileTree(e,t).breadthFirst({callback:s.bind(this,t),minLevel:0})}}anyUploaded(e){if(!e)return!1;if(e.extra.tile&&this.isTileUploaded(e.extra.tile))return!0;if(e.children)for(const t of e.children)if(this.anyUploaded(t))return!0;return!1}linkTileAndNode(e,t){t.extra.tile=e,e.node=t}linkAllTilesAndNodes(e){const t=(t,i,s,n,a)=>{const r=this.getTileDirectoryEntry(e.id,i,n,a);this.linkTileAndNode(r,s)};for(let i=0;i<v.Hq;i++){const s=this.getTileTree(e.id,i);s.breadthFirst({callback:t.bind(this,s,i)})}}getTileDirectoryEntry(e,t,i,s){let n=this.tileDirectory[e];n||(n={},this.tileDirectory[e]=n);const a=16384*t+1024*i+s;let r=n[a];return r||(r={downloaded:!1,uploaded:!1,uploadAttempted:!1,zoomUploaded:!1,uploadQueued:!1,image:null,panoSize:-1,tileX:-1,tileY:-1,totalTiles:-1,tileIndex:s,faceTileIndex:-1,face:t,cubeFace:-1,sweepId:e,tileSize:-1,direction:new o.Vector3,node:null,level:i},n[a]=r),r._tileKey=a,r}deleteTileDirectoryEntries(e){this.tileDirectory[e]=null,delete this.tileDirectory[e]}isTileUploaded(e){return this.isSweepZoomed(e.sweepId)?e.zoomUploaded:e.uploaded}setUploaded(e,t){this.isSweepZoomed(e.sweepId)?e.zoomUploaded=t:e.uploaded=t}queueUploadForTile(e,t,i){const s=!e.downloaded||e.uploadQueued&&!i||this.isTileUploaded(e)||e.panoSize>this.panoQualityManager.getNavPanoSize()&&!this.zoomingActive,n=this.getRenderTargetDescriptorForSweep(e.sweepId);!s&&n&&this.isRenderTargetDescriptorValid(n)&&(i?this.uploadTile(e):(0===c(v.I_,e.panoSize)?this.tileUploadQueue.addToForceQueue(e):t&&this.currentState.direction?this.tileUploadQueue.insertSortedIntoPanoQueue(e,n.extra.sweep,this.currentState.direction):this.tileUploadQueue.addToPanoQueue(e.sweepId,e),e.uploadQueued=!0))}uploadTile(e){const t=this.persistentStorage.get("uploadTile:tempTileTexture",(()=>({}))),i=this.tileUploadQueue.getPanoLODDescriptor(e.sweepId,e.panoSize),n=this.getRenderTargetDescriptorForSweep(e.sweepId);if(!n||!e.image||!this.isRenderTargetDescriptorValid(n))return;let a=n.object,r=n.extra.size;if(this.isSweepZoomed(e.sweepId)&&(a=this.zoomRenderTarget,r=this.panoQualityManager.getZoomPanoSize()),this.isTileUploaded(e)||this.anyUploaded(e.node))this.setUploaded(e,!1);else{const n=e.tileX*e.tileSize,d=e.tileY*e.tileSize,l=e.tileSize/e.panoSize*r,h=n/e.panoSize*r,c=d/e.panoSize*r;let u=t[e.tileSize];if(t[e.tileSize]||(u=new o.Texture,u.generateMipmaps=!1,u.minFilter=o.LinearFilter,u.flipY=!1,this.cwfRenderer.initSizedTexture2D(e.tileSize,u),t[e.tileSize]=u),this.cwfRenderer.uploadTexture2D(e.image,u,0,0),this.cwfRenderer.renderToCubeMap(u,a,e.tileSize,e.tileSize,0,0,e.tileSize,e.tileSize,h,c,l,l,e.cubeFace),s.Xd.overlayStyle>0){const t=1===s.Xd.overlayStyle?this.overlayTilesBasic:this.overlayTilesEnhanced;this.cwfRenderer.renderToCubeMap(t[e.panoSize],a,e.tileSize,e.tileSize,0,0,e.tileSize,e.tileSize,h,c,l,l,e.cubeFace,o.NormalBlending,!0,.5)}i.uploadCount++,this.setUploaded(e,!0)}e.uploadAttempted||i.uploadAttempts++,e.uploadAttempted=!0,i.uploadAttempts===e.totalTiles&&this.onPanoRendered(e.sweepId,e.panoSize,e.totalTiles)}updateUploadQueueProcessing(){if(!this.currentUploadPromise&&(this.overlayTilesLoaded||!this.usingTileOverlay)){const e=new x._("pano/tiling/upload",(()=>{this.processUploadQueue(this.tilingSettings.highResUploadsPerFrame,this.tilingSettings.uploadsPerFrame)}),R);this.currentUploadPromise=this.engine.commandBinder.issueCommand(e).then((async e=>{await e.promise,this.currentUploadPromise=null}))}}processUploadQueue(e=1,t){let i=0,s=0,n=null;for(;n=this.tileUploadQueue.getNextFromUploadQueue(this.activeSweeps);){const a=this.getRenderTargetDescriptorForSweep(n.sweepId);if(!(n.panoSize>this.panoQualityManager.getNavPanoSize()&&!this.zoomingActive||!this.isRenderTargetDescriptorValid(a))&&(this.uploadTile(n),i+=0!==n.level?1:0,s+=0===n.level?1:0,s>=t||i>=e))break}}loadOverlayTiles(){if(0!==s.Xd.overlayStyle){let e=0;const t=[],n=(i,s,n)=>{let a=new o.Texture;a.generateMipmaps=!1,a.minFilter=o.LinearFilter,a.flipY=!1,s?a=i[s]=this.cwfRenderer.initSizedTexture2D(v.I_,a):(this.overlayTileBase=this.cwfRenderer.initSizedTexture2D(v.I_,a),a=this.overlayTileBase),this.cwfRenderer.uploadTexture2D(n,a,0,0),e++,e>=t.length&&(this.overlayTilesLoaded=!0)};switch(s.Xd.overlayStyle){case 1:t.push([i(67929),this.overlayTilesBasic,256]),t.push([i(67929),this.overlayTilesBasic,512]),t.push([i(27273),this.overlayTilesBasic,1024]),t.push([i(15278),this.overlayTilesBasic,2048]),t.push([i(92787),this.overlayTilesBasic,4096]);break;case 2:t.push([i(33967),this.overlayTilesEnhanced,256]),t.push([i(33967),this.overlayTilesEnhanced,512]),t.push([i(53896),this.overlayTilesEnhanced,1024]),t.push([i(38343),this.overlayTilesEnhanced,2048]),t.push([i(73965),this.overlayTilesEnhanced,4096])}t.forEach((e=>{const t=document.createElement("img");t.crossOrigin="anonymous",t.src=e[0],t.onload=()=>{n.call(this,e[1],e[2],t)}})),this.usingTileOverlay=!0}else this.usingTileOverlay=!1}copyTargetToZoom(e){if(!this.zoomingActive)return;const t=this.getRenderTargetDescriptorForSweep(e);if(!t)throw new TilingError("Error in copying a null render target to a zoomed target");const i=t.object;this.cwfRenderer.copyCubemap(i.texture,this.zoomRenderTarget),this.copyBaseRenderStatusToZoomed(e)}setupZoomRenderTarget(){if(this.panoQualityManager.getZoomPanoSize()>=this.panoQualityManager.getNavPanoSize()){if(this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize())return;const e=this.zoomRenderTarget;this.zoomRenderTarget=this.cwfRenderer.initRenderTargetCube(this.panoQualityManager.getZoomPanoSize()),e&&(this.cwfRenderer.copyCubemap(e.texture,this.zoomRenderTarget),e.texture.dispose(),e.texture.version=0,this.cwfRenderer.deallocateCubeTexture(e.texture),e.texture=null),this.zoomSweepRenderingDisabled=!1}else this.zoomSweepRenderingDisabled=!0}}var E=i(50966),C=i(37024),N=i(20331),L=i(15253);const F=new r.Z("tile-downloader");class TileDownloader{constructor(e,t,i,s){this.urls=e,this.panoQualityManager=t,this.tilePrioritizer=i,this.settings=s,this.persistentStorage=new D.a,this.downloadDescriptors={},this.priorityQueue=[],this.forceQueue=[],this.activeDownloads=[],this.lastPrioritizedTime=Date.now(),this.processPriorityQueue=!0}init(){}render(){this.update()}update(){this.processQueue(this.forceQueue,!1),this.processPriorityQueue&&(!this.processQueuePromise&&this.sweepListMap&&this.activeDownloads.length<this.settings.concurrentDownloads&&Date.now()-this.lastPrioritizedTime>200&&(this.processQueuePromise=this.engine.commandBinder.issueCommand(new x._("pano/tiling/queue-download",(()=>{this.queuePrioritizedTiles(this.sweepListMap),this.lastPrioritizedTime=Date.now()}),100)).then((async e=>{await e.promise,this.processQueuePromise=null}))),this.processQueue(this.priorityQueue,!1))}dispose(){}activate(e){this.engine=e}deactivate(e){}setModel(e){this.setSweeps(e)}setRestrictedSweeps(e){if(this.sweepListMap&&this.tilePrioritizer){const t=[];for(const i of e)t.push(this.sweepListMap.get(i));this.tilePrioritizer.setUpcomingSweeps(t),this.clearFromAllQueuesBySweep(e)}}clearRestrictedSweeps(){this.tilePrioritizer&&this.tilePrioritizer.clearUpcomingSweeps()}setLoadCallbacks(e,t){this.onTileDownloaded=e,this.onPanoDownloaded=t}setSweeps(e){this.sweepListMap=e}getNonDownloadedTiles(e,t,i){i.length=0;const s=this.getTileDownloadDescriptors(e,t);for(const e of s)!e||e.status!==C.Z.None&&e.status!==C.Z.Queued||i.push(e)}forceQueueTiles(e,t,i,s,n,a){const r=this.persistentStorage.getArray("forceQueueTiles:remaining"),o=this.persistentStorage.getArray("forceQueueTiles:matching"),d=this.persistentStorage.getArray("forceQueueTiles:toDownload");if(this.getNonDownloadedTiles(e,t,r),d.length=0,r.length>0){P.at.sortTiles(r,e,i),o.length=0,v.oU(e,t,i,o,!0);for(const e of r)for(const t of o)e.face===t.face&&e.faceTileIndex===t.faceTileIndex&&d.push(e);this.forceQueue.push.apply(this.forceQueue,d),this.setStatusForAllDescriptors(this.forceQueue,C.Z.ForceQueued),this.clearFromQueue(this.priorityQueue,C.Z.ForceQueued,!1),s&&this.processQueue(this.forceQueue,!0)}}clearForceQueue(){this.clearQueue(this.forceQueue)}queuePrioritizedTiles(e){this.tilePrioritizer&&(this.clearQueue(this.priorityQueue),this.tilePrioritizer.filterAndPrioritize(this.priorityQueue,e,this),this.invalidateDuplicateEntries(this.priorityQueue),this.clearFromQueue(this.priorityQueue,C.Z.None,!0),this.setStatusForAllDescriptors(this.priorityQueue,C.Z.Queued),this.lastPrioritizedTime=Date.now())}clearQueue(e){this.setStatusForAllDescriptors(e,C.Z.None),e.length=0}clearFromQueue(e,t,i){for(let s=0;s<e.length;s++){const n=e[s];n&&(t===n.status&&!i||t!==n.status&&i)&&(e[s]=null)}}clearFromAllQueuesBySweep(e){this.clearFromQueueBySweep(this.forceQueue,e),this.clearFromQueueBySweep(this.priorityQueue,e)}clearFromQueueBySweep(e,t){const i=(0,M.ow)(t);for(let t=0;t<e.length;t++){const s=e[t];s&&s.sweep&&(i[s.sweep.id]||(e[t]=null))}}setStatusForAllDescriptors(e,t){for(const i of e)i&&(i.status=t)}invalidateDuplicateEntries(e){for(const t of e)t&&(t.queuedCount=0);for(let t=0;t<e.length;t++){const i=e[t];i&&(i.queuedCount++,i.queuedCount>1&&(e[t]=null))}}getTileDownloadDescriptors(e,t){const i=this.getAllTileDownloadDescriptors(e.id);let s=i[t];return s||(s=this.buildDownloadDescriptorArray(t),i[t]=s,this.initTileDownloadDescriptors(s,e,t)),s}getAllTileDownloadDescriptors(e){let t=this.downloadDescriptors[e];return t||(t={},this.downloadDescriptors[e]=t),t}deleteAllTileDownloadDescriptors(e){this.downloadDescriptors[e]=null,delete this.downloadDescriptors[e]}processQueue(e,t){if(this.cleanupActiveDownloads(),this.activeDownloads.length<this.settings.concurrentDownloads||t){const i=t?e.length:this.settings.concurrentDownloads-this.activeDownloads.length;let s=0;for(let t=0;s<i&&e.length>0;t++){const t=e.shift();t&&(this.startDownload(t),s++)}}}async startDownload(e){if(!this.urls)throw new Error("Can't call startDownload without signed urls");if(e.sweep){const t=e.status===C.Z.ForceQueued?N.ru.HIGHEST:N.ru.MEDIUM;e.status=C.Z.Downloading;this.checkRestrictedSweep(e.sweep.id)||F.warn("Downloading a tile that is not in restricted list"),this.activeDownloads.push(e);const i=await this.panoQualityManager.getTileUrl(e.sweep,e.panoSize,e.tileSize,e.tileIndex);this.urls.getImageBitmap(i,e.tileSize,e.tileSize,{maxRetries:4,priority:t}).then(this.downloadComplete.bind(this,e),this.downloadFailed.bind(this,e))}}checkRestrictedSweep(e){if(this.tilePrioritizer){const t=this.tilePrioritizer.priorityCriteria.upcomingSweeps;if(t){let i=!1;for(const s of t)s&&s.id===e&&(i=!0);return i}return!0}return!0}downloadFailed(e,t){e.status=C.Z.DownloadFailed}downloadComplete(e,t){if(e.sweep&&(e.status=C.Z.Downloaded,e.image=t,this.onTileDownloaded&&this.onTileDownloaded(e),this.engine.broadcast(new L.o),this.isPanoDownloaded(e.sweep,e.panoSize))){const t={sweep:e.sweep,tileSize:e.tileSize,panoSize:e.panoSize};this.onPanoDownloaded&&this.onPanoDownloaded(t)}}cleanupActiveDownloads(){const e=this.persistentStorage.getArray("cleanupActiveDownloads:temp");e.length=0;for(const t of this.activeDownloads)t.status!==C.Z.Downloaded&&t.status!==C.Z.DownloadFailed&&e.push(t);this.activeDownloads.length=0,this.activeDownloads.push.apply(this.activeDownloads,e)}isPanoDownloaded(e,t){const i=this.getTileDownloadDescriptors(e,t);if(!i||i.length<=0)return!1;for(const e of i)if(e&&e.status!==C.Z.Downloaded)return!1;return!0}buildDownloadDescriptorArray(e){const t=v.Tu(e),i=[];for(let e=0;e<t;e++){const e=this.buildDownloadDescriptor();i.push(e)}return i}buildDownloadDescriptor(){return{sweep:null,panoSize:-1,tileSize:-1,tileIndex:-1,totalTiles:-1,faceTileIndex:-1,status:C.Z.None,url:null,image:null,direction:new o.Vector3,face:-1,cubeFace:-1,tileX:-1,tileY:-1,queuedCount:-1}}initTileDownloadDescriptors(e,t,i){for(let s=0;s<e.length;s++){const n=e[s];n&&this.initTileDownloadDescriptor(n,t,i,s)}}initTileDownloadDescriptor(e,t,i,s){const n=i>=v.I_?v.I_:i;e.face=v.R5(i,s),e.cubeFace=S.m(e.face),e.sweep=t,e.panoSize=i,e.tileSize=n,e.tileIndex=s,e.totalTiles=v.Tu(i),e.status=C.Z.None,e.image=null,v.Tp(e.panoSize,e.tileIndex,e),v.P6(e.panoSize,e.tileSize,e.cubeFace,e.tileX,e.tileY,E.Z.Center,0,e.direction)}}var A=i(13453),O=i(96640),z=i(22423),G=i(77956),V=i(50101),U=i(60463),Q=i(89155),_=i(44266),B=i(39936),H=i(86450),j=i(24135),X=i(21265),q=i(81660),Z=i(97620),Y=i(85563),W=i(13402),$=i(19938);const K=new r.Z("sweep-pano-tiling");class SweepPanoTiling extends U.Z{constructor(){super(...arguments),this.name="sweep-pano-tiling",this.preloadQuality=null,this.preloadResolution=null,this.handlePlayerResize=(e,t)=>{const i=this.currentResolution();this.panoRenderer.panoQualityManager.setWindowSize(e.width,e.height);i!==this.currentResolution()&&t&&this.resetPano(t)}}async init(e,t){const a=await t.getModule(z.default),r=await t.getModule(V.default),o=await t.market.waitForData(G.Z);this.cameraData=await t.market.waitForData(Q.M_);const d=await t.market.waitForData(j.P);this.settingsData=await t.market.waitForData(B.e);const l=r.cwfRenderer,h=r.maxCubemapSize,c=a.getSignedUrls();this.settings=new s.k4,this.qualityManager=new y.Z(c,h,e.navPanoSize,e.zoomPanoSize),this.tilePrioritizer=new P.at(this.qualityManager,this.settings,o,d),this.tileDownloader=new TileDownloader(c,this.qualityManager,this.tilePrioritizer,this.settings),this.panoRenderer=new TiledPanoRenderer(c,l,this.qualityManager,this.tileDownloader,o,this.cameraData,this.settings,(e=>t.broadcast(e))),t.addComponent(this,this.tileDownloader),t.addComponent(this,this.panoRenderer),this.bindings.push(t.subscribe(Y.Z,(e=>{this.setTilingFOV()})),t.subscribe(n.a,(e=>{this.handlePlayerResize(e,o.currentSweep),this.setTilingFOV()})),t.subscribe(A.Z,(e=>{this.tileDownloader.setRestrictedSweeps(e.sweepIds)})),t.subscribe(O.Z,(e=>{this.tileDownloader.clearRestrictedSweeps()})),t.subscribe(q.Z,(e=>{const t=o.getSweep(e.sweepId);this.setHoverPreloadSweep(e.hovered?t:void 0)})),t.subscribe(W.a,(e=>{this.tilePrioritizer.priorityCriteria.viewMode=e.toMode})),o.onPropertyChanged("transitionActive",(()=>{if(o.transition.to){const e=o.getSweep(o.transition.to);this.handlePreloadQualityChange(e)}})),this.settingsData.onPropertyChanged(s.YS,(()=>{this.preloadQuality=this.settingsData.tryGetProperty(s.YS,null),this.qualityManager.overrideWindowMaximums(null!==this.preloadQuality),o.currentSweepObject&&this.handlePreloadQualityChange(o.currentSweepObject)})),t.commandBinder.addBinding(H.D,(async e=>{this.qualityManager.overrideWindowMaximums(e.ignoreWindowSize)})),t.commandBinder.addBinding(H.F,(async e=>{this.qualityManager.updateNavPanoSize(e.navSize)}))),this.setTilingFOV(),(0,X.hu)("debug","").includes("panopreload")&&Promise.all([i.e(164),i.e(383)]).then(i.bind(i,40517)).then((e=>{new e.PanoPreloadVisualizer(t,this.qualityManager,this.settings,this.tileDownloader,this.tilePrioritizer)}))}setTilingFOV(){const e=this.cameraData.fovX(),t=this.cameraData.fovY(),i=Math.max(e,t)*Z.MN;this.tilePrioritizer.setDownloadFOV(i)}getRenderer(){return this.panoRenderer}setHoverPreloadSweep(e){this.tilePrioritizer&&this.tilePrioritizer.setHoveredSweep(e)}async handlePreloadQualityChange(e){if(null!==this.preloadQuality){const t=await this.availableResolution(e,this.preloadQuality);this.preloadResolution=y.Z.getPanoSize(t)}else this.preloadResolution=null;this.enableHighRes(!1)}enableHighRes(e=!0,t){const i=null!==this.preloadResolution?this.preloadResolution:e?this.qualityManager.getZoomPanoSize():this.qualityManager.getNavPanoSize();this.tilePrioritizer.maxResolution!==i&&K.debug(`Setting max resolution: ${i}`),this.tilePrioritizer.maxResolution=i,this.panoRenderer.highResRenderTarget(e,t)}async enableZooming(e,t){if(e){const e=y.Z.getPanoSizeClass(this.qualityManager.getZoomPanoSize());return await this.requestResolution(t,e)>=e}return this.enableHighRes(!1,t.id),this.resetPano(t.id),Promise.resolve(!1)}async requestResolution(e,t,i=$.v.CurrentView,n=!1){this.settings.highResUploadsPerFrame=n?s.Xd.maxHighResUploadsPerFrame:s.Xd.highResUploadsPerFrame,this.settings.concurrentDownloads=n?s.Xd.maxConcurrentDownloads:s.Xd.concurrentDownloads,this.settings.downloadFullPano=i===$.v.FullPanorama;const a=await this.availableResolution(e,t);return a>T.SL.HIGH&&(this.qualityManager.overrideWindowMaximums(!0),this.panoRenderer.enableUltraHighQualityMode(e.id)),(this.currentResolution()<a||y.Z.getPanoSize(a)>this.qualityManager.getNavPanoSize())&&(this.enableHighRes(!0,e.id),this.resetPano(e.id)),a}waitForQueue(e,t,i=1e3){const s=new _.Q,n=()=>{o.cancel(),s.notify(1),s.resolve()};let a=this.tilePrioritizer.getQualityQueueSize(e,t),r=window.setTimeout((()=>{K.debug(`Download queue ${e} timed out from inactivity after ${i}ms`),n()}),i);const o=this.tilePrioritizer.makeQueueSubscription(e,t,(e=>{if(r&&(window.clearTimeout(r),r=0,a=e),e>0){const t=(a-e)/Math.max(a,1);s.notify(t)}else n()}));return s}revertTilingSettings(e){this.enableHighRes(!1,e),this.resetPano(e),this.settings.reset()}availableResolution(e,t){return this.qualityManager.availableResolution(e,t)}currentResolution(){return this.panoRenderer.getCurrentPanoResolution()}resetPano(e){this.panoRenderer.resetRenderStatus(e,!1,!0,this.panoRenderer.panoQualityManager.getNavPanoSize()),this.panoRenderer.clearAllQueuedUploadsForPano(e),this.panoRenderer.renderPanoTiles(e,null,!1,!1)}}},73732:(e,t,i)=>{"use strict";i.d(t,{Z:()=>a});var s=i(57369),n=i(86515);const a=class PanoRenderer{constructor(e,t){this.textureUsageCounter={},this.model=e,this.sweepList=t;const i=new n.Z((e=>e.id));for(let e of this.sweepList)e.isObservableProxy&&(e=(new s.ZP).copy(e)),i.add(e);this.sweepListMap=i}init(){}dispose(){}activate(e){}deactivate(e){}beforeRender(){}render(){}activateSweep(e){return this.initTextureUsage(e),Promise.resolve(null)}useTexture(e){return this.incrementTextureUsage(e),null}freeTexture(e,t=!1){t?this.setTextureUsage(e,0):this.decrementTextureUsage(e)}initTextureUsage(e){this.textureUsageCounter[e]||(this.textureUsageCounter[e]=0)}setTextureUsage(e,t){this.textureUsageCounter[e]=t}freeUnusedTextures(){for(const e of Object.keys(this.textureUsageCounter))0===this.textureUsageCounter[e]&&this.freeTexture(e)}incrementTextureUsage(e){this.textureUsageCounter[e]++}decrementTextureUsage(e){this.textureUsageCounter[e]>0&&this.textureUsageCounter[e]--}}},60463:(e,t,i)=>{"use strict";i.d(t,{Z:()=>SweepPano});var s=i(54122);class SweepPano extends s.Y{constructor(){super(...arguments),this.name="sweep-pano-base"}getRenderer(){return this.panoRenderer}}},12371:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>SweepPanoSolid});var s=i(5587),n=i(73732);class SolidPanoRenderer extends n.Z{constructor(e,t){super(e,t),this.sweepLoader=new s.Z(e)}activateSweep(e){super.activateSweep(e);const t=this.sweepListMap.get(e);return this.sweepLoader.load(t).then((e=>e))}useTexture(e){const t=this.sweepLoader.useTexture(e);return t&&super.useTexture(e),t}freeTexture(e,t=!1){super.freeTexture(e,t),0===this.textureUsageCounter[e]&&this.sweepLoader.unload(e)}freeAllTextures(e){this.sweepLoader.unloadAll(e)}}var a=i(22423),r=i(77956),o=i(60463);class SweepPanoSolid extends o.Z{constructor(){super(...arguments),this.name="sweep-pano"}async init(e,t){const i=(await t.getModule(a.default)).getSignedUrls(),s=(await t.market.waitForData(r.Z)).getSweepList();this.panoRenderer=new SolidPanoRenderer(i,s),t.addComponent(this,this.panoRenderer)}getRenderer(){return this.panoRenderer}}},58345:(e,t,i)=>{"use strict";i.d(t,{C:()=>TourRenameCommand,X:()=>DeleteUnusedTourSnapshotsCommand});var s=i(99681);class TourRenameCommand extends(984==i.j?s.m:null){constructor(e,t){super(),this.id="TOUR_RENAME",this.payload={sid:e,name:t}}}class DeleteUnusedTourSnapshotsCommand extends s.m{constructor(){super(...arguments),this.id="DELETE_UNUSED_TOUR_SNAPSHOTS"}}},62110:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ToursModule});var s,n=i(62431),a=i(54122),r=i(39936),o=i(71208),d=i(77956),l=i(944),h=i(17513),c=i(26247),u=i(25799),p=i(32400),m=i(74054),g=i(90134),f=i(78909);class HighlightReel extends f.T{constructor(){super(),this.reel=(0,g.C)([]),this.modified=new Date(0),this.commit()}}!function(e){e.INSTANT="instant",e.FACE_TO_BLACK="fade_to_black",e.INTERPOLATE="interpolate"}(s||(s={}));var v=i(19673),w=i(47924),y=i(44228);const S=new u.Z("mds-reel-element-serializer"),T={[s.FACE_TO_BLACK]:w.n.FadeToBlack,[s.INSTANT]:w.n.Instant,[s.INTERPOLATE]:w.n.Interpolate},D={[v.Y.LEFT]:y.kw.Left,[v.Y.RIGHT]:y.kw.Right,[v.Y.AUTO]:y.kw.Auto};class MdsReelEntryDeserializer{deserialize(e){if(!e||!this.validate(e))return S.debug("Deserialized invalid highlight reel entry from MDS",e),null;const t=e.overrides||{},i={},s=void 0!==t.transitionType?T[t.transitionType]:void 0,n=void 0!==t.panDirection?D[t.panDirection]:void 0,a=t.panAngle;void 0!==s&&(i.transitionType=s),void 0!==n&&(i.panDirection=n),void 0!==a&&(i.panAngle=a);return{sid:e.asset.id,overrides:i}}validate(e){if(!e)return!1;const{asset:t}=e;return void 0!==t&&void 0!==t.id}}const P=new u.Z("mds-highlight-reel-serializer");class MdsHighlightReelDeserializer{constructor(){this.reelEntrySerializer=new MdsReelEntryDeserializer}deserialize(e){if(!e||!this.validate(e))return P.debug("Deserialized invalid active reel data from MDS",e),null;const t=new HighlightReel;if(t.sid=e.id,e.reel)for(const i of e.reel){const e=this.reelEntrySerializer.deserialize(i);e&&t.reel.push(e)}return t}validate(e){return["id"].every((t=>t in e))}}const b={[w.n.FadeToBlack]:s.FACE_TO_BLACK,[w.n.Instant]:s.INSTANT,[w.n.Interpolate]:s.INTERPOLATE},M={[y.kw.Left]:v.Y.LEFT,[y.kw.Right]:v.Y.RIGHT,[y.kw.Auto]:v.Y.AUTO};class MdsReelEntrySerializer{serialize(e){const t={id:e.sid};return e.overrides&&(t.overrides={},void 0!==e.overrides.transitionType&&(t.overrides.transitionType=b[e.overrides.transitionType]),void 0!==e.overrides.panDirection&&(t.overrides.panDirection=M[e.overrides.panDirection]),void 0!==e.overrides.panAngle&&(t.overrides.panAngle=e.overrides.panAngle)),t}}const x=new u.Z("mds-highligh-reel-store");class MdsHighlightReelStore extends p.u{constructor(){super(...arguments),this.deserializer=new MdsHighlightReelDeserializer,this.serializer=new MdsReelEntrySerializer,this.prefetchKey="data.model.activeHighlightReel"}async read(e){const t={modelId:this.getViewId()};return this.query(m.GetHighlightReel,t,e).then((e=>{var t,i;const s=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.activeHighlightReel;return this.deserializer.deserialize(s)}))}async update(e){const t=this.getViewId(),i=e.map((e=>this.serializer.serialize(e)));return this.mutate(m.PutActiveReel,{modelId:t,elements:i}).then((e=>{x.debug(e)}))}}var k=i(98728),I=i(80034),R=i(41263),E=i(7943),C=i(15119),N=i(20331),L=i(32020),F=i(46162);const A=new u.Z("reel-serializers"),O=e=>{if(!e)return null;const t=new HighlightReel;return e.active_reel&&e.active_reel.modified&&(t.modified=(0,L.p)(e.active_reel.modified)),e.active_reel&&e.active_reel.reel&&e.active_reel.reel instanceof Array?(A.info("Reel has "+e.active_reel.reel.length+" items"),t.reel.replace(e.active_reel.reel)):A.info("No reel found"),t.commit(),t},z=(e,t)=>{let i=e.modified;t&&t.modified&&(i=t.modified);const s=(0,F.p$)(e&&e.reel?e.reel:[]),n=t&&t.reel?t.reel:new g.d;(0,F.TS)(s,(0,F.p$)(n));const a=[];for(const e in s){const t=s[e];if(t){let e,i={};t.overrides&&(void 0!==t.overrides.panDirection&&(i=Object.assign(Object.assign({},i),{panDirection:t.overrides.panDirection})),void 0!==t.overrides.panAngle&&(i=Object.assign(Object.assign({},i),{panAngle:t.overrides.panAngle})),void 0!==t.overrides.transitionType&&(i=Object.assign(Object.assign({},i),{transitionType:t.overrides.transitionType}))),e=Object.keys(i).length>0?{sid:t.sid,overrides:i}:{sid:t.sid},a.push(e)}}return{active_reel:{reel:a,modified:(0,L.U)(i)}}};var G=i(83032),V=i(74403),U=i(60841),Q=i(43894),_=i(44333),B=i(17256),H=i(58345);const j=new u.Z("tour-data");class ToursModule extends a.Y{constructor(){super(...arguments),this.name="tours-data",this.defaultModes=[o.Ey.Panorama,o.Ey.Outdoor],this.deleteUnusedTourSnapshots=async()=>{for(const e in this.snapshotsData.collection){const t=this.snapshotsData.collection[e];t.category!==h.i.TOUR||this.tourData.isSnapshotInTour(t.sid)||await this.engine.commandBinder.issueCommand(new l.Ad(t.sid)).catch((e=>{j.debug(e),j.error(`Failed to delete unused tour snapshot ${t.sid}`)}))}},this.onUpdateSnapshots=()=>{this.tourData.updateSnapshots(this.snapshotsData.collection)}}async init(e,t){const{readonly:i}=e;this.engine=t;const s=await t.market.waitForData(r.e),n=this.getFilterModes(s,this.defaultModes);this.store=this.getStore(e);const a=await this.store.read()||new HighlightReel;if(this.sweepData=await t.market.waitForData(d.Z),this.snapshotsData=await t.market.waitForData(c.P),this.storage=await t.getModule(Q.F),this.tourData=new k.k3(this.snapshotsData.collection,a,n,this.sweepData.getSweepList(),e.looping),t.market.register(this,k.k3,this.tourData),!1===i){const e=this.tourData.getReel(),i=new V.u(e,{aggregationType:U.E.NextFrame},t);i.onChanged((()=>this.engine.commandBinder.issueCommand(new _.VQ({dataTypes:[B.g.HIGHLIGHTS]})))),this.store instanceof G.N&&this.store.addMonitor(i)}this.bindings.push(t.commandBinder.addBinding(H.X,this.deleteUnusedTourSnapshots),this.snapshotsData.onChanged(this.onUpdateSnapshots),this.storage.onSave((()=>this.save()),{dataType:B.g.HIGHLIGHTS}),this.storage.onRevert((()=>this.revert()),{dataType:B.g.HIGHLIGHTS}));const o=Object.keys(a.reel).length,l=this.tourData.getSnapshotCount();o!==l&&j.info(o-l+" items in snapshots, but not in reel")}getStore(e){if(this.store)return this.store;const{modelId:t,baseUrl:i,queue:s}=e,n=e.storageProvider||B.Xq.JSONSTORE,a=!("readonly"in e)||!!e.readonly;if(j.info(`Loading Highlight Reel from ${n}`),n===B.Xq.MDS)return new MdsHighlightReelStore({readonly:a,baseUrl:i});const r=function(e){const{modelId:t,readonly:i}=e,s=e.baseUrl||"",n=e.queue||new N.gO,a={data:null},r=`${s}/api/v1/jsonstore/model/highlights/${t}`;if(i){const e=new I.gh({queue:n,path:r,deserialize:O,cachedData:a});return new R.nM({publishStores:[e]})}const o=new I.yh({queue:n,path:r,cachedData:a,deserialize:O,serialize:z}),d=`${s}/api/v1/jsonstore/model/workshopSession/${t}`,l=new C.Z({queue:n,path:d,cachedData:{data:null},deserialize:E.S.sessionObjectExtract(C.j.Highlights,O),serialize:z},C.j.Highlights);return new R.nM({publishStores:[o],editStore:l,editStoreKey:R.aw.HIGHLIGHTS})}({modelId:t,baseUrl:i,readonly:a,queue:s});return new G.N(r,{dataType:B.g.HIGHLIGHTS,modelId:t,readonly:a,engine:this.engine})}async save(){if(this.store instanceof G.N)return;const e=this.tourData.getReel();await this.store.update(e.reel)}async revert(){if(this.store instanceof G.N)return this.store.revert()}getFilterModes(e,t){const i=e.tryGetProperty("dh",1)>0,s=e.tryGetProperty(n.gx.Dollhouse,!0);i&&s&&t.push(o.Ey.Dollhouse);const a=e.tryGetProperty("fp",1)>0,r=e.tryGetProperty(n.gx.FloorPlan,!0);return a&&r&&t.push(o.Ey.Floorplan),t}}},8473:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>VideoRecorderModule});var s=i(25799),n=i(54122),a=i(19417),r=i(30853),o=i(53339),d=i(50101),l=i(21265),h=i(24779);class FrostMage{constructor(){this._dateNow=Date.now,this._performanceNow=performance.now,this.nowOverride=0}slowTime(e){this.fps=e,this.nowOverride=Date.now(),Date.now=()=>this.nowOverride,performance.now=()=>this.nowOverride}tick(){this.nowOverride+=1e3/this.fps}resetTime(){Date.now=this._dateNow,performance.now=this._performanceNow}}var c=i(88069),u=i(28247);const p=new s.Z("video-recorder");var m;!function(e){e[e.STOPPED=0]="STOPPED",e[e.RECORDING=1]="RECORDING"}(m||(m={}));class VideoRecorderModule extends n.Y{constructor(){super(...arguments),this.name="video-recorder-module",this.state=m.STOPPED,this.frostMage=new FrostMage}async init(e,t){this.settingsModule=await t.getModule(r.default),this.webglRenderer=await t.getModule(d.default),this.engine=t,this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 1080p @ 60",(()=>{this.state===m.STOPPED&&this.record(1920,1080,60)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download 720p @ 30",(()=>{this.state===m.STOPPED&&this.record(1280,720,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram",(()=>{this.state===m.STOPPED&&this.record(1080,1080,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Download instagram story",(()=>{this.state===m.STOPPED&&this.record(1080,1920,30)})),this.settingsModule.registerButton("Tour Recorder (Chrome Only)","Stop & download current",(()=>{this.state===m.RECORDING&&this.stop()}))}async record(e,t,s){if(this.state!==m.STOPPED)return void p.warn("Can't start recording... we're already recording!");p.info("Starting recording of tour. Now is a good time to get a coffee :)"),this.state=m.RECORDING;const n=await Promise.all([i.e(764),i.e(718)]).then(i.bind(i,64875));this.encoder=new n.WebMWriter({quality:.95,frameRate:s}),this.frostMage.slowTime(s),await this.engine.commandBinder.issueCommand(new h.M({resizeDimensions:[{property:h.P.width,setDimension:e,duration:0},{property:h.P.height,setDimension:t,duration:0}]})),await this.engine.commandBinder.issueCommand(new a.TH);const r=this.engine.subscribe(o.NR,(()=>{r.cancel(),this.state===m.RECORDING&&this.stop()})),d=this,l=d.webglRenderer.cwfRenderer.renderer.getContext().canvas;this.engine.startGenerator((function*(){for(;d.state===m.RECORDING;)d.encoder.addFrame(l),yield new u.Jj,d.frostMage.tick(),yield new u.Jj}))}async stop(){if(this.state!==m.RECORDING)return void p.warn("Can't stop recording, we weren't recording at all");this.frostMage.resetTime(),this.state=m.STOPPED,await this.engine.commandBinder.issueCommand(new h.M((0,c.lb)(0))),p.info("Encoding tour to video...");const e=await this.encoder.complete();p.info("Tour encoded! Prompting user to download."),(0,l.Hx)(e,"tour.webm")}}},79467:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ee});var s=i(25799),n=i(54122),a=i(53999),r=i(97620),o=i(2212),d=i(27829),l=i(32818),h=i(89895),c=i(89155),u=i(62513),p=i(24135),m=i(39936),g=i(50101),f=i(75195);const v=new o.Vector3(0,-100,0),w=new o.Vector2(-2,-2),y=new o.Vector3(-1,-1,-1),S=new o.Vector3(1,1,1);class RaycastPointerWorld{constructor(e){this.raycaster=e,this.lastHits=[],this.lastRay=new o.Ray(v,new o.Vector3(0,-1,0)),this.currentRay=new o.Ray,this.origin=v,this.direction=new o.Vector3,this.pointerNdc=w,this.cameraCache={position:new o.Vector3,quaternion:new o.Quaternion,camera:void 0},this.cast=()=>{const e=this.currentRay;return this.lastRay.equals(e)||(this.lastHits=this.raycaster.cast(e.origin,e.direction).slice(),this.lastRay.copy(e)),this.lastHits},this.update3D=(e,t,i)=>{e instanceof o.Vector3&&this.origin.copy(e),t instanceof o.Vector3&&this.direction.copy(t),this.cameraCache.camera=i,this.currentRay.set(this.origin,this.direction)},this.updateNDCPosition=()=>{const e=this.lastHits[0];if(this.cameraCache.camera&&e&&e.point){const t=this.cameraCache.camera;this.cameraCache.position.setFromMatrixPosition(t.matrixWorld),this.cameraCache.quaternion.setFromRotationMatrix(t.matrixWorld);const i=(0,f.D_)(e.point,this.cameraCache.position,this.cameraCache.quaternion,t.projectionMatrix);i.clamp(y,S),this.pointerNdc.set(i.x,i.y)}},this.updatePointer=()=>{}}get pointerRay(){return this.currentRay}get ndcPosition(){return this.updateNDCPosition(),this.pointerNdc}}var T=i(93528);class XRTrackingMessage extends T.v{}class XRTrackingAppliedMessage extends XRTrackingMessage{constructor(e){super(),this.trackedCamera=e}}class XRStartPresentingMessage extends XRTrackingMessage{}class XRStopPresentingMessage extends XRTrackingMessage{}var D,P=i(35539),b=i(59309),M=i(2779);!function(e){e[e.Mono=0]="Mono",e[e.Stereo=1]="Stereo",e[e.SixDof=2]="SixDof",e[e.__length=3]="__length"}(D||(D={}));const x={controllers:Object.freeze([0,1]),rotationDegrees:25};var k;!function(e){e[e.touchpadX=0]="touchpadX",e[e.touchpadY=1]="touchpadY",e[e.thumbstickX=2]="thumbstickX",e[e.thumbstickY=3]="thumbstickY"}(k||(k={}));const I={x:0,y:0,z:0,w:1};class XRTrackingOverrides extends b.Y{constructor(e,t,i,s,n){super(),this.engine=e,this.renderer=t,this.webglScene=i,this.cameraData=s,this.cameraModule=n,this.trackingStyle=D.Mono,this.session=null,this.rotations={initialYawOffset:new o.Quaternion,yawOffset:new o.Quaternion,invYawOffset:new o.Quaternion,trackingOffset:new o.Quaternion},this.setTrackingStyle=e=>{e<D.__length&&(this.trackingStyle=e,this.resetInitialRotation())},this.offsetRotation=e=>{this.rotations.invYawOffset.multiply(e),this.rotations.yawOffset.copy(this.rotations.invYawOffset).invert()},this.onPresentStart=e=>{e.cameras[0].layers.mask=M.o.ALL.mask,e.cameras[1].layers.mask=M.o.ALL.mask,e.cameras[0].far=e.far,e.cameras[1].far=e.far,e.layers.mask=M.o.ALL.mask,this.resetInitialRotation(),this.broadcast(new XRStartPresentingMessage)},this.resetInitialRotation=()=>{const e=this.cameraData.pose.rotation.clone();(0,r.Rq)(e,this.rotations.initialYawOffset),this.rotations.yawOffset.copy(this.rotations.initialYawOffset),this.rotations.invYawOffset.copy(this.rotations.initialYawOffset).invert()},this.onPresentEnd=()=>{this.broadcast(new XRStopPresentingMessage)},this.applyTrackingOverrides=(e,t,i)=>{if(e.xr.isPresenting&&i instanceof o.ArrayCamera){e.clear();const t=i.cameras[0],s=i.cameras[1];if(this.frame=this.engine.getXrFrame(),this.session||(this.session=e.xr.getSession(),this.onPresentStart(i)),this.frame&&this.session){this.rotations.trackingOffset.copy(this.rotations.yawOffset).multiply(i.quaternion),this.cameraModule.updateCameraRotation(this.rotations.trackingOffset);const e=this.webglScene.camera.parent;if(e){const t=this.getReferenceSpace(this.frame,e);this.updateCameras(i,this.frame,t,e),this.updateControllers(this.session,this.frame,t,e)}switch(this.trackingStyle){case D.Mono:s.matrixWorld.copy(t.matrixWorld),s.matrixWorldInverse.copy(s.matrixWorld),s.matrixWorldInverse.invert()}this.broadcast(new XRTrackingAppliedMessage(t))}}else this.session&&(this.session=null,this.onPresentEnd())},this.getReferenceSpace=(e,t)=>{const i=this.renderer.xr.getReferenceSpace(),s=e.getViewerPose(i).views[0].transform.position,n=this.trackingStyle===D.SixDof?I:s,a=new XRRigidTransform({x:n.x-t.position.x,y:n.y-t.position.y,z:n.z-t.position.z}),r=i.getOffsetReferenceSpace(a),o=this.rotations.invYawOffset,d=this.cameraData.pose.position,l=new XRRigidTransform({x:d.x,y:d.y,z:d.z,w:1},{x:o.x,y:o.y,z:o.z,w:o.w});return r.getOffsetReferenceSpace(l)},this.updateCameras=(e,t,i,s)=>{const n=t.getViewerPose(i);if(n){const t=n.views;for(let i=0;i<t.length;i++){const n=t[i],a=e.cameras[i];a.matrix.fromArray(n.transform.matrix),a.projectionMatrix.fromArray(n.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix),a.projectionMatrixInverse.invert(),a.matrixWorld.multiplyMatrices(s.matrixWorld,a.matrix),a.matrixWorldInverse.copy(a.matrixWorld),a.matrixWorldInverse.invert(),a.matrix.decompose(a.position,a.quaternion,a.scale),0===i&&(e.matrix.copy(a.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorld.copy(a.matrixWorld),e.matrixWorldInverse.copy(a.matrixWorldInverse),e.projectionMatrix.copy(a.projectionMatrix),e.projectionMatrixInverse.copy(a.projectionMatrixInverse))}}},this.updateControllers=(e,t,i,s)=>{for(let n=0;n<2;n++){const a=this.renderer.xr.getController(n),r=this.renderer.xr.getControllerGrip(n),o=e.inputSources[n];let d=null,l=null;o&&(a&&(d=t.getPose(o.targetRaySpace,i),d&&(a.matrix.fromArray(d.transform.matrix),a.matrixWorld.multiplyMatrices(s.matrixWorld,a.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale)),a.visible=!!d),r&&o.gripSpace&&(l=t.getPose(o.gripSpace,i),l&&(r.matrix.fromArray(l.transform.matrix),r.matrixWorld.multiplyMatrices(s.matrixWorld,r.matrix),r.children.forEach((e=>{e.updateMatrixWorld()})),r.matrix.decompose(r.position,r.quaternion,r.scale)))),r&&(r.visible=!!l)}},this.webglScene.scene.onBeforeRender=this.applyTrackingOverrides}}var R=i(5442),E=i(83974),C=i(59120),N=i(74725),L=i(66272),F=i(85995),A=i(74958),O=i(77956),z=i(75711),G=i(12775),V=i(3834),U=i(60778),Q=i(33757);class XRNavigationVisuals{constructor(){this.active=!1,this.target=new R.f(null),this.previousSweep=null,this.activate=()=>{this.active||(this.updateLoopSub.renew(),this.selectionChangeSub.renew(),this.ray.toggle(!0),this.targetDecoration.toggle(!0),this.active=!0)},this.deactivate=()=>{this.active&&(this.target.value=null,this.selectionChangeSub.cancel(),this.updateLoopSub.cancel(),this.ray.toggle(!1),this.targetDecoration.toggle(!1),this.active=!1)},this.getTargetSweep=(e,t,i)=>{let s=null;if(t.object instanceof A.YY)return s=e.getSweep(t.object.userData.sid),s;const n=(0,L.b)(e,!0,t.intersection);return s=n.length>0?n[0].sweep:null,s}}get container(){return this._container}async init(e){this.engine=e,this._container=new o.Group,this._container.name="XRNavigationVisuals",this.ray=new XRTargetRay(this.container),this.targetDecoration=new XRTargetDecoration(this.container);const t=await this.engine.market.waitForData(p.P);return this.updateLoopSub=t.onChanged((()=>this.update(t))),this.updateLoopSub.cancel(),this.selectionChangeSub=this.target.onChanged((e=>{null!==this.previousSweep&&this.engine.commandBinder.issueCommand(new F.kR(this.previousSweep.id,!1,200)),null!==e&&(this.engine.commandBinder.issueCommand(new F.kR(e.id,!0,200)),this.targetDecoration.updateTargetPosition(e.floorPosition)),this.previousSweep=e})),this.selectionChangeSub.cancel(),this}update(e){const t=this.engine.market.tryGetData(O.Z),i=this.engine.market.tryGetData(c.M_),s=this.engine.market.tryGetData(G.O),n=this.engine.market.tryGetData(V.Y),a=this.engine.market.tryGetData(z.Z);if(!(t&&i&&s&&a&&n))return;if(!a.isVR())return;if(!s.isPano())return;const{hit:r,pointerDirection:o,pointerOrigin:d}=e;if(!r)return;const l=this.getTargetSweep(t,r,o);this.target.value=l,this.ray.update(d,r.point,n.opacity.value),this.targetDecoration.update(i.pose.rotation,n.opacity.value)}}class XRTargetRay{constructor(e){this.container=e,this.styles={ray:{color:"white",transparent:!0,opacity:.3,linewidth:2,depthWrite:!1},hit:{color:"white",transparent:!0,opacity:.3},hitScale:.02},this.update=(e,t,i)=>{this.ray.updatePositions(e,t).opacity(Math.min(i,this.styles.ray.opacity)),this.hitMarker.position.copy(t),this.hitMarker.material.opacity=Math.min(i,this.styles.hit.opacity)},this.toggle=e=>{e?(this.container.add(...this.ray.children),this.container.add(this.hitMarker)):(this.container.remove(...this.ray.children),this.container.remove(this.hitMarker))};const{ray:t,hit:i}=this.styles,s=C.default.makeLineMaterial(t.color,!1,t);this.ray=new N.c(new o.Vector3,new o.Vector3,s,{}),this.ray.updateResolution(window.innerWidth,window.innerHeight),this.hitMarker=new E.E(new o.SphereBufferGeometry(this.styles.hitScale),new o.MeshBasicMaterial(i)),this.hitMarker.name="hit"}}class XRTargetDecoration{constructor(e){this.container=e,this.styles={scale:.46,animationSpeed:1,plane:{color:"white",transparent:!0,opacity:.6,depthWrite:!1,depthTest:!1,map:(0,U.p)(Q)}},this.position=new o.Vector3,this.quaternion=new o.Quaternion,this.updateTargetPosition=e=>{this.position.copy((0,r.Xv)(e,d.f.UP,.05))},this.update=(e,t)=>{const i=(0,r.Rq)(e,this.quaternion);this.target.quaternion.copy(i),this.target.position.lerp(this.position,this.styles.animationSpeed),this.target.material.opacity=Math.min(t,this.styles.plane.opacity)},this.toggle=e=>{e?this.container.add(this.target):this.container.remove(this.target)};const t=new o.PlaneBufferGeometry(1),i=new o.Matrix4;i.makeRotationFromEuler(new o.Euler(-Math.PI/2,0,0,"XYZ")),t.applyMatrix4(i),this.target=new E.E(t,new o.MeshBasicMaterial(this.styles.plane)),this.target.name="Destination",this.target.scale.set(this.styles.scale,this.styles.scale,this.styles.scale)}}class XRControllerFocus{constructor(e){this.controllers=e,this._lastInputWas=0}focus(e){e!==this._lastInputWas&&(x.controllers.forEach((t=>{this.controllers.controller(t).grip.visible=t!==e})),this._lastInputWas=e)}}var _=i(57501);class XRControllerMesh{constructor(e){this.renderer=e,this._defaultController=0,this.controllerGroups=[],this.bindings=[],this.cancel=()=>{this.bindings.forEach((e=>e.cancel())),this.bindings.length=0},this.container=new o.Group,this.container.name="XRControllerMesh",x.controllers.forEach((e=>{const t=this.createControllerGroup(e);this.controllerGroups.push(t),this.container.add(t.grip,t.pointer)})),this.connectControllerModel(),this.container.matrixAutoUpdate=!1}controller(e=this._defaultController){return this.controllerGroups[e]}setDefault(e){this._defaultController=e}async connectControllerModel(){const e=new((await i.e(376).then(i.bind(i,58956))).XRControllerModelFactory);x.controllers.forEach((t=>{const i=this.controller(t).grip;i.add(e.createControllerModel(i))}))}createControllerGroup(e){const t=this.renderer.xr.getController(e);t.name=`Controller Ray ${e}`;const i=this.renderer.xr.getControllerGrip(e);i.name=`Controller Grip ${e}`,i.visible=!1;const s={index:e,pointer:t,grip:i,connected:!1,hand:"none"},n=e=>{s.hand=e.data.handedness,s.connected=!0},a=()=>{s.hand="none",s.connected=!1};return this.bindings.push((0,_.k1)((()=>t.addEventListener("connected",n)),(()=>t.removeEventListener("connected",n))),(0,_.k1)((()=>t.addEventListener("disconnected",a)),(()=>t.removeEventListener("disconnected",a)))),s}}const B=new s.Z("xr-input-forwarding");class XRControllerPointerEventAdapter{constructor(e){this.options=e,this.dispatchPointerDown=e=>{this.forwardEvent("pointerdown",this.mockPointerEventInit(e))},this.dispatchPointerUp=e=>{this.forwardEvent("pointerup",this.mockPointerEventInit(e))},this.target=e.forwardToElement}dispatchPointerMove(e){this.forwardEvent("pointermove",this.mockPointerEventInit(e))}mockPointerEventInit(e){let t=0,i=0;if(this.options.getPointerScreenPosition){const e=this.options.getPointerScreenPosition();t=e.x,i=e.y}return{pointerType:"gamepad",pointerId:e,clientX:t,clientY:i}}forwardEvent(e,t){let i;try{i=window.PointerEvent?new PointerEvent(e,t):new MouseEvent(e,t),i&&this.target.dispatchEvent(i)}catch(e){B.error(e)}}}class XRGamepadInput extends o.EventDispatcher{constructor(e,t){super(),this.renderer=e,this.options={forwardNativeXrEvents:!0,dispatchToControllerGroup:!1,axisMoveTriggerThreshold:.5},this.previousGamepad=new Map,this.forwardedEvents=["selectstart","select","selectend","squeeze","squeezestart","squeezeend"],this.active=!1,this.renew=()=>{!this.active&&this.options.forwardNativeXrEvents&&(this.addSessionListeners(),this.active=!0)},this.cancel=()=>{this.active&&this.options.forwardNativeXrEvents&&(this.removeSessionListeners(),this.active=!1)},this.updateFromGamepads=()=>{if(!this.active)return;const e=this.renderer.xr.getSession();if(e)for(const t of x.controllers){const i=e.inputSources[t];if(!i||!i.gamepad)continue;const s=this.renderer.xr.getController(t),n=this.previousGamepad.get(i),a={buttons:i.gamepad.buttons.map((e=>e.value)),axes:i.gamepad.axes.slice()},r={controllerIndex:t,inputSource:i,axes:a.axes};n&&(a.buttons.forEach(((e,t)=>{e!==n.buttons[t]&&(1===e?this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"buttondown",value:e,index:t})):0===e&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"buttonup",value:e,index:t})))})),a.axes.forEach(((e,t)=>{const i=n.axes[t];if(e!==i){this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axesmove",value:e,index:t})),0===i&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axesmovestart",value:e,index:t}));const n=this.options.axisMoveTriggerThreshold;Math.abs(i)<n&&Math.abs(e)>n&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axestriggered",value:e,index:t})),0===e&&this.sendGamepadEvent(s,Object.assign(Object.assign({},r),{type:"axesmoveend",value:e,index:t}))}}))),this.previousGamepad.set(i,a)}},this.onGamepadEvent=(e,t)=>(0,_.k1)((()=>super.addEventListener(e,t)),(()=>super.removeEventListener(e,t))),this.onSessionEvent=(e,t)=>(0,_.k1)((()=>super.addEventListener(e,t)),(()=>super.removeEventListener(e,t))),this.sendGamepadEvent=(e,t)=>{this.dispatchEvent(t),this.options.dispatchToControllerGroup&&e.dispatchEvent(t)},this.sendSessionEvent=(e,t)=>{this.dispatchEvent({type:e,controllerIndex:t})},this.addSessionListeners=()=>{x.controllers.forEach((e=>{const t=this.renderer.xr.getController(e);for(const i of this.forwardedEvents)t.addEventListener(i,(t=>this.sendSessionEvent(t.type,e)))}))},this.removeSessionListeners=()=>{x.controllers.forEach((e=>{const t=this.renderer.xr.getController(e);for(const i of this.forwardedEvents)t.removeEventListener(i,(t=>this.sendSessionEvent(t.type,e)))}))},t&&(this.options=Object.assign(Object.assign({},this.options),t)),this.renew()}}var H=i(38593),j=i(18317),X=i(86450),q=i(87131),Z=i(28281),Y=i(21265);var W=i(72942);const $=new s.Z("xr"),K=(new o.Quaternion).setFromAxisAngle(d.f.UP,o.MathUtils.DEG2RAD*x.rotationDegrees),J=(new o.Quaternion).setFromAxisAngle(d.f.UP,o.MathUtils.DEG2RAD*-x.rotationDegrees);class WebXRModule extends n.Y{constructor(){super(...arguments),this.name="webxr",this.framebufferScaledTo=1,this.framebufferScale=0,this.ray={forward:new o.Vector3,origin:new o.Vector3},this.onXrPresentBegin=()=>{const e=this.renderer.xr.getSession();$.info(`Session framebuffer: ${e.renderState.baseLayer}`),this.engine.commandBinder.issueCommand(new X.D(!0)),this.engine.commandBinder.issueCommand(new X.F(q.AB.HIGH)),this.viewmodeData.isPano()||this.engine.commandBinder.issueCommand(new W._i(W.BD.INSIDE)),this.xrPointer=new RaycastPointerWorld(this.raycaster.picking),this.raycaster.setOverridePointer(this.xrPointer),this.xrNavVisuals.activate()},this.onXrPresentEnd=()=>{const e=null!==this.settings.tryGetProperty(Z.YS,null);this.engine.commandBinder.issueCommand(new X.D(e)),this.engine.commandBinder.issueCommand(new X.F(this.config.navPanoSize)),this.xrNavVisuals.deactivate(),this.raycaster.setOverridePointer(null),this.cameraModule.updateCameraRotation((0,r.Rq)(this.cameraData.pose.rotation,new o.Quaternion)),this.webglScene.setCameraDirty()},this.onXrTrackingApplied=e=>{const t=this.controllerMesh.controller();if(t.connected){const i=this.ray.forward.copy(d.f.FORWARD).applyQuaternion(t.pointer.quaternion),s=this.ray.origin.setFromMatrixPosition(t.pointer.matrixWorld);this.xrPointer.update3D(s,i,e.trackedCamera),this.xrPointerInput.dispatchPointerMove(t.index)}this.xrGamepadInput.updateFromGamepads()},this.requestSession=async(e,t)=>{if(await(0,H.pl)()!==H.bk.webxr)return null;if(this.renderer.xr.isPresenting)return this.renderer.xr.getSession();if(j.Z.apiExists()){const i=await navigator.xr.requestSession(e,{optionalFeatures:t}),s=XRWebGLLayer.getNativeFramebufferScaleFactor(i);return this.framebufferScaledTo=this.framebufferScale*(s-1)+1,$.info("Scaling framebuffer by:",this.framebufferScaledTo,"native size:",s," * factor:",this.framebufferScale),0!==this.framebufferScale&&this.renderer.xr.setFramebufferScaleFactor(this.framebufferScaledTo),this.renderer.xr.setSession(i),i}return null}}async init(e,t){this.config=e,this.engine=t;const i=await t.getModule(g.default);this.renderer=i.threeRenderer,this.webglScene=i.getScene(),this.settings=await t.market.waitForData(m.e),this.bindings.push(t.commandBinder.addBinding(P.j,(e=>this.requestSession(e.type,e.features))));if(await(0,H.pl)()!==H.bk.webxr)return;[this.canvasModule,this.cameraModule,this.raycaster]=await Promise.all([t.getModule(l.default),t.getModule(h.default),t.getModule(u.default)]),[this.cameraData,this.raycasterData,this.viewmodeData]=await Promise.all([t.market.waitForData(c.M_),t.market.waitForData(p.P),t.market.waitForData(G.O)]),this.renderer.xr.setReferenceSpaceType("local"),this.framebufferScale=this.config.framebufferScaling||function(e){const t=(0,Y.tq)();return!t||t&&function(e){return/Adreno \(TM\) (540|[6-9]\d\d)/.test(e.renderer)}(e)?1:0}(i.gpuInfo);const s=new XRTrackingOverrides(t,this.renderer,this.webglScene,this.cameraData,this.cameraModule);s.setTrackingStyle(e.tracking),this.bindings.push(s.subscribe(XRStartPresentingMessage,this.onXrPresentBegin),s.subscribe(XRStopPresentingMessage,this.onXrPresentEnd),s.subscribe(XRTrackingAppliedMessage,this.onXrTrackingApplied)),this.controllerMesh=new XRControllerMesh(this.renderer),this.webglScene.add(this.controllerMesh.container);const n=new XRControllerFocus(this.controllerMesh),r=e.enableEventPositions?()=>this.raycasterData.pointerScreenPosition:void 0;this.xrPointerInput=new XRControllerPointerEventAdapter({forwardToElement:this.canvasModule.element,getPointerScreenPosition:r}),this.xrGamepadInput=new XRGamepadInput(this.renderer);const o=new a.V(this.xrGamepadInput.onGamepadEvent("axestriggered",(e=>{if(e.index===k.thumbstickX||e.index===k.touchpadX){$.debug(`${e.inputSource.handedness} ${k[e.index]} axis.value over threshold, do the rotate!`);Math.sign(e.value)>0?s.offsetRotation(K):s.offsetRotation(J)}n.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectstart",(e=>{this.xrPointerInput.dispatchPointerDown(e.controllerIndex),n.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("selectend",(e=>{this.xrPointerInput.dispatchPointerUp(e.controllerIndex),n.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})),this.xrGamepadInput.onSessionEvent("squeezestart",(e=>{n.focus(e.controllerIndex),this.controllerMesh.setDefault(e.controllerIndex)})));this.bindings.push(o,this.xrGamepadInput),this.xrNavVisuals=new XRNavigationVisuals,this.xrNavVisuals.init(t),this.webglScene.add(this.xrNavVisuals.container)}}const ee=WebXRModule}}]);