(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[164],{37024:(t,e,i)=>{"use strict";var r;i.d(e,{Z:()=>o}),function(t){t[t.None=0]="None",t[t.Queued=1]="Queued",t[t.ForceQueued=2]="ForceQueued",t[t.Downloading=3]="Downloading",t[t.Downloaded=4]="Downloaded",t[t.DownloadFailed=5]="DownloadFailed"}(r||(r={}));const o=r},20134:(t,e,i)=>{"use strict";i.d(e,{I6:()=>PriorityCriteria,at:()=>TilePrioritizer});var r,o=i(2212),s=i(84559),n=i(13338),a=i(37024),h=i(97620),u=i(87131),c=i(28281),l=i(67569),p=i(17321),d=i(81733),m=i(5442),T=i(19938),g=i(27829),w=i(21265),P=i(71208),y=i(66272);!function(t){t[t.None=0]="None",t[t.DirectionalFOV=1]="DirectionalFOV"}(r||(r={}));class PriorityCriteria{constructor(t,e,i,r){this.cameraRot=new o.Quaternion,this.sweep=t,this.cameraPosition=(new o.Vector3).copy(e),this.cameraDir=(new o.Vector3).copy(i),this.upcomingSweeps=r,this.zoomingActive=!1}}const S=(t,e,i=!1)=>{let r=0;if(t&&e)for(const o of e)i&&-1!==t.indexOf(o)||(t.push(o),r++);return r};class TilePrioritizer{constructor(t,e,i,r){this.panoQualityManager=t,this.tilingSettings=e,this.sweepData=i,this.raycaster=r,this.tempQueue=[],this.filterAndPrioritize=(t,e,i)=>{if(!this.priorityCriteria.sweep)return;const r=void 0!==this.priorityCriteria.upcomingSweeps&&null!==this.priorityCriteria.upcomingSweeps,o=this.tempQueue;o.length=0,this.queueTilesForPano(o,i,this.priorityCriteria.sweep,u.AB.BASE);const s=S(t,o,!0);this.currViewQueue[u.SL.BASE].value=s,this.fullPanoQueue[u.SL.BASE].value=s,r?this.queueForRestrictedSweeps(t,i):this.priorityCriteria.viewMode!==P.Ey.Panorama?this.queueForNonPanoViewmode(t,i):this.queueForPanoViewmode(t,e,i),this.tilingSettings.downloadFullPano&&this.queueFullPano(t,i)},this.queueRaycast=(()=>{const t=new o.Vector3;return(e,i)=>{if(this.priorityCriteria.sweep)if(this.priorityCriteria.hoveredSweep)this.queueTilesForPano(e,i,this.priorityCriteria.hoveredSweep,u.AB.BASE);else if(this.raycaster&&this.raycaster.hit){const r=t.copy(this.raycaster.hit.point).sub(this.priorityCriteria.sweep.position),o=this.getSinglePanoInDirection(r),s=this.sweepData.getSweep(o);s&&this.queueTilesForPano(e,i,s,u.AB.BASE)}}})(),this.queueRaycastIntersection=(t,e)=>{if(!this.raycaster||!this.raycaster.hit)return;const i=(0,y.b)(this.sweepData,!1,this.raycaster.hit.intersection),r=i.length>0?i[0].sweep:this.sweepData.getClosestSweep(this.raycaster.hit.point,!0);r&&this.queueTilesForPano(t,e,r,u.AB.BASE)},this.getSweepIdInLocalDirection=(()=>{const t=new o.Vector3;return e=>{const i=this.priorityCriteria.cameraRot,r=t.copy(e).applyQuaternion(i);return this.getSinglePanoInDirection(r)}})(),this.persistentStorage=new l.a,this.maxResolution=t.getNavPanoSize(),this.currViewQueue=f(),this.fullPanoQueue=f(),this.isMobileDevice=(0,w.tq)(),this.priorityCriteria=new PriorityCriteria(null,new o.Vector3(0,0,0),new o.Vector3(0,0,-1))}getQualityQueueSize(t,e){return t===T.v.CurrentView?this.currViewQueue[e].value:this.fullPanoQueue[e].value}makeQueueSubscription(t,e,i){return(t===T.v.CurrentView?this.currViewQueue[e]:this.fullPanoQueue[e]).onChanged(i)}updateCriteria(t,e,i,r){this.priorityCriteria.sweep=t,this.priorityCriteria.cameraPosition.copy(e),this.priorityCriteria.cameraDir.copy(i),this.priorityCriteria.cameraRot.copy(r)}setHoveredSweep(t){this.priorityCriteria.hoveredSweep=t}setUpcomingSweeps(t){this.priorityCriteria.upcomingSweeps=t}clearUpcomingSweeps(){this.priorityCriteria.upcomingSweeps=void 0}setDownloadFOV(t){TilePrioritizer.DIRECTIONAL_FOV=t}queueForRestrictedSweeps(t,e){if(!this.priorityCriteria.upcomingSweeps)return;let i=0;for(const r of this.priorityCriteria.upcomingSweeps)if(i++,this.queueTilesForPano(t,e,r,u.AB.BASE),i>=3)break;this.queueFOVStandardNarrow(t,e),this.queueFOVHighNarrow(t,e)}queueForPanoViewmode(t,e,i){this.queueRaycast(t,i),this.queueFOVStandardNarrow(t,i),this.queueScoredSweeps(t,e,i),this.queueFOVHighNarrow(t,i),this.isMobileDevice||this.queueWASD(t,e,i)}queueForNonPanoViewmode(t,e){this.queueRaycastIntersection(t,e)}queueFOVTiles(t,e,i,r){if(!this.priorityCriteria.sweep)return 0;const o=u.eE[e];return this.canDownloadSize(this.priorityCriteria.sweep,e)?this.queueTilesInDirectionForPano(t,r,this.priorityCriteria.sweep,o,this.priorityCriteria.cameraDir,i):0}queueScoredSweeps(t,e,i){if(this.priorityCriteria.sweep&&this.maxResolution<=2048){const r=this.persistentStorage.getArray("filterAndPrioritize:scoredSweeps");this.populateScoredSweeps(this.priorityCriteria.sweep,e,r,this.priorityCriteria.cameraDir,6),this.queueTilesForPanos(t,r,i,u.AB.BASE,4)}}queueFOVStandardNarrow(t,e){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;i.length=0;const r=this.queueFOVTiles(i,u.SL.STANDARD,TilePrioritizer.DIRECTIONAL_FOV,e);TilePrioritizer.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.cameraDir),S(t,i),this.currViewQueue[u.SL.STANDARD].value=r,this.fullPanoQueue[u.SL.STANDARD].value=r}queueFOVHighNarrow(t,e){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;i.length=0;const r=this.queueFOVTiles(i,u.SL.HIGH,TilePrioritizer.DIRECTIONAL_FOV,e),o=this.queueFOVTiles(i,u.SL.ULTRAHIGH,TilePrioritizer.DIRECTIONAL_FOV,e);TilePrioritizer.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.cameraDir),S(t,i),this.currViewQueue[u.SL.HIGH].value=r,this.currViewQueue[u.SL.ULTRAHIGH].value=o}queueFullPano(t,e){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;if(i.length=0,this.maxResolution<=u.AB.HIGH){if(this.canDownloadSize(this.priorityCriteria.sweep,u.SL.HIGH)){const t=this.queueTilesForPano(i,e,this.priorityCriteria.sweep,u.AB.HIGH);this.fullPanoQueue[u.SL.HIGH].value=t}}else if(this.canDownloadSize(this.priorityCriteria.sweep,u.SL.ULTRAHIGH)){const t=this.queueTilesForPano(i,e,this.priorityCriteria.sweep,u.AB.ULTRAHIGH);this.fullPanoQueue[u.SL.ULTRAHIGH].value=t}TilePrioritizer.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.cameraDir),S(t,i,!0)}queueWASD(t,e,i){const r=this.persistentStorage.getArray("filterAndPrioritize:neighbors")||[];if(r.length=0,!this.priorityCriteria.sweep)return;const o=[g.f.FORWARD,g.f.RIGHT,g.f.LEFT,g.f.BACK];for(const t of o){const i=this.getSweepIdInLocalDirection(t),o=e.get(i);o&&r.push(o)}this.queueTilesForPanos(t,r,i,u.AB.BASE)}canDownloadSize(t,e){const i=u.eE[e],r=this.panoQualityManager.getNavPanoSize()>=i||this.maxResolution>=i&&this.panoQualityManager.getZoomPanoSize()>=i,o=this.panoQualityManager.getTestResults(t.id,e);return r&&o===s.S.Untested&&this.panoQualityManager.testDownload(t,e,n.I_),o===s.S.Success&&r}populateScoredSweeps(t,e,i,r,s){(i=i||[]).length=0;const n=(new o.Vector3).copy(t.position),a=[p._k(),p.ff(t),p.jN(n,400),p.pI(n,r,.75)],h=[d.Dv(n,c.Xd.navigation.distanceFactor),d.o7(n,r,c.Xd.navigation.directionFactor)],u=this.sweepData.getSweepNeighbours(t),l=this.sweepData.sortByScore(a,h,u);for(let t=0;t<l.length&&t<s;t++){const e=l[t].sweep;i.push(e)}}queueTilesForPanos(t,e,i,r,o){let s=0;for(const n of e){if(s+=this.queueTilesForPano(t,i,n,r)>0?1:0,o&&s>=o)break}return s}queueTilesForPano(t,e,i,o){const s=this.persistentStorage.get("queueTilesForSweep:filterCriteria",(()=>({filter:r.None})));return this.filterAndQueueTileDownloadDescriptors(t,e,i,o,s)}queueTilesInDirectionForPano(t,e,i,s,a,h){const u=this.persistentStorage.get("queueTilesInDirectionForSweep:panoSpaceDir",(()=>new o.Vector3)),c=this.persistentStorage.get("queueTilesInDirectionForSweep:filterCriteria",(()=>({filter:r.DirectionalFOV,direction:new o.Vector3,fov:60})));return u.copy(a),n.ym(i.rotation,u),c.direction.copy(u),c.fov=h,this.filterAndQueueTileDownloadDescriptors(t,e,i,s,c)}filterAndQueueTileDownloadDescriptors(t,e,i,r,o){const s=this.persistentStorage.getArray("filterAndQueueTileDownloadDescriptors:descriptors"),n=e.getTileDownloadDescriptors(i,r);s.length=0,this.filterTileDownloadDescriptors(n,s,o);let a=0;for(const e of s)e&&(t.push(e),a++);return a}filterTileDownloadDescriptors(t,e,i){let o,s;switch(i.filter){case r.DirectionalFOV:for(o=0;o<t.length;o++)s=t[o],s&&n.eO(s.panoSize,s.tileSize,s.face,s.tileX,s.tileY,i.direction,i.fov)&&e.push(s);break;default:for(o=0;o<t.length;o++)s=t[o],e.push(s)}for(o=0;o<e.length;o++)s=e[o],s&&!this.canIncludeDescriptor(s)&&(e[o]=null)}canIncludeDescriptor(t){return t.status!==a.Z.Downloading&&t.status!==a.Z.Downloaded}static sortTiles(t,e,i){D.panoSpaceDir.copy(i),n.ym(e.rotation,D.panoSpaceDir),D.fovThresholdNarrow=h.tf(TilePrioritizer.DIRECTIONAL_FOV),t.sort(v)}static insertSortedPanoTile(t,e,i,r){D.panoSpaceDir.copy(r),n.ym(i.rotation,D.panoSpaceDir),D.fovThresholdNarrow=h.tf(TilePrioritizer.DIRECTIONAL_FOV);let o=-1;for(let i=0;i<t.length;i++){if(v(e,t[i])<=0){o=i;break}}if(-1===o)t[t.length]=e;else{for(let e=t.length;e>o;e--)t[e]=t[e-1];t[o]=e}}getSinglePanoInDirection(t){const e=this.priorityCriteria.sweep;if(!e)return"";const i=[p.ff(e),p._k(),p.pI(e.position,t)],r=[d.o7(e.position,t),d.TE(e.position)],o=e.neighbours.filter((t=>{const e=this.sweepData.getSweep(t);return i.every((t=>t(e)))})).map((t=>{const e=this.sweepData.getSweep(t);return{sweepId:t,score:r.reduce(((t,i)=>t+i(e)),0)}})),s=o.reduce(((t,e)=>t.score>e.score?t:e),o[0]);return s?s.sweepId:""}}TilePrioritizer.DIRECTIONAL_FOV=120;const D={panoSpaceDir:new o.Vector3,fovThresholdNarrow:-1},v=(t,e)=>{const i=D.panoSpaceDir,r=D.fovThresholdNarrow,o=Math.max(Math.min(i.dot(t.direction),1),-1),s=Math.max(Math.min(i.dot(e.direction),1),-1);return o>=r&&s<r?-1:o<r&&s>=r||t.panoSize>e.panoSize?1:e.panoSize>t.panoSize?-1:-(o-s)};function f(){return{[u.SL.BASE]:(0,m.Y)(0),[u.SL.STANDARD]:(0,m.Y)(0),[u.SL.HIGH]:(0,m.Y)(0),[u.SL.ULTRAHIGH]:(0,m.Y)(0)}}},67868:(t,e,i)=>{"use strict";i.d(e,{A:()=>OrientationHelper});var r=i(2212),o=i(27829);const s={sharpTurnDotThreshold:.65,directionWeightFactorStd:.75,directionWeightFactorSharp:.2,positionalWeightFactorStd:.4,positionalWeightFactorSharp:.2,finalWalkingNodeDirectionWeight:5,lookAheadNodes:3};class OrientationHelper{constructor(t=s){this.settings=t}getOrientationsForPath(t,e){const i=[];for(let s=0;s<t.length;s++){const n=new r.Vector3;this.getLookVectorsForPathNode(t,s,e,n);const a=(new r.Matrix4).lookAt(t[s],n,o.f.UP);i[s]=(new r.Quaternion).setFromRotationMatrix(a)}return i.push(e),i}getLookVectorsForPathNode(t,e,i,o){const s=new r.Vector3,n=new r.Vector3,a=new r.Vector3,h=new r.Vector3,u=t.length;if(e>=u)return!1;let c=1,l=1;const p=new r.Vector3;let d;for(let r=e;r<e+this.settings.lookAheadNodes&&r<u;r++){if(d=t[r],this.getOrientationForPathNode(t,r,i,a),r===e&&s.copy(a),r>e){const t=s.dot(a)<this.settings.sharpTurnDotThreshold;c*=t?this.settings.directionWeightFactorSharp:this.settings.directionWeightFactorStd,l*=t?this.settings.positionalWeightFactorSharp:this.settings.positionalWeightFactorStd}r===u-1&&(c=this.settings.finalWalkingNodeDirectionWeight,l=1),p.copy(a),a.multiplyScalar(c),n.add(a),h.lerp(d,l)}return n.normalize(),o.copy(h),o.add(n),!0}getOrientationForPathNode(t,e,i,r){if(e>=t.length)return!1;if(e===t.length-1)r.copy(o.f.FORWARD).applyQuaternion(i);else{const i=t[e],o=t[e+1];r.copy(o).sub(i)}return r.normalize(),!0}}},65619:(t,e,i)=>{"use strict";i.r(e),i.d(e,{FAST_FORWARD_FACTOR:()=>_,default:()=>ToursControlsModule});var r=i(28247),o=i(27545),s=i(54122),n=i(71208),a=i(98728),h=i(12775),u=i(47924),c=i(30963),l=i(53339),p=i(36073),d=i(30604),m=i(78626),T=i(22767),g=i(29675),w=i(3471),P=i(39936),y=i(89155),S=i(2212),D=i(97620),v=i(19334),f=i(62431),C=i(21265),F=i(17694),M=i(44228),I=i(62367);class TourDelayTransition{constructor(t){this.settingsData=t,this.type=M.Aq.Delay,this.toIndex=-1,this.currentTransitionPromise=null,this.cancelDelay=()=>null}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(this.cancelDelay(),this.currentTransitionPromise=null)}start(){if(this.active)throw Error("Transition already active");const t=(0,I.Ig)(TourTransitionFactory.getDelayDuration(this.settingsData));return this.cancelDelay=()=>{t.cancel()},this.currentTransitionPromise=t.promise.then((()=>this.stop())),this}}class TourZoomTransition{constructor(t,e,i){this.settingsData=t,this.zoom=e,this.stopZooming=i,this.type=M.Aq.Zoom,this.toIndex=-1,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(){if(this.active)throw Error("Transition already active");const t=TourTransitionFactory.getZoomDuration(this.settingsData);return this.currentTransitionPromise=this.zoom(t,-5e-4).then((()=>{this.currentTransitionPromise=null})),this.onStopRequested=async()=>{await this.stopZooming()},this}}var A=i(27829),R=i(45805);class TourPanTransition{constructor(t,e,i){this.settingsData=t,this.rotate=e,this.stopRotating=i,this.type=M.Aq.Burns,this.toIndex=-1,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve(),this.getPanDirection=(t,e)=>{let i=M.kw.Right;if(t&&t.metadata.scanId&&t.metadata.cameraQuaternion&&t.metadata.cameraPosition&&e&&e.metadata.scanId&&e.metadata.cameraPosition&&e.metadata.cameraQuaternion){const r=A.f.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),o=e.metadata.cameraPosition,s=t.metadata.cameraPosition;let n=o.clone().sub(s).normalize();n.lengthSq()<R.Z.epsilon&&(n=A.f.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion)),r.cross(n).y>0&&(i=M.kw.Left)}return i}}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(t){if(this.active)throw Error("Transition already active");if(!t)throw Error("Tour pan requires two snapshots");if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null})),this}build(t,e,i){const{panDirection:r,panAngle:o}=i,s=TourTransitionFactory.getPanValues(this.settingsData,!1,r,o);let n=s.direction;void 0!==n&&n!==M.kw.Auto||(n=this.getPanDirection(t,e)),this.onStopRequested=async()=>{await this.stopRotating()};return{deferred:this.rotate(s.ms,new S.Vector2(n*s.radiansPerMs,0))}}}var b=i(1799),V=i(44266);const q=.001,E=(t,e,i,r)=>{const o=Math.min(t.distanceTo(e),5),s=o*(1/r)*1e3;let n=s;const a=i/s;if(a>q){n+=n*((a-q)/q)}const h=Math.abs(t.clone().setX(0).setZ(0).distanceTo(e.clone().setX(0).setZ(0))/Math.max(o,1));if(h>.1){n*=.9+.75*h}return n};class TourDirectWalkingTransition{constructor(t,e,i,r,o,s){this.settingsData=t,this.cameraPose=e,this.moveToSweep=i,this.updateTransitionSpeed=r,this.setRestrictedSweeps=o,this.generators=s,this.toIndex=-1,this.currentGenerator=null,this.currentTransitionPromise=null,this.type=M.Aq.Move}get active(){return null!==this.currentTransitionPromise||null!==this.currentGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null),this.currentGenerator&&(this.generators.stopGenerator(this.currentGenerator),this.currentGenerator=null)}start(t){if(this.active)throw Error("Transition already active");const{generator:e,deferred:i}=this.build(t.path,t.orientations);return this.generators.startGenerator(e),this.currentGenerator=e,this.currentTransitionPromise=i.nativePromise(),this}build(t,e){const i=new V.Q,o=this;let s=!1;return this.onStopRequested=async()=>{s=!0,await this.updateTransitionSpeed(_)},{generator:function*(){let n=1;for(;n<t.length&&!s;){const i=n-1,s=t[n],a=s.position,h=t[i],c=e[n],l=(0,D.zW)(o.cameraPose.rotation,c),p=TourTransitionFactory.getTransitionSpeed(o.settingsData),d=E(h.position,a,l,p),m={transitionType:u.n.Interpolate,sweepId:s.id,rotation:c,transitionTime:d,easing:b.vG};o.setRestrictedSweeps(t,i);const T=o.moveToSweep(m);yield new r.M8(T.nativePromise()),n++}o.setRestrictedSweeps(null),i.resolve(),o.currentTransitionPromise=null,o.stop()},deferred:i}}}var G=i(22729);const x=new(i(25799).Z)("tours");class TourSmoothWalkingTransition{constructor(t,e,i,o,s,n,a,h,c){this.settingsData=t,this.cameraPose=e,this.cameraTransition=i,this.sweepTransition=o,this.sweepControl=s,this.cameraControl=n,this.generators=a,this.setRestrictedSweeps=h,this.getCurve=c,this.type=M.Aq.Path,this.toIndex=-1,this.currentTransitionGenerator=null,this.currentTransitionPromise=null,this.canceling=!1,this.buildTransition=(t,e)=>{if(t.length<=2)throw x.debug(`invalid path: ${t}`),new Error("smooth path requires more than 2 stops");const i=this,o=new V.Q;i.setRestrictedSweeps(t);const s=t.map((t=>t.position)),n=i.getCurve(s),a=b.vG,h=b.Fs,c=b.to,l=TourTransitionFactory.getTransitionSpeed(i.settingsData),p=((t,e,i)=>{let r=0;for(let o=0;o<t.length-1;o++){const s=(0,D.zW)(e[o],e[o+1]);r+=E(t[o].position,t[o+1].position,s,i)}return r})(t,e,l);x.debug(`path duration: ${p.toFixed(0)}ms, at speed: ${l}m/s`),i.cameraControl.beginExternalTransition();return{generator:function*(){o.notify(0);const s=new S.Vector3,d=new S.Quaternion;let m=0,T=0,g=0,w=1,P=t[w].id;yield new r.M8(i.sweepControl.activateSweepUnsafe({sweepId:P})),i.sweepControl.beginSweepTransition({sweepId:P,transitionTime:p,internalProgress:!1}),t.length>2&&i.sweepControl.activateSweepUnsafe({sweepId:t[2].id});let y=i.cameraPose.rotation.clone();for(;m<p&&!i.canceling;){const u=m/p;g>0&&(y=e[g].clone());const l=e[w],S=n.normalSourceDistances[g],v=n.normalSourceDistances[w],f=t[w];if(T=(0,D.et)(u,S,v,0,1),T<=1){const t=c(T,0,1,1);i.sweepTransition.progress.modifyAnimation(t,1,0);const e=h(T,0,1,1);d.copy(y).slerp(l,e)}u<1&&s.copy(n.curve.getPointAt(a(u,0,1,1))),i.cameraControl.updateCameraPosition(s),i.cameraControl.updateCameraRotation(d),u>=v&&(i.sweepControl.endSweepTransition({sweepId:f.id}),g++,w++,P=t[g+1].id,yield new r.M8(i.sweepControl.activateSweepUnsafe({sweepId:P})),i.sweepControl.beginSweepTransition({sweepId:P,transitionTime:p,internalProgress:!1}),t.length>g+2&&i.sweepControl.activateSweepUnsafe({sweepId:t[g+2].id})),o.notify(u),m=Date.now()-i.cameraTransition.startTime,yield new r.Jj}if(i.cameraControl.endExternalTransition(),i.canceling){i.canceling=!1;const e=t[w].position,o=E(i.cameraPose.position,e,0,l),s=i.cameraControl.moveTo({transitionTime:o/_,transitionType:u.n.Interpolate,pose:{position:e}});s.progress((t=>{const e=(0,D.et)(t,0,1,T,1);i.sweepTransition.progress.modifyAnimation(e,1,0)})),yield new r.M8(s.nativePromise())}i.sweepControl.endSweepTransition({sweepId:P}),i.setRestrictedSweeps(null),o.notify(1),o.resolve()},deferred:o}}}get active(){return null!==this.currentTransitionPromise||null!==this.currentTransitionGenerator}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.canceling=!0,this.currentTransitionPromise&&(await this.promise,this.currentTransitionPromise=null),this.currentTransitionGenerator&&(this.generators.stopGenerator(this.currentTransitionGenerator),this.currentTransitionGenerator=null)}start(t){if(x.debug(`starting smooth transition with ${t.path.length-1} stops`),this.active)throw Error("Transition already active");this.canceling=!1;const{generator:e,deferred:i}=this.buildTransition(t.path,t.orientations);return this.generators.startGenerator(e),this.currentTransitionGenerator=e,this.currentTransitionPromise=i.nativePromise().then((()=>{this.currentTransitionPromise=null,this.currentTransitionGenerator=null})),this}}var O=i(94210),Q=i(77956),B=i(89895),k=i(20949),N=i(60959);class TourDefaultTransition{constructor(t,e,i,r,o,s,n,a){this.settingsData=t,this.cameraPose=e,this.viewmodeData=i,this.cameraControl=r,this.sweepControl=o,this.switchToMode=s,this.setRestrictedSweeps=n,this.generators=a,this.toIndex=-1,this.type=M.Aq.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(t){if(this.active)throw Error("Transition already active");if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.currentSweep,t.transitionType);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null})),this}build(t,e,i){let r=Promise.resolve();const o=t.metadata.cameraMode,s=t.metadata.cameraQuaternion,n=t.metadata.scanId,a=this.cameraPose.rotation,h=(0,D.zW)(a,s),u=t.metadata.cameraPosition,c=!t.is360,l={position:u,rotation:s,sweepID:n,zoom:t.metadata.orthoZoom};if(o!==this.viewmodeData.currentMode){const t=TourTransitionFactory.getOtherModeTransitionTime(this.settingsData,h,i);r=this.switchToMode(o,i,l,t)}else{if(!!n&&this.viewmodeData.isPano()){if(!e||n!==e){const t=TourTransitionFactory.getTransitionTime(this.settingsData);r=this.standardTransitionSweepMovePromise(l,n,c,t)}else{const t=TourTransitionFactory.getSamePanoTransitionTime(this.settingsData,h);r=this.standardTransitionSameSweepRotationPromise(l,h,t)}}else r=this.cameraControl.moveTo({transitionType:i,pose:l,transitionTime:TourTransitionFactory.getOtherModeTransitionTime(this.settingsData,h,i)}).nativePromise()}return{deferred:r}}standardTransitionSameSweepRotationPromise(t,e,i){if(!t.rotation)throw Error("Rotation transition requires a rotation");return e<.01?Promise.resolve():(this.setRestrictedSweeps(null),this.cameraControl.moveTo({transitionType:u.n.Interpolate,pose:{rotation:t.rotation},transitionTime:i}).nativePromise())}standardTransitionSweepMovePromise(t,e,i,o){if(!t.position)throw Error("Push transition requires a position");const s=t.position.clone().sub(this.cameraPose.position).normalize(),n=this.cameraPose.position.clone().add(s.multiplyScalar(.15)),a=new V.Q;this.setRestrictedSweeps(null);const h=this;return this.generators.startGenerator((function*(){yield new r.M8(h.sweepControl.activateSweepUnsafe({sweepId:e}));const s=new S.Vector3,c=h.cameraPose.position.clone(),l=Date.now();let p,d=0,m=!1,T=!1;for(;d<o;){const a=(0,b.FG)(d,0,d/o,o);i&&h.cameraControl.updateCameraPosition(s.copy(c).lerp(n,a)),a>=.3&&!T&&(p=h.cameraControl.moveTo({transitionType:u.n.FadeToBlack,pose:t,transitionTime:o,blackoutTime:.5*o}).progress((t=>{t>=.5&&!m&&(h.sweepControl.instantSweepTransition(e),m=!0)})),T=!0),yield new r.Jj,d=Date.now()-l}p&&(yield new r.M8(p.nativePromise())),a.resolve()})),a.nativePromise()}}class TourInstantTransition{constructor(t,e,i,r){this.moveToSweep=t,this.viewmodeData=e,this.cameraControl=i,this.switchToMode=r,this.toIndex=-1,this.type=M.Aq.Move,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(t){if(this.active)throw Error("Transition already active");if(!t.snapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.currentSweep);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null})),this}build(t,e){let i=Promise.resolve();const r=t.metadata.cameraMode,o=t.metadata.cameraQuaternion,s=t.metadata.scanId,n={position:t.metadata.cameraPosition,rotation:o,sweepID:s,zoom:t.metadata.orthoZoom},a=r!==this.viewmodeData.currentMode,h=!!s&&this.viewmodeData.isPano();if(a)i=this.switchToMode(r,u.n.Instant,n);else if(h){const t={transitionType:u.n.Instant,sweepId:s,rotation:o};i=this.moveToSweep(t).nativePromise()}else i=this.cameraControl.moveTo({transitionType:u.n.Instant,pose:n}).nativePromise();return{deferred:i}}}var L=i(89997),z=i(86682);class TourFloorChangeTransition{constructor(t,e){this.issueCommand=t,this.currentFloorId=e,this.type=M.Aq.FloorChange,this.toIndex=-1,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(t){if(this.active)throw Error("Transition already active");let e=Promise.resolve();const i=t.targetSnapshot.metadata.floorId,r=i!==this.currentFloorId(),o=t.targetSnapshot.metadata.cameraMode;return o!==n.Ey.Panorama&&o!==n.Ey.Outdoor&&r&&(e=this.issueCommand(new z.Vw(i,!0))),this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null})),this}}class TourDollhousePanTransition{constructor(t,e,i){this.settingsData=t,this.rotate=e,this.stopRotating=i,this.type=M.Aq.Burns,this.toIndex=-1,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(t){if(this.active)throw Error("Transition already active");if(!t.snapshot||!t.nextSnapshot)return this.currentTransitionPromise=Promise.resolve(),this;const{deferred:e}=this.build(t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null})),this}build(t,e,i){const{panDirection:r,panAngle:o}=i,s=TourTransitionFactory.getPanValues(this.settingsData,!0,r,o);let n=-1*s.radiansPerMs;const a=s.direction;if(void 0!==a&&a!==M.kw.Auto)n*=a;else if(t&&t.metadata.cameraQuaternion&&e&&e.metadata.cameraQuaternion){const i=A.f.FORWARD.clone().applyQuaternion(t.metadata.cameraQuaternion),r=A.f.FORWARD.clone().applyQuaternion(e.metadata.cameraQuaternion),o=Math.sign(i.cross(r).y);n=0!==o?n*o:n}this.onStopRequested=async()=>{await this.stopRotating()};return{deferred:this.rotate(s.ms,new S.Vector2(n,0))}}}class TourPanTransitionLegacy{constructor(t,e,i,r,o){this.settingsData=t,this.cameraPose=e,this.rotate=i,this.stopRotating=r,this.getCurve=o,this.type=M.Aq.Burns,this.toIndex=-1,this.currentTransitionPromise=null,this.onStopRequested=()=>Promise.resolve()}get active(){return null!==this.currentTransitionPromise}get promise(){return this.currentTransitionPromise?this.currentTransitionPromise:Promise.resolve()}async stop(){this.currentTransitionPromise&&(await this.onStopRequested(),await this.promise,this.currentTransitionPromise=null)}start(t){if(this.active)throw Error("Transition already active");const{deferred:e}=this.build(t.path,t.snapshot,t.nextSnapshot,t.panOverrides);return this.currentTransitionPromise=e.then((()=>{this.currentTransitionPromise=null})),this}build(t,e,i,r){this.onStopRequested=async()=>{await this.stopRotating()};const{panDirection:o,panAngle:s}=r,a=TourTransitionFactory.getPanValues(this.settingsData,!1,o,s),h=a.direction;let u=a.radiansPerMs;if(void 0!==h&&h!==M.kw.Auto)u*=h;else if(t){const e=this.cameraPose.position.clone().setY(0),i=t.map((t=>t.position)),r=this.getCurve(i).curve.getPointAt(.1).setY(0).clone().sub(e).normalize(),o=A.f.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),s=Math.sign(o.cross(r).y);u=0!==s?u*s:u}else if(i&&e){if(e.metadata.cameraMode!==n.Ey.Panorama&&(u=-u),e.metadata.scanId===i.metadata.scanId){const t=A.f.FORWARD.clone().applyQuaternion(this.cameraPose.rotation),e=A.f.FORWARD.clone().applyQuaternion(i.metadata.cameraQuaternion),r=Math.sign(t.cross(e).y);u=0!==r?u*r:u}}return{deferred:this.rotate(a.ms,new S.Vector2(u,0))}}}var H=i(67868);class TourTransitionFactory{constructor(t,e,i,r,s){this.engine=t,this.tourData=e,this.cameraData=i,this.settingsData=r,this.viewmodeData=s,this.init=async()=>{this.sweepModule=await this.engine.getModule(O.default),this.sweepData=await this.engine.market.waitForData(Q.Z),this.cameraModule=await this.engine.getModule(B.default),this.pathModule=await this.engine.getModule(k.default),this.floorsViewData=await this.engine.market.waitForData(G.c),this.commonControlsModule=await this.engine.getModule(N.default),this.viewmodeModule=await this.engine.getModule(L.default),this.smoothWalkingTransition=new TourSmoothWalkingTransition(this.settingsData,this.cameraData.pose,this.cameraData.transition,this.sweepData.transition,this.sweepModule,this.cameraModule,this.engine,this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.pathModule.getCurveForPath.bind(this.pathModule)),this.directWalkingTransition=new TourDirectWalkingTransition(this.settingsData,this.cameraData.pose,this.sweepModule.moveToSweep.bind(this.sweepModule),this.cameraModule.updateTransitionSpeed.bind(this.cameraModule),this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.engine),this.instantTransition=new TourInstantTransition(this.sweepModule.moveToSweep.bind(this.sweepModule),this.viewmodeData,this.cameraModule,this.viewmodeModule.switchToMode.bind(this.viewmodeModule)),this.panTransition=new TourPanTransition(this.settingsData,this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.commonControlsModule.stop.bind(this.commonControlsModule)),this.panLegacyTransition=new TourPanTransitionLegacy(this.settingsData,this.cameraData.pose,this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.commonControlsModule.stop.bind(this.commonControlsModule),this.pathModule.getCurveForPath.bind(this.pathModule)),this.panDollhouseTransition=new TourDollhousePanTransition(this.settingsData,this.commonControlsModule.startRotateTransition.bind(this.commonControlsModule),this.commonControlsModule.stop.bind(this.commonControlsModule)),this.defaultTransition=new TourDefaultTransition(this.settingsData,this.cameraData.pose,this.viewmodeData,this.cameraModule,this.sweepModule,this.viewmodeModule.switchToMode.bind(this.viewmodeModule),this.pathModule.setRestrictedSweeps.bind(this.pathModule),this.engine),this.zoomTransition=new TourZoomTransition(this.settingsData,this.commonControlsModule.startZoomTransition.bind(this.commonControlsModule),this.commonControlsModule.stop.bind(this.commonControlsModule)),this.floorChangeTransition=new TourFloorChangeTransition(this.engine.commandBinder.issueCommand.bind(this.engine.commandBinder),(()=>this.floorsViewData.currentFloorId)),this.delayTransition=new TourDelayTransition(this.settingsData),this.nopTransition={active:!1,type:M.Aq.Nop,promise:Promise.resolve(),stop:()=>Promise.resolve(),toIndex:-1},this.pathOrientHelper=new H.A},this.getValidWalkingPath=t=>{const e=t.metadata.scanId,i=this.sweepData.currentSweep,r=this.tourData.getTourCurrentSnapshotIndex();let s=null;if(r>=0){const t=this.tourData.getTourSnapshotSid(r);s=this.tourData.getSnapshot(t)}if(this.viewmodeData.currentMode!==n.Ey.Panorama||!i||!e||e===i||t.is360||!s||s.is360)return null;const a=this.pathModule.findShortestPath(i,e,o.Xd.walkingTourIncludeExtraPanosDistance,o.Xd.walkingStageMinimumDistance,o.Xd.maxWalkingSweepsBetweenSnapshots)||[];return 0===a.length?null:a}}static getPanDegrees(t,e){let i;return i=o.Xd.panAtSnapshot?-1!==(0,C.hu)("sspa",-1)?o.Xd.snapshotPanAngle:void 0!==e?e:t.tryGetProperty(f.gx.PanAngle,o.BA):0,Math.max(i,0)}static getPanRadiansPerMs(t,e,i){if(-1!==(0,C.hu)("st",-1))return o.Xd.snapshotPanZoomDuration>0?i/o.Xd.snapshotPanZoomDuration:0;const r=e?t.tryGetProperty(f.gx.DollhousePanSpeed,o.su):t.tryGetProperty(f.gx.PanSpeed,o.pn);return(0,F.DA)(r)}getFloorTransition(t){const e=this.tourData.getTourSnapshotSid(t),i=this.tourData.getSnapshot(e);if(!i)return this.nopTransition;return this.floorChangeTransition.start({targetSnapshot:i})}getMainTransition(t,e){const i=this.tourData.getTourSnapshotSid(t),r=this.tourData.getSnapshot(i);if(!r)return this.nopTransition;let o=null;if(e===u.n.Interpolate){const t=r.metadata.cameraQuaternion,e=this.getValidWalkingPath(r);if(e){const i=e.map((t=>t.position)),r=this.pathOrientHelper.getOrientationsForPath(i,(0,D.Z)(t));o=e.length>2?this.smoothWalkingTransition.start({path:e,orientations:r}):this.directWalkingTransition.start({path:e,orientations:r})}}else if(e===u.n.Instant){const t=this.sweepData.currentSweep;o=this.instantTransition.start({snapshot:r,currentSweep:t})}if(!o){const t=this.sweepData.currentSweep;o=this.defaultTransition.start({snapshot:r,currentSweep:t,transitionType:e})}return o}getBurnsTransition(t,e){const i=this.tourData.getTourSnapshotSid(t),r=(t+1)%this.tourData.getSnapshotCount(),o=this.tourData.getTourSnapshotSid(r),s=this.tourData.getHighlightDescription(i),n={};s.reelEntry&&s.reelEntry.overrides&&(n.panDirection=s.reelEntry.overrides.panDirection,n.panAngle=s.reelEntry.overrides.panAngle);const a=this.tourData.getSnapshot(o);let h=this.nopTransition;switch(e){case M.BZ.Pan:if(a){const t=this.getValidWalkingPath(a);h=this.panLegacyTransition.start({path:t,snapshot:s.snapshot,nextSnapshot:a,panOverrides:n})}h===this.nopTransition&&(h=this.panTransition.start({snapshot:s.snapshot,nextSnapshot:a,panOverrides:n}));break;case M.BZ.PanDollhouse:h=this.panDollhouseTransition.start({snapshot:s.snapshot,nextSnapshot:a,panOverrides:n});break;case M.BZ.Zoom:h=this.zoomTransition.start();break;case M.BZ.Delay:h=this.delayTransition.start();break;case M.BZ.None:h=this.nopTransition;break;default:throw Error("unhandled TourBurnsStyle")}return h}}TourTransitionFactory.useDelayTransition=(t,e,i)=>!o.Xd.panAtSnapshot||e!==M.BZ.Zoom&&0===TourTransitionFactory.getPanDegrees(t,i),TourTransitionFactory.getPanDirection=(t,e)=>void 0!==e?e:t.tryGetProperty(f.gx.PanDirection,v.y6),TourTransitionFactory.getDelayDuration=t=>-1!==(0,C.hu)("st",-1)||0===(0,C.hu)("kb",-1)?o.Xd.snapshotPanZoomDuration:o.mS,TourTransitionFactory.getZoomDuration=t=>-1!==(0,C.hu)("st",-1)?o.Xd.snapshotPanZoomDuration:t.tryGetProperty(f.gx.ZoomDuration,o._c),TourTransitionFactory.getPanValues=(t,e,i,r)=>{const s=TourTransitionFactory.getPanDirection(t,i),n=TourTransitionFactory.getPanDegrees(t,r),a=S.MathUtils.degToRad(n),h=TourTransitionFactory.getPanRadiansPerMs(t,e,a);let u=h>0?a/h:0;return e&&void 0===r&&(u=o.Xd.snapshotPanZoomDuration),{degrees:n,radiansPerMs:h,ms:u,direction:s}},TourTransitionFactory.getTransitionSpeed=t=>{if(-1!==(0,C.hu)("wts",-1))return t.tryGetProperty(o.EU,o.Im);const e=t.tryGetProperty(f.gx.TransitionSpeed,o.Mk);return(0,F.mf)(e/1e3)},TourTransitionFactory.getTransitionTime=t=>{const e=t.tryGetProperty(f.gx.TransitionTime,o.mL);return Math.min(Math.max(o.eu,e),o.NY)},TourTransitionFactory.getOtherModeTransitionTime=(t,e,i)=>{if(i===u.n.FadeToBlack){return TourTransitionFactory.getTransitionTime(t)+o.HJ}let r=o.Cp,s=o.f7;if(-1===(0,C.hu)("wts",-1)){const e=1e3*TourTransitionFactory.getTransitionSpeed(t);r=Math.sqrt(2*(e-o.Pv))+45,e!==o.Mk&&(s=o._D)}const n=1e3*e/(S.MathUtils.DEG2RAD*r);return Math.max(n,s)},TourTransitionFactory.getSamePanoTransitionTime=(t,e)=>{const i=t.tryGetProperty(f.gx.PanSpeed,o.pn);if(i===o.pn)return Math.max(1e3*e/(S.MathUtils.DEG2RAD*o.O2),o.gS);{const t=(0,D.dS)(i,o.z$,o.b_,o.rM,o.z8),r=(0,F.DA)(t);return r>0?e/r:0}};var Z=i(28281),W=i(19417),U=i(23549);const _=5;class ToursControlsModule extends s.Y{constructor(){super(...arguments),this.name="tours-controls",this.getBurnsStyleForSnapshot=(t,e,i)=>{const r=t.getTourSnapshotSid(e),o=t.getHighlightDescription(r),s=t.getSnapshotCount();if(!o||!o.snapshot)return M.BZ.None;const a=o.snapshot.metadata.cameraMode,h=e===s-1,u=o.reelEntry&&o.reelEntry.overrides&&o.reelEntry.overrides.panDirection,c=a===n.Ey.Dollhouse?M.BZ.PanDollhouse:a===n.Ey.Floorplan?M.BZ.Zoom:M.BZ.Pan;return TourTransitionFactory.useDelayTransition(this.settingsData,c,i)?M.BZ.Delay:h&&void 0!==u?c:h?M.BZ.None:c},this.canChangeTourLocation=()=>{const t=this.data.getTourState(),e=this.data.isTourTransitionActive(),i=this.cameraData.canTransition();return t===a.Vs.Inactive&&!e&&!(this.viewmodeData.transition&&this.viewmodeData.transition.active)&&i}}async init(t,e){this.engine=e,this.cameraData=await e.market.waitForData(y.M_),this.viewmodeData=await e.market.waitForData(h.O),this.settingsData=await e.market.waitForData(P.e),this.data=await e.market.waitForData(a.k3),e.getModule(c.default).then((t=>{t.registerHandler(p.er,(()=>{this.handleTourInputInterrupt()})),t.registerHandler(d.a,(()=>{this.handleTourInputInterrupt()})),t.registerHandler(m.e,(t=>{t.state===T.M.DOWN&&this.handleTourInputInterrupt()}))})),this.transitionFactory=new TourTransitionFactory(e,this.data,this.cameraData,this.settingsData,this.viewmodeData),await this.transitionFactory.init(),this.setupAutoPlay(e),this.bindings.push(e.commandBinder.addBinding(W.TH,(async t=>this.startTour(t.index,t.steps,t.loop)))),this.bindings.push(e.commandBinder.addBinding(W.vy,(async()=>this.stopTour()))),this.bindings.push(e.commandBinder.addBinding(W.rU,(async t=>this.tourGoTo(t.index,t.instant?u.n.Instant:void 0)))),this.bindings.push(e.commandBinder.addBinding(W.HW,(async t=>t.forward?this.tourGoNext(t.instant):this.tourGoPrevious(t.instant)))),this.bindings.push(e.subscribe(l.Vx,(()=>{this.data.setTourTransitionToIndex(-1)})),e.subscribe(l.NR,(()=>{this.data.setTourTransitionToIndex(-1)})))}handleTourInputInterrupt(){this.data.getTourState()!==a.Vs.Inactive&&this.stopTour()}canTourProceed(t,e,i){const r=this.data.getSnapshotCount();if(0===r||0===i||this.data.getTourState()!==a.Vs.Inactive)return!1;if(void 0!==e){if(e<-1)return!1;if(!0!==t&&e>r-1)return!1}return!0}shouldTourContinue(t,e,i,r){return void 0!==r?i<r:e<t-1}startTour(t,e,i){if(!this.canChangeTourLocation())throw new U.Y("Cannot start tour at this time, another transition is active");const o=void 0!==i?i:this.data.isLooping();if(!this.canTourProceed(o,t,e))return;const s=this.data.getSnapshotCount(),n=this.data.getTourCurrentSnapshotIndex();let h,u=0;h=void 0!==t?t-1:n>=s-1?-1:n;const c=this.settingsData.tryGetProperty(Z.YS,null);this.settingsData.setProperty(Z.YS,null);const p=this;this.tourGenerator=function*(){for(;p.shouldTourContinue(s,h,u,e);){const t=h+1,e=p.composeTourTransition(t);yield new r.M8(e),h=t,h===s-1&&o&&(h=-1),u++}p.stopTour(),p.settingsData.setProperty(Z.YS,c)},this.engine.startGenerator(this.tourGenerator),this.data.setTourState(a.Vs.Active),this.data.tourEnded=!1,this.data.tourPlaying=!0,this.engine.broadcast(new l.oR)}async composeTourTransition(t,e,i){const r=this.data.getTourSnapshotSid(t),o=this.data.getHighlightDescription(r);if(!o.snapshot)throw Error(`Highlight not found for reel index ${t}`);let s=this.settingsData.tryGetProperty(v.gj,u.n.Interpolate);const h=o.snapshot.metadata.cameraMode,c=h===n.Ey.Dollhouse||h===n.Ey.Floorplan,p=!this.viewmodeData.isPano()&&h===n.Ey.Panorama,d=this.viewmodeData.isPano()&&c,m=!this.viewmodeData.isPano()&&c,T=this.viewmodeData.isPano()&&h===n.Ey.Panorama;let g=null;(p||d||m)&&(s=u.n.Interpolate),T&&0===t&&(s=u.n.FadeToBlack),o.reelEntry&&o.reelEntry.overrides&&(void 0!==o.reelEntry.overrides.transitionType&&(s=o.reelEntry.overrides.transitionType),void 0!==o.reelEntry.overrides.panAngle&&(g=o.reelEntry.overrides.panAngle)),void 0!==i&&(s=i),this.data.setTourTransitionToIndex(t),this.engine.broadcast(new l.dW);const w=this.transitionFactory.getFloorTransition(t);if(this.data.useTransition(w),await w.promise,this.data.getTourState()===a.Vs.StopScheduled)return;const P=this.transitionFactory.getMainTransition(t,s);if(this.data.useTransition(P),await P.promise,this.data.setTourCurrentSnapshotByIndex(t),this.engine.broadcast(new l.Vx(t)),this.data.getTourState()===a.Vs.StopScheduled)return;const y=e||this.getBurnsStyleForSnapshot(this.data,t,null!==g?g:void 0),S=this.transitionFactory.getBurnsTransition(t,y);this.data.useTransition(S),await S.promise}async stopTour(){this.data.getTourState()===a.Vs.Active&&(this.data.setTourState(a.Vs.StopScheduled),this.data.tourPlaying=!1,await this.data.stopTourTransition(),this.tourGenerator&&this.engine.stopGenerator(this.tourGenerator),this.engine.broadcast(new l.NR),this.data.getTourCurrentSnapshotIndex()!==this.data.getSnapshotCount()-1||this.data.isLooping()||(this.data.tourEnded=!0,this.engine.broadcast(new l.Mt)),this.data.setTourState(a.Vs.Inactive))}async tourGoNext(t){let e=this.data.getTourCurrentSnapshotIndex()+1;e>=this.data.getSnapshotCount()&&(e=0);const i=t?u.n.Instant:void 0;return this.tourGoTo(e,i)}async tourGoPrevious(t){let e=this.data.getTourCurrentSnapshotIndex();e<0&&(e=0);let i=e-1;i<0&&(i=this.data.getSnapshotCount()-1);const r=t?u.n.Instant:void 0;return this.tourGoTo(i,r)}async tourGoTo(t,e=u.n.FadeToBlack){if(!this.canChangeTourLocation())throw new U.z("Cannot change tour location at this time, another transition is active");if(this.viewmodeData.transition&&this.viewmodeData.transition.active)throw new U.z("Cannot go to tour location during viewmode transition");if(this.data.getTourState()!==a.Vs.Inactive)throw new U.z("Cannot jump to tour location while tour is active");try{this.data.setTourState(a.Vs.Active),await this.composeTourTransition(t,M.BZ.None,e)}catch(t){this.log.error(t)}finally{this.data.setTourState(a.Vs.Inactive)}}setupAutoPlay(t){const e=1e3*o.Xd.autoStartDelay,i=()=>{let t=!0;const i=this.cameraData.pose.onChanged((()=>{t=!1,i.cancel()}));setTimeout((()=>{t&&this.startTour(),i.cancel()}),e)};if(e>=0){const e=t.market.tryGetData(g.pu);if(e&&e.phase===g.nh.PLAYING)i();else{const e=r=>{r.phase===g.nh.PLAYING&&(i(),t.unsubscribe(w.LZ,e))};t.subscribe(w.LZ,e)}}}}}}]);